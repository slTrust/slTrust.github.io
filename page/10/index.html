
 <!DOCTYPE HTML>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
  
    <title>Almost</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Stevin">
    

    
    <meta property="og:type" content="website">
<meta property="og:title" content="Almost">
<meta property="og:url" content="http://yoursite.com/page/10/index.html">
<meta property="og:site_name" content="Almost">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Almost">

    
    <link rel="alternative" href="/atom.xml" title="Almost" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
</head>
</html>
  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="Almost" title="Almost"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Almost">Almost</a></h1>
				<h2 class="blog-motto"></h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="Menu">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="Search" />
						<input type="hidden" name="q" value="site:yoursite.com">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main">

   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2019/09/24/ZB-024-03线程池和Callable和Future/" title="ZB-024-03线程池和Callable和Future" itemprop="url">ZB-024-03线程池和Callable和Future</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Stevin" target="_blank" itemprop="author">Stevin</a>
		
  <p class="article-time">
    <time datetime="2019-09-24T14:27:34.000Z" itemprop="datePublished"> Published 2019-09-24</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="线程池与Callable-Future"><a href="#线程池与Callable-Future" class="headerlink" title="线程池与Callable/Future"></a>线程池与Callable/Future</h1><h3 id="什么是线程池"><a href="#什么是线程池" class="headerlink" title="什么是线程池"></a>什么是线程池</h3><ul>
<li>线程是昂贵的（Java线程模型的缺陷）<ul>
<li>一个线程就是一个工人，每开一个线程意味着 你的JVM里就一个工人开始执行你的代码</li>
<li>生活里公司里人员流动的成本是很高的，你要重新培养它。线程也是一样</li>
<li><strong>java的线程和操作系统的线程相绑定，java的线程调度依赖于操作系统的线程调度，因此很昂贵，随意你不能随心所欲的在操作系统里开线程</strong></li>
</ul>
</li>
<li>线程池是预先定义好的若⼲个线程</li>
<li><p>Java中的线程池</p>
<h3 id="Callable-Future"><a href="#Callable-Future" class="headerlink" title="Callable/Future"></a>Callable/Future</h3></li>
<li><p>类⽐Runnable，Callable可以返回值，抛出异常</p>
</li>
<li>Future代表⼀个“未来才会返回的结果”</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">import java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line">public class WordCount &#123;</span><br><span class="line">    public static void main(String[] args) throws ExecutionException, InterruptedException &#123;</span><br><span class="line">        // 创建固定数量的线程池</span><br><span class="line">        ExecutorService threadPool = Executors.newFixedThreadPool(10);</span><br><span class="line"></span><br><span class="line">        //new Callable&lt;T&gt;()&#123;...&#125; T代表返回值</span><br><span class="line"></span><br><span class="line">        // 返回数字</span><br><span class="line">        Future&lt;Integer&gt; future1 = threadPool.submit(new Callable&lt;Integer&gt;() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public Integer call() throws Exception &#123;</span><br><span class="line">                Thread.sleep(1000);</span><br><span class="line">                return 0;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        // 返回字符串</span><br><span class="line">        Future&lt;String&gt; future2 = threadPool.submit(new Callable&lt;String&gt;() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public String call() throws Exception &#123;</span><br><span class="line">                Thread.sleep(1000);</span><br><span class="line">                return &quot;abc&quot;;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        // 抛出异常</span><br><span class="line">        Future&lt;Object&gt; future3 = threadPool.submit(new Callable&lt;Object&gt;() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public Object call() throws Exception &#123;</span><br><span class="line">                throw new RuntimeException();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        /*</span><br><span class="line">        submit 和  new Thread().start(); 一样会立刻执行，是异步的 不会阻塞当前线程的执行</span><br><span class="line">        submit 的返回值是个 Future</span><br><span class="line">        threadPool.submit( ... );</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Future 代表一个未来</span><br><span class="line">        */</span><br><span class="line"></span><br><span class="line">        // 它会等这个结果回来打印</span><br><span class="line">        System.out.println(future1.get());</span><br><span class="line">        System.out.println(future2.get());</span><br><span class="line">        System.out.println(future3.get());</span><br><span class="line"></span><br><span class="line">        // 你等不及了,取消一个</span><br><span class="line">        // future2.cancel(100);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="实战：多线程的WordCount"><a href="#实战：多线程的WordCount" class="headerlink" title="实战：多线程的WordCount"></a>实战：多线程的WordCount</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">package com.github.hcsp.multithread;</span><br><span class="line"></span><br><span class="line">import java.io.*;</span><br><span class="line">import java.util.ArrayList;</span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.List;</span><br><span class="line">import java.util.Map;</span><br><span class="line">import java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line">public class WordCount &#123;</span><br><span class="line">    private final int threadNum;</span><br><span class="line">    private ExecutorService threadPool;</span><br><span class="line">    public WordCount(int threadNum) &#123;</span><br><span class="line">        threadPool = Executors.newFixedThreadPool(threadNum);</span><br><span class="line">        this.threadNum = threadNum;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 统计文件中各单词的数量</span><br><span class="line">    public Map&lt;String, Integer&gt; count(File file) throws FileNotFoundException, ExecutionException, InterruptedException &#123;</span><br><span class="line">        BufferedReader reader = new BufferedReader(new FileReader(file));</span><br><span class="line"></span><br><span class="line">        List&lt;Future&lt;Map&lt;String,Integer&gt;&gt;&gt; futures = new ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        // 开多个线程，每个线程读取文件的一行内容，并将其中的单词统计结果返回</span><br><span class="line">        // 最后，主线程将 工作线程返回的结果汇总在一起</span><br><span class="line">        for (int i = 0; i &lt; threadNum; i++) &#123;</span><br><span class="line">            futures.add(threadPool.submit(new WorkerJob(reader)));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 合并</span><br><span class="line">        Map&lt;String,Integer&gt; finalResult = new HashMap&lt;&gt;();</span><br><span class="line">        for (Future&lt;Map&lt;String,Integer&gt;&gt; future:futures) &#123;</span><br><span class="line">            Map&lt;String,Integer&gt; resultFromWorker = future.get();</span><br><span class="line">            mergeWorkerResultIntoFinalResult(resultFromWorker,finalResult);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        return finalResult;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void mergeWorkerResultIntoFinalResult(Map&lt;String, Integer&gt; resultFromWorker,</span><br><span class="line">                                                  Map&lt;String, Integer&gt; finalResult) &#123;</span><br><span class="line">        for (Map.Entry&lt;String,Integer&gt; entry: resultFromWorker.entrySet()) &#123;</span><br><span class="line">            String word = entry.getKey();</span><br><span class="line">            int mergedResult = finalResult.getOrDefault(word,0) + entry.getValue();</span><br><span class="line">            finalResult.put(word,mergedResult);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    static class WorkerJob implements Callable&lt;Map&lt;String ,Integer&gt;&gt; &#123;</span><br><span class="line">        private BufferedReader reader;</span><br><span class="line"></span><br><span class="line">        public WorkerJob(BufferedReader reader) &#123;</span><br><span class="line">            this.reader = reader;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public Map&lt;String, Integer&gt; call() throws Exception &#123;</span><br><span class="line">            String line = null;</span><br><span class="line">            Map&lt;String,Integer&gt; result = new HashMap&lt;&gt;();</span><br><span class="line">            while ((line=reader.readLine())!= null)&#123;</span><br><span class="line">                String[] words = line.split(&quot; &quot;);</span><br><span class="line">                for (String word: words) &#123;</span><br><span class="line">                    result.put(word,result.getOrDefault(word,0) + 1);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            return result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/oak/">oak</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2019/09/24/ZB-024-02生产者消费者模型/" title="ZB-024-02生产者消费者模型" itemprop="url">ZB-024-02生产者消费者模型</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Stevin" target="_blank" itemprop="author">Stevin</a>
		
  <p class="article-time">
    <time datetime="2019-09-24T13:26:46.000Z" itemprop="datePublished"> Published 2019-09-24</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h3 id="生产者消费者模型"><a href="#生产者消费者模型" class="headerlink" title="生产者消费者模型"></a><a href="https://github.com/hcsp/producer-consumer" target="_blank" rel="noopener">生产者消费者模型</a></h3><ul>
<li>生产者和消费者之间有一个盘子</li>
<li>盘子只能有一个包子</li>
<li>生产者创造了一个包子 放置到盘子上。此时不会继续生产，而是等消费者把盘子上的包子吃了，再去生产 即盘子是空的菜生产</li>
<li>消费者吃掉一个包子后，就不会在吃了，而是等待生产者 生产 即盘子上有包子才消费</li>
</ul>
<p><a href="https://github.com/hcsp/producer-consumer/pull/22" target="_blank" rel="noopener">1.Object.wait/notify解决</a></p>
<p><a href="https://github.com/hcsp/producer-consumer/pull/23" target="_blank" rel="noopener">2.Lock/Condition解决</a></p>
<p><a href="https://github.com/hcsp/producer-consumer/pull/24" target="_blank" rel="noopener">3.BlockingQueue解决</a></p>
<h4 id="方式一：Object-wait-notify"><a href="#方式一：Object-wait-notify" class="headerlink" title="方式一：Object.wait/notify"></a>方式一：Object.wait/notify</h4><p>Boss.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">package com.github.hcsp.multithread;</span><br><span class="line"></span><br><span class="line">public class Boss &#123;</span><br><span class="line">    public static void main(String[] args) throws InterruptedException &#123;</span><br><span class="line">        // 请实现一个生产者/消费者模型，其中：</span><br><span class="line">        // 生产者生产10个随机的整数供消费者使用（随机数可以通过new Random().nextInt()获得）</span><br><span class="line">        // 使得标准输出依次输出它们，例如：</span><br><span class="line">        // Producing 42</span><br><span class="line">        // Consuming 42</span><br><span class="line">        // Producing -1</span><br><span class="line">        // Consuming -1</span><br><span class="line">        // ...</span><br><span class="line">        // Producing 10086</span><br><span class="line">        // Consuming 10086</span><br><span class="line">        // Producing -12345678</span><br><span class="line">        // Consuming -12345678</span><br><span class="line"></span><br><span class="line">        Container container = new Container();</span><br><span class="line">        Object lock = new Object();</span><br><span class="line"></span><br><span class="line">        Producer producer = new Producer(container, lock);</span><br><span class="line">        Consumer consumer = new Consumer(container, lock);</span><br><span class="line"></span><br><span class="line">        producer.start();</span><br><span class="line">        consumer.start();</span><br><span class="line"></span><br><span class="line">        producer.join();</span><br><span class="line">        producer.join();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Container.java  放置包子的盘子</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">package com.github.hcsp.multithread;</span><br><span class="line"></span><br><span class="line">import java.util.Optional;</span><br><span class="line"></span><br><span class="line">public class Container &#123;</span><br><span class="line">    private Optional&lt;Integer&gt; value = Optional.empty();</span><br><span class="line"></span><br><span class="line">    public Optional&lt;Integer&gt; getValue() &#123;</span><br><span class="line">        return value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setValue(Optional&lt;Integer&gt; value) &#123;</span><br><span class="line">        this.value = value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Consumer.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">package com.github.hcsp.multithread;</span><br><span class="line"></span><br><span class="line">import java.util.Optional;</span><br><span class="line"></span><br><span class="line">public class Consumer extends Thread &#123;</span><br><span class="line">    Container container;</span><br><span class="line">    Object lock;</span><br><span class="line"></span><br><span class="line">    public Consumer(Container container, Object lock) &#123;</span><br><span class="line">        this.container = container;</span><br><span class="line">        this.lock = lock;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void run() &#123;</span><br><span class="line">        for (int i = 0; i &lt; 10; i++) &#123;</span><br><span class="line">            synchronized (lock) &#123;</span><br><span class="line">                // 只要盘子是空的 它就等待</span><br><span class="line">                while (!container.getValue().isPresent()) &#123;</span><br><span class="line">                    try &#123;</span><br><span class="line">                        lock.wait();</span><br><span class="line">                    &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                // 盘子不是空的就消费</span><br><span class="line">                Integer value = container.getValue().get();</span><br><span class="line">                // 清空盘子的内容</span><br><span class="line">                container.setValue(Optional.empty());</span><br><span class="line">                System.out.println(&quot;Consuming &quot; + value);</span><br><span class="line"></span><br><span class="line">                // 唤醒生产者</span><br><span class="line">                lock.notify();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Producer.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">package com.github.hcsp.multithread;</span><br><span class="line"></span><br><span class="line">import java.util.Optional;</span><br><span class="line">import java.util.Random;</span><br><span class="line"></span><br><span class="line">public class Producer extends Thread &#123;</span><br><span class="line">    Container container;</span><br><span class="line">    Object lock;</span><br><span class="line"></span><br><span class="line">    public Producer(Container container, Object lock) &#123;</span><br><span class="line">        this.container = container;</span><br><span class="line">        this.lock = lock;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void run() &#123;</span><br><span class="line">        for (int i = 0; i &lt; 10; i++) &#123;</span><br><span class="line">            synchronized (lock) &#123;</span><br><span class="line">                // 只要盘子里有东西 它就必须等待</span><br><span class="line">                while (container.getValue().isPresent()) &#123;</span><br><span class="line">                    try &#123;</span><br><span class="line">                        lock.wait();</span><br><span class="line">                    &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                // 盘子是空的就生产</span><br><span class="line">                int r = new Random().nextInt();</span><br><span class="line">                System.out.println(&quot;Producing &quot; + r);</span><br><span class="line">                container.setValue(Optional.of(r));</span><br><span class="line">                // 唤醒消费者</span><br><span class="line">                lock.notify();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="方式二：Lock-Condition"><a href="#方式二：Lock-Condition" class="headerlink" title="方式二：Lock/Condition"></a>方式二：Lock/Condition</h4><p>Boss.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">package com.github.hcsp.multithread;</span><br><span class="line"></span><br><span class="line">import java.util.concurrent.locks.ReentrantLock;</span><br><span class="line"></span><br><span class="line">public class Boss &#123;</span><br><span class="line">    public static void main(String[] args) throws InterruptedException &#123;</span><br><span class="line">        // 请实现一个生产者/消费者模型，其中：</span><br><span class="line">        // 生产者生产10个随机的整数供消费者使用（随机数可以通过new Random().nextInt()获得）</span><br><span class="line">        // 使得标准输出依次输出它们，例如：</span><br><span class="line">        // Producing 42</span><br><span class="line">        // Consuming 42</span><br><span class="line">        // Producing -1</span><br><span class="line">        // Consuming -1</span><br><span class="line">        // ...</span><br><span class="line">        // Producing 10086</span><br><span class="line">        // Consuming 10086</span><br><span class="line">        // Producing -12345678</span><br><span class="line">        // Consuming -12345678</span><br><span class="line"></span><br><span class="line">        ReentrantLock lock = new ReentrantLock();</span><br><span class="line">        Container container = new Container(lock);</span><br><span class="line"></span><br><span class="line">        Producer producer = new Producer(container, lock);</span><br><span class="line">        Consumer consumer = new Consumer(container, lock);</span><br><span class="line"></span><br><span class="line">        producer.start();</span><br><span class="line">        consumer.start();</span><br><span class="line"></span><br><span class="line">        producer.join();</span><br><span class="line">        producer.join();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Container.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">package com.github.hcsp.multithread;</span><br><span class="line"></span><br><span class="line">import java.util.Optional;</span><br><span class="line">import java.util.concurrent.locks.Condition;</span><br><span class="line">import java.util.concurrent.locks.ReentrantLock;</span><br><span class="line"></span><br><span class="line">public class Container &#123;</span><br><span class="line"></span><br><span class="line">    private Condition notConsumedYet; // 还没被消费掉</span><br><span class="line">    private Condition notProducedYet; // 还没被生产出来</span><br><span class="line">    private Optional&lt;Integer&gt; value = Optional.empty();</span><br><span class="line"></span><br><span class="line">    public Container(ReentrantLock lock) &#123;</span><br><span class="line">        this.notConsumedYet = lock.newCondition();</span><br><span class="line">        this.notProducedYet = lock.newCondition();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Condition getNotConsumedYet() &#123;</span><br><span class="line">        return notConsumedYet;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Condition getNotProducedYet() &#123;</span><br><span class="line">        return notProducedYet;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Optional&lt;Integer&gt; getValue() &#123;</span><br><span class="line">        return value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setValue(Optional&lt;Integer&gt; value) &#123;</span><br><span class="line">        this.value = value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Consumer.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">package com.github.hcsp.multithread;</span><br><span class="line"></span><br><span class="line">import java.util.Optional;</span><br><span class="line">import java.util.concurrent.locks.ReentrantLock;</span><br><span class="line"></span><br><span class="line">public class Consumer extends Thread &#123;</span><br><span class="line">    Container container;</span><br><span class="line">    ReentrantLock lock;</span><br><span class="line"></span><br><span class="line">    public Consumer(Container container, ReentrantLock lock) &#123;</span><br><span class="line">        this.container = container;</span><br><span class="line">        this.lock = lock;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void run() &#123;</span><br><span class="line">        for (int i = 0; i &lt; 10; i++) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                lock.lock();</span><br><span class="line">                // 只要盘子是空的 它就等待</span><br><span class="line">                while (!container.getValue().isPresent()) &#123;</span><br><span class="line">                    try &#123;</span><br><span class="line">                        container.getNotProducedYet().await();</span><br><span class="line">                    &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                // 盘子不是空的就消费</span><br><span class="line">                Integer value = container.getValue().get();</span><br><span class="line">                // 清空盘子的内容</span><br><span class="line">                container.setValue(Optional.empty());</span><br><span class="line">                System.out.println(&quot;Consuming &quot; + value);</span><br><span class="line"></span><br><span class="line">                // 唤醒生产者</span><br><span class="line">                container.getNotConsumedYet().signal();</span><br><span class="line">            &#125; finally &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Producer.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">package com.github.hcsp.multithread;</span><br><span class="line"></span><br><span class="line">import java.util.Optional;</span><br><span class="line">import java.util.Random;</span><br><span class="line">import java.util.concurrent.locks.ReentrantLock;</span><br><span class="line"></span><br><span class="line">public class Producer extends Thread &#123;</span><br><span class="line">    Container container;</span><br><span class="line">    ReentrantLock lock;</span><br><span class="line"></span><br><span class="line">    public Producer(Container container, ReentrantLock lock) &#123;</span><br><span class="line">        this.container = container;</span><br><span class="line">        this.lock = lock;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void run() &#123;</span><br><span class="line">        for (int i = 0; i &lt; 10; i++) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                lock.lock();</span><br><span class="line">                // 只要盘子里有东西 它就必须等待</span><br><span class="line">                while (container.getValue().isPresent()) &#123;</span><br><span class="line">                    try &#123;</span><br><span class="line">                        container.getNotConsumedYet().await();</span><br><span class="line">                    &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                // 盘子是空的就生产</span><br><span class="line">                int r = new Random().nextInt();</span><br><span class="line">                System.out.println(&quot;Producing &quot; + r);</span><br><span class="line">                container.setValue(Optional.of(r));</span><br><span class="line">                // 唤醒消费者</span><br><span class="line">                container.getNotProducedYet().signal();</span><br><span class="line">            &#125; finally &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="方式三：BlockingQueue"><a href="#方式三：BlockingQueue" class="headerlink" title="方式三：BlockingQueue"></a>方式三：BlockingQueue</h4><blockquote>
<p>signalQueue 是控制线程调度的 实际就是个开关</p>
</blockquote>
<p>Boss.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">package com.github.hcsp.multithread;</span><br><span class="line"></span><br><span class="line">import java.util.concurrent.BlockingDeque;</span><br><span class="line">import java.util.concurrent.LinkedBlockingDeque;</span><br><span class="line"></span><br><span class="line">public class Boss &#123;</span><br><span class="line">    public static void main(String[] args) throws InterruptedException &#123;</span><br><span class="line">        // 请实现一个生产者/消费者模型，其中：</span><br><span class="line">        // 生产者生产10个随机的整数供消费者使用（随机数可以通过new Random().nextInt()获得）</span><br><span class="line">        // 使得标准输出依次输出它们，例如：</span><br><span class="line">        // Producing 42</span><br><span class="line">        // Consuming 42</span><br><span class="line">        // Producing -1</span><br><span class="line">        // Consuming -1</span><br><span class="line">        // ...</span><br><span class="line">        // Producing 10086</span><br><span class="line">        // Consuming 10086</span><br><span class="line">        // Producing -12345678</span><br><span class="line">        // Consuming -12345678</span><br><span class="line"></span><br><span class="line">        BlockingDeque&lt;Integer&gt; queue = new LinkedBlockingDeque&lt;&gt;(1);</span><br><span class="line">        // 控制线程的调度</span><br><span class="line">        BlockingDeque&lt;Integer&gt; signalQueue = new LinkedBlockingDeque&lt;&gt;(1);</span><br><span class="line"></span><br><span class="line">        Producer producer = new Producer(queue, signalQueue);</span><br><span class="line">        Consumer consumer = new Consumer(queue, signalQueue);</span><br><span class="line"></span><br><span class="line">        producer.start();</span><br><span class="line">        consumer.start();</span><br><span class="line"></span><br><span class="line">        producer.join();</span><br><span class="line">        producer.join();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Consumer.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">package com.github.hcsp.multithread;</span><br><span class="line"></span><br><span class="line">import java.util.concurrent.BlockingDeque;</span><br><span class="line"></span><br><span class="line">public class Consumer extends Thread &#123;</span><br><span class="line">    BlockingDeque&lt;Integer&gt; queue;</span><br><span class="line">    BlockingDeque&lt;Integer&gt; signalQueue;</span><br><span class="line"></span><br><span class="line">    public Consumer(BlockingDeque&lt;Integer&gt; queue, BlockingDeque&lt;Integer&gt; signalQueue) &#123;</span><br><span class="line">        this.queue = queue;</span><br><span class="line">        this.signalQueue = signalQueue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void run() &#123;</span><br><span class="line">        for (int i = 0; i &lt; 10; i++) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                System.out.println(&quot;Consuming &quot; + queue.take());</span><br><span class="line">                signalQueue.put(0);</span><br><span class="line">            &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Producer.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">package com.github.hcsp.multithread;</span><br><span class="line"></span><br><span class="line">import java.util.Random;</span><br><span class="line">import java.util.concurrent.BlockingDeque;</span><br><span class="line"></span><br><span class="line">public class Producer extends Thread &#123;</span><br><span class="line">    BlockingDeque&lt;Integer&gt; queue;</span><br><span class="line">    BlockingDeque&lt;Integer&gt; signalQueue;</span><br><span class="line"></span><br><span class="line">    public Producer(BlockingDeque&lt;Integer&gt; queue, BlockingDeque&lt;Integer&gt; signalQueue) &#123;</span><br><span class="line">        this.queue = queue;</span><br><span class="line">        this.signalQueue = signalQueue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void run() &#123;</span><br><span class="line">        for (int i = 0; i &lt; 10; i++) &#123;</span><br><span class="line">            int r = new Random().nextInt();</span><br><span class="line">            System.out.println(&quot;Producing &quot; + r);</span><br><span class="line">            try &#123;</span><br><span class="line">                queue.put(r);</span><br><span class="line">                signalQueue.take();</span><br><span class="line">            &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/oak/">oak</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2019/09/17/ZB-024-01多线程初步/" title="ZB-024-01多线程初步" itemprop="url">ZB-024-01多线程初步</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Stevin" target="_blank" itemprop="author">Stevin</a>
		
  <p class="article-time">
    <time datetime="2019-09-17T12:21:25.000Z" itemprop="datePublished"> Published 2019-09-17</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h3 id="线程不安全的表现"><a href="#线程不安全的表现" class="headerlink" title="线程不安全的表现"></a>线程不安全的表现</h3><ul>
<li>数据错误</li>
<li>死锁</li>
<li>著名的HashMap的死循环问题</li>
<li>写⼀段代码来重现死锁</li>
<li>预防死锁产⽣的原则：<ul>
<li>所有的线程都按照相同的顺序获得资源的锁</li>
</ul>
</li>
<li>死锁问题的排查</li>
<li>多线程的经典问题：哲学家⽤餐</li>
</ul>
<h4 id="数据错误"><a href="#数据错误" class="headerlink" title="数据错误"></a>数据错误</h4><ul>
<li><p>i++</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">package com.io.demo;</span><br><span class="line"></span><br><span class="line">public class Main &#123;</span><br><span class="line">    public static long i =0;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        for (int j = 0; j &lt; 1000; j++) &#123;</span><br><span class="line"></span><br><span class="line">            new Thread(()-&gt; &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    Thread.sleep(1);</span><br><span class="line">                &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(++i);</span><br><span class="line">            &#125;).start();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 执行后不是 1000</span><br></pre></td></tr></table></figure>
</li>
<li><p>if-then-do</p>
<ul>
<li>HashMap 线程不安全容器</li>
<li><a href="https://coolshell.cn/articles/9606.html" target="_blank" rel="noopener">HashMap 死循环</a><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">package com.io.demo;</span><br><span class="line"></span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.Map;</span><br><span class="line">import java.util.Random;</span><br><span class="line"></span><br><span class="line">public class Main &#123;</span><br><span class="line">    public static Map&lt;Integer,Integer&gt; map = new HashMap&lt;&gt;();</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        for (int j = 0; j &lt; 1000; j++) &#123;</span><br><span class="line">            new Thread(Main::putIfAbsent).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 随机丢入 HashMap 一个1～10数字 如果它不存在就丢进去</span><br><span class="line">    private static void putIfAbsent()&#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Thread.sleep(1);</span><br><span class="line">        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        int r = new Random().nextInt(10);</span><br><span class="line">        if(!map.containsKey(r))&#123;</span><br><span class="line">            map.put(r,r);</span><br><span class="line">            System.out.println(&quot;put:&quot; + r);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">// 执行后会发生 一个数被 put 多次</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line">这里有一个共享的 map</span><br><span class="line">在某一时刻 </span><br><span class="line">    线程1 随机了一个数字 0 ，同时它的执行时间到了</span><br><span class="line">与此同时：一另一个 线程2 开始执行了， 它也生成了一个0 并成功把它 put 进入 map里</span><br><span class="line">此时 线程1 恢复执行 获得资源调度继续执行 于是。。。 出现了 put 2次 0 的情况</span><br><span class="line">*/</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>为什么要多线程</p>
</blockquote>
<ul>
<li>为了让程序跑的更快，但是你的程序跑的更快，如果结果不对跑的再快也没用。</li>
<li>这就是线程不安全 <strong>最要命的问题</strong> 它会产生<strong>错误的数据</strong></li>
</ul>
<h4 id="死锁"><a href="#死锁" class="headerlink" title="死锁"></a>死锁</h4><ul>
<li>java里任何一个对象都可以当作 <strong>锁</strong></li>
<li><code>synchronized</code> 关键字：就是同一时刻只能有一个线程拿着一把<strong>锁</strong></li>
</ul>
<blockquote>
<p>死锁实例</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">package com.io.demo;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">public class Main &#123;</span><br><span class="line">    private static final Object lock1 = new Object();</span><br><span class="line">    private static final Object lock2 = new Object();</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        new Thead1().start();</span><br><span class="line">        new Thead2().start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    static class Thead1 extends Thread&#123;</span><br><span class="line">        @Override</span><br><span class="line">        public void run() &#123;</span><br><span class="line">            synchronized (lock1)&#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    Thread.sleep(500);</span><br><span class="line">                &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                synchronized (lock2)&#123;</span><br><span class="line">                    System.out.println(&quot;thread1&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    static class Thead2 extends Thread&#123;</span><br><span class="line">        @Override</span><br><span class="line">        public void run() &#123;</span><br><span class="line">            synchronized (lock2)&#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    Thread.sleep(100);</span><br><span class="line">                &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                synchronized (lock1)&#123;</span><br><span class="line">                    System.out.println(&quot;thread2&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/slTrust/note/master/java/zb_029_01.png" alt></p>
<h4 id="死锁问题的排查"><a href="#死锁问题的排查" class="headerlink" title="死锁问题的排查"></a>死锁问题的排查</h4><blockquote>
<p>如何排查线程死锁问题呢？</p>
</blockquote>
<p><strong>第一步：jps 找到程序的进程编号</strong></p>
<ul>
<li>所有的 java 都跑在 jvm 里,而操作系统看来 一个jvm 就是一个普通进程</li>
<li>首先要找到进程<ul>
<li>windows 上 任务管理器</li>
<li>类 linux 系统使用 <code>ps aux | grep java</code> 可以列出所有 java 进程</li>
<li><strong>jps</strong> ：java自带的命令，只要配置了 java_home 那个目录里有这个命令 <strong>显示所有java的进程</strong></li>
</ul>
</li>
</ul>
<p><strong>第二步：<code>jstack 进程号</code></strong></p>
<ul>
<li>打印所有 该 java进程中的 栈信息</li>
</ul>
<h3 id="线程安全"><a href="#线程安全" class="headerlink" title="线程安全"></a>线程安全</h3><ul>
<li><p>实现线程安全的基本⼿段</p>
<ul>
<li>不可变类</li>
<li><p>Integer/String/….</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// 字符串 &quot;a&quot; 地址为 201</span><br><span class="line">String s = &quot;a&quot;;</span><br><span class="line">s = &quot;b&quot;; </span><br><span class="line">// 201地址的字符串没变 实际变的是 引用</span><br><span class="line">// 字符串 &quot;b&quot;  的地址是 301</span><br></pre></td></tr></table></figure>
</li>
<li><p>synchronized同步块</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">// 解决 多线程 共享数据问题</span><br><span class="line">package com.io.demo;</span><br><span class="line"></span><br><span class="line">public class Main2 &#123;</span><br><span class="line">    private static int i = 0;</span><br><span class="line">    private static final Object lock = new Object();</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        for (int j = 0; j &lt; 1000; j++) &#123;</span><br><span class="line">            new Thread(Main2::modifySharedVariable).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void modifySharedVariable()&#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Thread.sleep(1);</span><br><span class="line">        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        synchronized (lock)&#123;</span><br><span class="line">            i+=1;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>另一种方式,<strong>明显感觉比之前慢了</strong> 因为此时的锁是 这个 <code>class</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">package com.io.demo;</span><br><span class="line"></span><br><span class="line">public class Main2 &#123;</span><br><span class="line">    private static int i = 0;</span><br><span class="line">    private static final Object lock = new Object();</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        for (int j = 0; j &lt; 1000; j++) &#123;</span><br><span class="line">            new Thread(Main2::modifySharedVariable).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public synchronized static void modifySharedVariable()&#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Thread.sleep(1);</span><br><span class="line">        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        i+=1;</span><br><span class="line">        System.out.println(i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>移除 <code>static</code> 关键字 后 谁是锁？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">package com.io.demo;</span><br><span class="line"></span><br><span class="line">public class Main2 &#123;</span><br><span class="line">    private static int i = 0;</span><br><span class="line">    private static final Object lock = new Object();</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        Main2 main2 = new Main2();</span><br><span class="line">        for (int j = 0; j &lt; 1000; j++) &#123;</span><br><span class="line">            new Thread(main2::modifySharedVariable).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public synchronized void modifySharedVariable()&#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Thread.sleep(1);</span><br><span class="line">        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        i+=1;</span><br><span class="line">        System.out.println(i);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 等价于</span><br><span class="line">    public void modifySharedVariable2()&#123;</span><br><span class="line">        synchronized(this)&#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                Thread.sleep(1);</span><br><span class="line">            &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            i+=1;</span><br><span class="line">            System.out.println(i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>同步块同步了什么东⻄？</p>
<ul>
<li><code>synchronized(⼀个对象)</code> 把这个对象当成锁</li>
<li><code>static synchronized ⽅法</code> 把Class对象当成锁</li>
<li>实例的synchronnized⽅法把该实例当成锁</li>
</ul>
</li>
<li>Collections.synchronized</li>
</ul>
</li>
</ul>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/oak/">oak</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2019/09/11/ZB-023-01多线程原理/" title="ZB-023-01多线程原理" itemprop="url">ZB-023-01多线程原理</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Stevin" target="_blank" itemprop="author">Stevin</a>
		
  <p class="article-time">
    <time datetime="2019-09-11T13:39:17.000Z" itemprop="datePublished"> Published 2019-09-11</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h3 id="多线程"><a href="#多线程" class="headerlink" title="多线程"></a>多线程</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">package com.io.demo;</span><br><span class="line"></span><br><span class="line">public class Main &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws InterruptedException &#123;</span><br><span class="line">        a();</span><br><span class="line">        System.out.println(1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static  void a() throws InterruptedException &#123;</span><br><span class="line">        Thread.sleep(10000);</span><br><span class="line">        b();</span><br><span class="line">    &#125;</span><br><span class="line">    public static  void b() throws InterruptedException &#123;</span><br><span class="line">        Thread.sleep(1000);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>11秒后打印1</p>
<blockquote>
<p>执行流程</p>
</blockquote>
<ul>
<li>main调用的时候等待 a方法执行结束</li>
<li>a执行过程中先<code>Thread.sleep(10000)</code> 睡了10秒</li>
<li>然后 a 方法要等待 b方法</li>
<li>b方法中有 <code>Thread.sleep(1000)</code> 睡了1秒</li>
<li>b方法执行结束，==&gt; a 方法结束 ==&gt; main 中 打印 1 ==&gt; main 方法结束</li>
</ul>
<p><strong>java执行模型是同步/阻塞的</strong></p>
<h3 id="为什么需要多线程"><a href="#为什么需要多线程" class="headerlink" title="为什么需要多线程"></a>为什么需要多线程</h3><ul>
<li><p>CPU：你们都慢！死！了！</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CPU 3GHz  --&gt; 0.3ns 做一个事</span><br><span class="line">内存 中  --&gt; 10ms a += 1 的操作远远大于 CPU的执行运算的时间</span><br><span class="line">更何况</span><br><span class="line">    硬盘里 读写文件 一来一回呢？</span><br><span class="line"></span><br><span class="line">这就导致 CPU是那么的快 ，但是 内存 硬盘 是那么的慢</span><br><span class="line">这是不能接受的，所以 CPU很想在等待 其他小伙伴返回的时候做些其他的事</span><br></pre></td></tr></table></figure>
</li>
<li><p>现代CPU都是多核的</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">CPU 的单位是 GHz</span><br><span class="line"></span><br><span class="line">1GHz == 1G时钟周期/s  ==&gt; 1ns</span><br><span class="line"></span><br><span class="line">随着技术的进步 1.4 &gt; 2.2 &gt; 2.7 &gt; 3.4  </span><br><span class="line">时钟周期变短了 ：意味着CPU做的事更多了</span><br><span class="line"></span><br><span class="line">为什么现在的 CPU 少有突破3GHz / 10GHz / 100GHz 呢？</span><br><span class="line"></span><br><span class="line">焦耳定律： (I平方)Rt = 发热量</span><br><span class="line">任何东西，它的 发热量和电流的平方成正比的</span><br><span class="line">后果就是： 频率越快 发热量越快。 所以发热量严重的制约了 CPU 频率的上升</span><br><span class="line"></span><br><span class="line">那怎么办？</span><br><span class="line"></span><br><span class="line">堆核心</span><br><span class="line">1个厨师一个时间能做一道菜</span><br><span class="line">雇佣4个厨师就可以做四个菜</span><br></pre></td></tr></table></figure>
</li>
<li><p>Java的执⾏模型是同步/阻塞(block)的</p>
</li>
<li>默认情况下只有⼀个线程<ul>
<li>处理问题⾮常⾃然</li>
<li>但是具有严重的性能问题</li>
</ul>
</li>
</ul>
<h3 id="耗时的案例"><a href="#耗时的案例" class="headerlink" title="耗时的案例"></a>耗时的案例</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">package com.io.demo;</span><br><span class="line"></span><br><span class="line">import java.io.File;</span><br><span class="line">import java.io.FileOutputStream;</span><br><span class="line">import java.io.IOException;</span><br><span class="line"></span><br><span class="line">public class Main &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws InterruptedException &#123;</span><br><span class="line">        long t0 = System.currentTimeMillis();</span><br><span class="line">        writeFile();</span><br><span class="line">        writeFile();</span><br><span class="line">        writeFile();</span><br><span class="line">        writeFile();</span><br><span class="line">        long t1 = System.currentTimeMillis();</span><br><span class="line">        System.out.println(&quot;耗时:&quot;+ (t1- t0) + &quot;ms&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static  void writeFile()  &#123;</span><br><span class="line">        System.out.println(&quot;我开始写入了～&quot;);</span><br><span class="line">        try &#123;</span><br><span class="line">            File tmp = File.createTempFile(&quot;tmp&quot;,&quot;&quot;);</span><br><span class="line">            for (int i = 0; i &lt; 10000; i++) &#123;</span><br><span class="line">                try(FileOutputStream fileOutputStream = new FileOutputStream(tmp))&#123;</span><br><span class="line">                    fileOutputStream.write(i);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line">执行四次耗时</span><br><span class="line">我开始写入了～</span><br><span class="line">我开始写入了～</span><br><span class="line">我开始写入了～</span><br><span class="line">我开始写入了～</span><br><span class="line">耗时:6743ms</span><br><span class="line">*/</span><br></pre></td></tr></table></figure>
<blockquote>
<p>多线程的方式改写</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// </span><br><span class="line">new Thread(new Runnable() &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void run() &#123;</span><br><span class="line">        writeFile();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<ul>
<li>注意！IDEA里任何出现叹号的地方你都可以<code>alt + enter</code></li>
<li>注意！IDEA里任何出现叹号的地方你都可以<code>alt + enter</code></li>
<li>注意！IDEA里任何出现叹号的地方你都可以<code>alt + enter</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// 第一次优化</span><br><span class="line">new Thread(() -&gt; writeFile());</span><br><span class="line">// 第二次优化</span><br><span class="line">new Thread(Main::writeFile);</span><br><span class="line">// 简单吧！</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意线程必须 start才会开启</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">new Thread(Main::writeFile).start();</span><br></pre></td></tr></table></figure>
<blockquote>
<p>再来看执行时间</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">public class Main &#123;</span><br><span class="line">    public static void main(String[] args) throws InterruptedException &#123;</span><br><span class="line">        long t0 = System.currentTimeMillis();</span><br><span class="line">        writeFile();</span><br><span class="line">        new Thread(Main::writeFile).start();</span><br><span class="line">        new Thread(Main::writeFile).start();</span><br><span class="line">        new Thread(Main::writeFile).start();</span><br><span class="line"></span><br><span class="line">        long t1 = System.currentTimeMillis();</span><br><span class="line">        System.out.println(&quot;耗时:&quot;+ (t1- t0) + &quot;ms&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static  void writeFile()  &#123;...&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line">我开始写入了～</span><br><span class="line">我开始写入了～</span><br><span class="line">我开始写入了～</span><br><span class="line">我开始写入了～</span><br><span class="line">耗时:2857ms</span><br><span class="line">*/</span><br></pre></td></tr></table></figure>
<blockquote>
<h4 id="start-和-run-区别"><a href="#start-和-run-区别" class="headerlink" title="start 和 run 区别"></a>start 和 run 区别</h4></blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">new Thread(Main::writeFile).start();</span><br><span class="line">new Thread(Main::writeFile).start();</span><br><span class="line">new Thread(Main::writeFile).start();</span><br><span class="line"></span><br><span class="line">开启三个线程去运行，主线程不等它们</span><br><span class="line">// 并行</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">new Thread(Main::writeFile).run();</span><br><span class="line">new Thread(Main::writeFile).run();</span><br><span class="line">new Thread(Main::writeFile).run();</span><br><span class="line">// 串行</span><br><span class="line">第一个执行结束 开始执行第二个 然后第二个执行结束执行第三个</span><br></pre></td></tr></table></figure>
<h4 id="开启⼀个新的线程"><a href="#开启⼀个新的线程" class="headerlink" title="开启⼀个新的线程"></a>开启⼀个新的线程</h4><ul>
<li>Thread</li>
<li>Java中只有这么⼀种东⻄代表线程</li>
<li>start⽅法才能并发执⾏！</li>
<li>每多开⼀个线程，就多⼀个执⾏流</li>
<li>⽅法栈(局部变量)是线程私有的</li>
<li>静态变量/类变量是被所有线程共享的<ul>
<li>所有多线程导致问题的根源</li>
</ul>
</li>
</ul>
<h4 id="线程难的问题根源——它所共享的变量"><a href="#线程难的问题根源——它所共享的变量" class="headerlink" title="线程难的问题根源——它所共享的变量"></a>线程难的问题根源——它所共享的变量</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">package com.io.demo;</span><br><span class="line"></span><br><span class="line">public class Main &#123;</span><br><span class="line">    public static long i =0;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        long t0 = System.currentTimeMillis();</span><br><span class="line">        for (int j = 0; j &lt; 1000; j++) &#123;</span><br><span class="line">            new Thread(Main::add).start();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        long t1 = System.currentTimeMillis();</span><br><span class="line">        System.out.println(&quot;耗时:&quot;+ (t1- t0) + &quot;ms&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static  void add()  &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Thread.sleep(1000);</span><br><span class="line">        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        i += 1;</span><br><span class="line">        System.out.println(i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">。</span><br><span class="line">。</span><br><span class="line">。</span><br><span class="line">980</span><br><span class="line">979</span><br><span class="line">977</span><br><span class="line">976</span><br><span class="line">973</span><br><span class="line">972</span><br><span class="line">971</span><br><span class="line">983</span><br><span class="line">987</span><br><span class="line">990</span><br><span class="line">993</span><br><span class="line">995</span><br><span class="line">985</span><br><span class="line">986</span><br><span class="line">984</span><br><span class="line">983</span><br><span class="line">984</span><br><span class="line">994</span><br><span class="line">992</span><br><span class="line">991</span><br><span class="line">989</span><br><span class="line">988</span><br><span class="line">*/</span><br></pre></td></tr></table></figure>
<p><strong>线程难的本质原因是<br>你要看着同⼀份代码，<br>想象不同的⼈在疯狂地以乱序执⾏它</strong></p>
<p>首先 <code>i++</code> 不是原子操作</p>
<p>实际过程如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">i++</span><br><span class="line">取 i 的值</span><br><span class="line">把 i 的值 加 1 </span><br><span class="line">把修改后的值 写回 i</span><br></pre></td></tr></table></figure>
<h4 id="多线程适合什么场合"><a href="#多线程适合什么场合" class="headerlink" title="多线程适合什么场合"></a>多线程适合什么场合</h4><ul>
<li>对于IO密集型应⽤极其有⽤<ul>
<li>⽹络IO（通常包括数据库）</li>
<li>⽂件IO</li>
</ul>
</li>
<li>对于CPU密集型应⽤稍有折扣</li>
<li>性能提升的上限在哪⾥？<ul>
<li>单核CPU 100%</li>
<li>多核CPU N*100%<br>如你的电脑开的程序太多，你非常直观的感觉就是卡</li>
</ul>
</li>
</ul>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/oak/">oak</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2019/09/04/ZB-022-02-异常的类型体系/" title="ZB-022-02-异常的类型体系" itemprop="url">ZB-022-02-异常的类型体系</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Stevin" target="_blank" itemprop="author">Stevin</a>
		
  <p class="article-time">
    <time datetime="2019-09-04T15:51:20.000Z" itemprop="datePublished"> Published 2019-09-04</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h3 id="throw-throws"><a href="#throw-throws" class="headerlink" title="throw/throws"></a>throw/throws</h3><blockquote>
<h4 id="throw-丢出异常"><a href="#throw-丢出异常" class="headerlink" title="throw 丢出异常"></a><code>throw</code> 丢出异常</h4></blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public class Main &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        a();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static void a()&#123;</span><br><span class="line">        b();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static void b()&#123;</span><br><span class="line">        c();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static void c()&#123;</span><br><span class="line">        throw new RuntimeException();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>所有人都不处理这个异常会怎么样</p>
</blockquote>
<ul>
<li>答案是： 终止这个线程，如果都没人抓这个异常，异常就会把当前的线程杀掉，这是默认的处理方式</li>
</ul>
<blockquote>
<h4 id="throws-用于声明方法将来可能会丢出什么样的东西"><a href="#throws-用于声明方法将来可能会丢出什么样的东西" class="headerlink" title="throws 用于声明方法将来可能会丢出什么样的东西"></a><code>throws</code> 用于声明方法将来可能会丢出什么样的东西</h4></blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">private static void b() throws  Exception&#123;</span><br><span class="line">    if(true)&#123;</span><br><span class="line">        throw new Exception();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>如果一个方法抛出了异常，那么调用它的地方都要 主动抛出异常 或者 <code>try/catch</code></strong></p>
<blockquote>
<h4 id="throw-throws区别"><a href="#throw-throws区别" class="headerlink" title="throw/throws区别"></a>throw/throws区别</h4></blockquote>
<ul>
<li>throw 是一个语句，可以声明自己要抛出的异常，不管这个异常怎样被处理，只管往外抛</li>
<li>throws 只是声明当前方法 <strong>有可能</strong> 会抛出 <code>XXException</code>,代价就是调用该方法的地方都要 <code>throws XXException</code> 或者 <code>try/catch</code></li>
</ul>
<h4 id="让你诧异的地方"><a href="#让你诧异的地方" class="headerlink" title="让你诧异的地方"></a>让你诧异的地方</h4><blockquote>
<p><code>throws RuntimeException</code> 时候 a 不报错</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">private static void a()&#123;</span><br><span class="line">    b();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private static void b() throws RuntimeException&#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>throws Exception</code> 时候 a 竟然报错了</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">private static void a()&#123;</span><br><span class="line">    b();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private static void b() throws Exception&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Java的异常体系"><a href="#Java的异常体系" class="headerlink" title="Java的异常体系"></a>Java的异常体系</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Throwable </span><br><span class="line">所有 错误 和 异常的父类 ，任何的 throwable 都可以被丢出来</span><br><span class="line">它是有毒的</span><br><span class="line">    -|Exception  (checked exception) 受检异常，有毒</span><br><span class="line">        -|RuntionException 运行时异常 无毒</span><br><span class="line">            _|NullPointerException</span><br><span class="line"></span><br><span class="line">    -|Error 错误 无毒</span><br></pre></td></tr></table></figure>
<h4 id="什么是-有毒-什么是-无毒"><a href="#什么是-有毒-什么是-无毒" class="headerlink" title="什么是 有毒 什么是 无毒"></a>什么是 有毒 什么是 无毒</h4><blockquote>
<p>”有毒“学名叫做 <strong>受检异常</strong></p>
</blockquote>
<ul>
<li>抛出了<code>Throwable</code> 或者 <code>Throwable 的子类</code> 都是有毒的，就是你必须处理它 要么你也 <code>throws</code> 要么 <code>try/catch</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">private static void a()&#123;</span><br><span class="line">    b();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private static void b() throws Throwable&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>“无毒” 学名叫做 <strong>不受检异常</strong></p>
</blockquote>
<ul>
<li>不用去处理，你可以随便抛<ul>
<li>RuntimeException</li>
<li>NullPointerException</li>
<li>Error</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">private static void a()&#123;</span><br><span class="line">    b();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private static void b() throws RuntimeException&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<h4 id="java异常体系的最初的设计想法"><a href="#java异常体系的最初的设计想法" class="headerlink" title="java异常体系的最初的设计想法"></a>java异常体系的最初的设计想法</h4></blockquote>
<p>1994年 ，假如显示的抛出异常，这样别人就必须处理，是不是能让软件更加安全呢？ </p>
<ul>
<li>当时的想法：是的</li>
<li>后来发现：实在太麻烦了，于是大家纷纷讨厌了这种设计思路。</li>
</ul>
<blockquote>
<h4 id="Exception-代表我预期，可能会发生的情况的一种状态"><a href="#Exception-代表我预期，可能会发生的情况的一种状态" class="headerlink" title="Exception 代表我预期，可能会发生的情况的一种状态"></a>Exception 代表我预期，可能会发生的情况的一种状态</h4></blockquote>
<ul>
<li>预期之内的， 如文件找不到，断网了</li>
<li>所以当时的思路是，任何调用<code>throws Exception 的方法</code>的人都该对预期之内的情况进行处理 ，这就是最初设计的目的</li>
</ul>
<blockquote>
<h4 id="RuntimeException-代表什么呢？"><a href="#RuntimeException-代表什么呢？" class="headerlink" title="RuntimeException 代表什么呢？"></a>RuntimeException 代表什么呢？</h4></blockquote>
<ul>
<li>意料之外的异常，因此不需要声明，所以你可以随便丢</li>
<li>发生了就是一个bug</li>
</ul>
<blockquote>
<h4 id="Error-是什么"><a href="#Error-是什么" class="headerlink" title="Error 是什么"></a>Error 是什么</h4></blockquote>
<ul>
<li>异常是可以恢复的，而 Error 是不可以恢复的异常</li>
<li>意思就是 “错误”</li>
<li>大多数情况 代表 <strong>不正常</strong> 的情况</li>
</ul>
<h3 id="你可以丢出不同的异常-因为它们都是-Exception-的子类"><a href="#你可以丢出不同的异常-因为它们都是-Exception-的子类" class="headerlink" title="你可以丢出不同的异常,因为它们都是 Exception 的子类"></a>你可以丢出不同的异常,因为它们都是 Exception 的子类</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">private static void b()&#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        c();</span><br><span class="line">    &#125; catch (FileNotFoundException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        System.out.println(&quot;文件没找到&quot;);</span><br><span class="line">    &#125; catch (EOFException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        System.out.println(&quot;文件末尾&quot;);</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">private static void c () throws Exception &#123;</span><br><span class="line">    if(fileNotFound())&#123;</span><br><span class="line">        throw new FileNotFoundException();</span><br><span class="line">    &#125;else if(readFileEnd())&#123;</span><br><span class="line">        throw new EOFException();</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        throw new IOException();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>如果一个方法抛出多个异常，你应该按照 <strong>从小到大</strong> 的顺序捕获异常</p>
</blockquote>
<ul>
<li>为什么？ 因为 Exception 是其他异常的父类，优先被匹配了，这样就不会走进其他 catch 里了</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">try &#123;</span><br><span class="line">    c();</span><br><span class="line">&#125; catch (NullPointerException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">    System.out.println(&quot;文件没找到&quot;);</span><br><span class="line">&#125; catch (RuntimeException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">    System.out.println(&quot;文件末尾&quot;);</span><br><span class="line">&#125; catch (Exception e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125; catch (Throwable t)&#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>比如一个方法抛出了多个异常，其中有两个处理都是 打印日志，你可以 <strong>折叠</strong> 它</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">private static void b()&#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        c();</span><br><span class="line">    &#125; catch (NullPointerException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; catch (IllegalAccessException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; catch (Throwable t)&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 折叠它 对处理方式一样的异常 来合并 catch 块</span><br><span class="line"></span><br><span class="line">private static void b()&#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        c();</span><br><span class="line">    &#125; catch (NullPointerException | IllegalAccessException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; catch (Throwable t)&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="异常的栈轨迹-Stacktrace"><a href="#异常的栈轨迹-Stacktrace" class="headerlink" title="异常的栈轨迹  Stacktrace"></a>异常的栈轨迹  Stacktrace</h3><ul>
<li><strong>排查问题最重要的信息，没有之一</strong></li>
<li><strong>排查问题最重要的信息，没有之一</strong></li>
<li><strong>排查问题最重要的信息，没有之一</strong></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">package com.io.demo;</span><br><span class="line"></span><br><span class="line">public class Main &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        a();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static void a()&#123;</span><br><span class="line">        b();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static void b()&#123;</span><br><span class="line">        c();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static void c ()  &#123;</span><br><span class="line">        d();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static void d ()  &#123;</span><br><span class="line">        if(true)&#123;</span><br><span class="line">            throw new RuntimeException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>栈轨迹如下</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread &quot;main&quot; java.lang.RuntimeException</span><br><span class="line">	at com.io.demo.Main.d(Main.java:23)</span><br><span class="line">	at com.io.demo.Main.c(Main.java:18)</span><br><span class="line">	at com.io.demo.Main.b(Main.java:14)</span><br><span class="line">	at com.io.demo.Main.a(Main.java:10)</span><br><span class="line">	at com.io.demo.Main.main(Main.java:6)</span><br><span class="line"></span><br><span class="line">沿着栈轨迹 我们知道方法的执行过程，从哪里报错了</span><br><span class="line">这是排查错误最重要的信息</span><br></pre></td></tr></table></figure>
<blockquote>
<h4 id="为异常添加额外信息，以便排查"><a href="#为异常添加额外信息，以便排查" class="headerlink" title="为异常添加额外信息，以便排查"></a>为异常添加额外信息，以便排查</h4></blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">package com.io.demo;</span><br><span class="line"></span><br><span class="line">import java.sql.SQLException;</span><br><span class="line"></span><br><span class="line">public class Main &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        a();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static void a()&#123;</span><br><span class="line">        processUserData();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static class UserAlreadyExistException extends RuntimeException&#123;</span><br><span class="line">        public UserAlreadyExistException(String msg, Throwable cause) &#123;</span><br><span class="line">            super(msg,cause);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static void processUserData ()  &#123;</span><br><span class="line">        Integer userId = 1;</span><br><span class="line">        try &#123;</span><br><span class="line">            insertIntoDatabase();</span><br><span class="line">        &#125; catch (SQLException e) &#123;</span><br><span class="line">            // 额外包一层 用于方便排查信息</span><br><span class="line">            throw new UserAlreadyExistException(&quot;插入id值为：&quot; + userId + &quot;的数据发生了异常&quot;,e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static void insertIntoDatabase () throws SQLException &#123;</span><br><span class="line">        throw new SQLException(&quot;重复的键值&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 栈轨迹如下</span><br><span class="line"></span><br><span class="line">Exception in thread &quot;main&quot; com.io.demo.Main$UserAlreadyExistException: 插入id值为：1的数据发生了异常</span><br><span class="line">	at com.io.demo.Main.processUserData(Main.java:27)</span><br><span class="line">	at com.io.demo.Main.a(Main.java:12)</span><br><span class="line">	at com.io.demo.Main.main(Main.java:8)</span><br><span class="line">Caused by: java.sql.SQLException: 重复的键值</span><br><span class="line">	at com.io.demo.Main.insertIntoDatabase(Main.java:32)</span><br><span class="line">	at com.io.demo.Main.processUserData(Main.java:24)</span><br><span class="line">	... 2 more</span><br></pre></td></tr></table></figure>
<blockquote>
<h4 id="异常链-Caused-by"><a href="#异常链-Caused-by" class="headerlink" title="异常链 Caused by"></a>异常链 Caused by</h4></blockquote>
<h4 id="异常抛出的原则"><a href="#异常抛出的原则" class="headerlink" title="异常抛出的原则"></a>异常抛出的原则</h4><ul>
<li><p>能⽤if/else处理的，不要使⽤异常</p>
<ul>
<li><a href="https://github.com/hcsp/http-login-and-use-cookie/pull/7" target="_blank" rel="noopener">https://github.com/hcsp/http-login-and-use-cookie/pull/7</a><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">a()&#123;</span><br><span class="line">    try&#123;</span><br><span class="line">        return xxx.length();</span><br><span class="line">    &#125;catch(NullPointerException e)&#123;</span><br><span class="line">        return 0;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">a()&#123;</span><br><span class="line">    if(xxx != null)&#123;</span><br><span class="line">        return xxx.length();</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        return 0;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public int getNameLength() &#123;</span><br><span class="line">// Fix the NullPointerException thrown in this method</span><br><span class="line">// 在本方法中，修复抛出的空指针异常（NullPointerException）</span><br><span class="line">  -        return name.length();</span><br><span class="line">  +        try &#123;</span><br><span class="line">  +            return name.length();</span><br><span class="line">  +        &#125;catch(NullPointerException e) &#123;</span><br><span class="line">如果可以使用“正常”的流程完成，尽量不要使用try/catch。</span><br><span class="line">原因有二： </span><br><span class="line">1. 无法保证catch到的异常一定是你想要抓住的。你可以错误的catch到了更深处的异常。比如说，这里你怎么保证catch到的一定是name为null抛出来的，而不是name.length()方法里面抛出来的？（当然这个例子可能有点极端） </span><br><span class="line">2. 相比正常的if判断，异常的创建是非常，非常昂贵的操作</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>尽早抛出异常</p>
<ul>
<li>当你碰到一个异常时？</li>
<li>首先问自己 能处理这个异常吗？</li>
<li>如果不能处理就立刻抛出来</li>
</ul>
</li>
<li>异常要准确、带有详细信息<ul>
<li>一个写错的异常，比没有异常更可怕，你可以定义很多异常</li>
<li>如 <code>IOException</code> 是很宽泛的异常，你该抛出更具体的如 <code>FileNotFoundException / EOFException</code>等更准确的异常</li>
<li>尽可能带有更多的信息，如上面我们自己定义的<code>UserAlreadyExistException</code></li>
</ul>
</li>
<li>抛出异常也⽐悄悄地执⾏错误的逻辑强的多<ul>
<li>抓住了异常，就直接处理不要继续往下走流程<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">a()&#123;</span><br><span class="line">    String result = &quot;&quot;;</span><br><span class="line">    try &#123;</span><br><span class="line">        result = xxx;</span><br><span class="line">    &#125; catch (IOException e)&#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        // 这样要么抛出异常 要么return</span><br><span class="line">    &#125;</span><br><span class="line">    // 上面抓到了异常，此时就不该继续返回 result</span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">b()&#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        result = xxx;</span><br><span class="line">    &#125; catch (IOException e)&#123;</span><br><span class="line">        // e.printStackTrace();</span><br><span class="line">        不打印栈轨迹，你抓住了，但是你把异常吃掉了，很难排查问题</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h4 id="异常的处理原则"><a href="#异常的处理原则" class="headerlink" title="异常的处理原则"></a>异常的处理原则</h4><ul>
<li>本⽅法是否有责任处理这个异常？<ul>
<li>不要处理不归⾃⼰管的异常</li>
</ul>
</li>
<li>本⽅法是否有能⼒处理这个异常？<ul>
<li>如果⾃⼰⽆法处理，就抛出</li>
</ul>
</li>
<li>如⾮万分必要，不要忽略异常  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">try &#123;</span><br><span class="line">    result = xxx;</span><br><span class="line">&#125; catch (IOException e)&#123;&#125;</span><br><span class="line">这里就是把异常吃了，如果出错，没人发现的了这个异常</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="了解和使⽤JDK内置的异常"><a href="#了解和使⽤JDK内置的异常" class="headerlink" title="了解和使⽤JDK内置的异常"></a>了解和使⽤JDK内置的异常</h4><ul>
<li>NullPointerException</li>
<li>ClassNotFoundException/NoClassDefFoundError</li>
<li>IllegalStateException</li>
<li>IllegalArgumentException</li>
<li>IllegalAccessException</li>
<li>ClassCastException </li>
</ul>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/oak/">oak</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2019/09/04/ZB-022-01异常入门和控制流/" title="ZB-022-01异常入门和控制流" itemprop="url">ZB-022-01异常入门和控制流</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Stevin" target="_blank" itemprop="author">Stevin</a>
		
  <p class="article-time">
    <time datetime="2019-09-04T14:04:04.000Z" itemprop="datePublished"> Published 2019-09-04</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h3 id="异常"><a href="#异常" class="headerlink" title="异常"></a>异常</h3><ul>
<li>在 return 语句之外，为方法提供另外一种出口</li>
<li>IOException 通常代表“预期之内的异常”</li>
</ul>
<h4 id="有毒的-IOException"><a href="#有毒的-IOException" class="headerlink" title="有毒的 IOException"></a>有毒的 IOException</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">public class Main &#123;</span><br><span class="line">    private static void readFile(File file) throws IOException &#123;</span><br><span class="line">        InputStream inputStream = new FileInputStream(file);</span><br><span class="line">        while(true)&#123;</span><br><span class="line">            int b = inputStream.read();</span><br><span class="line">            if(b == -1)&#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.print((char) b);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static void 同事A() throws IOException &#123;</span><br><span class="line">        readFile(new File(&quot;my-file&quot;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static void 同事B() throws IOException &#123;</span><br><span class="line">        readFile(null);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于一个方法<code>readFile</code>丢出了一个异常，就使得所有使用该方法的人全部被传染了，被迫都要加上这个 <code>throws IOException</code></p>
<p>这个烦人的东西 <strong>源头是什么</strong> </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// 这里面声明了 throws </span><br><span class="line">public FileInputStream(File file) throws FileNotFoundException &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结论就是：<strong>任何声明了 throws XXXException 的方法</strong>，再被调用的时候都必须显示的声明 <code>throws XXX XXXException</code> 或者 <code>trg/catch</code></p>
<blockquote>
<h4 id="万能的解决方案"><a href="#万能的解决方案" class="headerlink" title="万能的解决方案"></a>万能的解决方案</h4></blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">private static void 同事B()&#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        readFile(null);</span><br><span class="line">    &#125; catch (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exception-是干嘛的？"><a href="#Exception-是干嘛的？" class="headerlink" title="Exception 是干嘛的？"></a>Exception 是干嘛的？</h4><p>对应任何一个函数都有入口和出口</p>
<p>但是 <strong>异常 给程序提供了另一种出口</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">public FileInputStream(File file) throws FileNotFoundException &#123;</span><br><span class="line">    String name = (file != null ? file.getPath() : null);</span><br><span class="line">    SecurityManager security = System.getSecurityManager();</span><br><span class="line">    if (security != null) &#123;</span><br><span class="line">        security.checkRead(name);</span><br><span class="line">    &#125;</span><br><span class="line">    if (name == null) &#123;</span><br><span class="line">        throw new NullPointerException();</span><br><span class="line">    &#125;</span><br><span class="line">    if (file.isInvalid()) &#123;</span><br><span class="line">        throw new FileNotFoundException(&quot;Invalid file path&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    fd = new FileDescriptor();</span><br><span class="line">    fd.attach(this);</span><br><span class="line">    path = name;</span><br><span class="line">    open(name);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 这里给程序提供了另一种出口</span><br><span class="line">if (name == null) &#123;</span><br><span class="line">    throw new NullPointerException();</span><br><span class="line">&#125;</span><br><span class="line">if (file.isInvalid()) &#123;</span><br><span class="line">    throw new FileNotFoundException(&quot;Invalid file path&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>举个例子</p>
</blockquote>
<ul>
<li>假设文件不存在你去调用 <code>readFile</code> 就会丢出一个<code>RuntimeException</code>异常</li>
<li>它会击穿方法栈里所有的东西，一直向上抛，抛到有人处理它为止</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">private static void readFile(File file) throws IOException &#123;</span><br><span class="line">    if(file == null)&#123;</span><br><span class="line">        throw new RuntimeException();</span><br><span class="line">    &#125;</span><br><span class="line">    InputStream inputStream = new FileInputStream(file);</span><br><span class="line">    while(true)&#123;</span><br><span class="line">        int b = inputStream.read();</span><br><span class="line">        if(b == -1)&#123;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.print((char) b);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>异常：异常击穿栈帧过程</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">public class Main &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        a();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static void a()&#123;</span><br><span class="line">        b();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static void b()&#123;</span><br><span class="line">        c();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static void c()&#123;</span><br><span class="line">        d();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static void d()&#123;</span><br><span class="line">        throw new RuntimeException();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line">调用 main =&gt; a =&gt; b ==&gt; c ==&gt; d</span><br><span class="line">此时 d 抛出一个异常，导致异常击穿当前方法，使得当前方法退出</span><br><span class="line">击穿 c ==&gt; 击穿 b ==&gt; 击穿 a ==&gt; 抛给 main</span><br><span class="line">击穿所有栈帧，直接结束掉</span><br><span class="line">*/</span><br></pre></td></tr></table></figure>
<h4 id="java的异常体系"><a href="#java的异常体系" class="headerlink" title="java的异常体系"></a>java的异常体系</h4><blockquote>
<p>处理异常</p>
</blockquote>
<ul>
<li>在 <code>a方法处 try/catch</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">public class Main &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        a();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static void a()&#123;</span><br><span class="line">        try&#123;</span><br><span class="line">            b();</span><br><span class="line">        &#125;catch (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static void b()&#123;</span><br><span class="line">        c();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static void c()&#123;</span><br><span class="line">        d();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static void d()&#123;</span><br><span class="line">        throw new RuntimeException();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line">调用 main =&gt; a =&gt; b ==&gt; c ==&gt; d</span><br><span class="line">此时 d 抛出一个异常，导致异常击穿当前方法，使得当前方法退出</span><br><span class="line">异常丢到 c，c没有处理异常被击穿</span><br><span class="line"> ==&gt; </span><br><span class="line">异常丢到 b，b没有处理异常被击穿</span><br><span class="line"> ==&gt;</span><br><span class="line">异常丢到 a，a 里面有 try/catch 尝试捕获异常，</span><br><span class="line">    抓到后变成了 e ==&gt; e.printStackTrace();</span><br><span class="line"></span><br><span class="line">这就是 java的异常处理</span><br><span class="line">*/</span><br></pre></td></tr></table></figure>
<h4 id="Finally"><a href="#Finally" class="headerlink" title="Finally"></a>Finally</h4><p><strong>无论程序正常/异常都执行的操作</strong></p>
<ul>
<li>释放 数据库连接</li>
<li>关闭 文件</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">public class Main &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        System.out.println(a());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static int a()&#123;</span><br><span class="line">        try&#123;</span><br><span class="line">            b();</span><br><span class="line">            return 0;</span><br><span class="line">        &#125;catch (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            return 1;</span><br><span class="line">        &#125;finally&#123;</span><br><span class="line">            System.out.println(222);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static void b()&#123;</span><br><span class="line">        c();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static void c()&#123;</span><br><span class="line">        d();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static void d()&#123;</span><br><span class="line">        throw new RuntimeException();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line">java.lang.RuntimeException</span><br><span class="line">	at com.io.demo.Main.d(Main.java:35)</span><br><span class="line">	at com.io.demo.Main.c(Main.java:31)</span><br><span class="line">	at com.io.demo.Main.b(Main.java:27)</span><br><span class="line">	at com.io.demo.Main.a(Main.java:16)</span><br><span class="line">	at com.io.demo.Main.main(Main.java:11)</span><br><span class="line">222</span><br><span class="line">1</span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line">// 捕获异常</span><br><span class="line">// 无论a结果如何 执行 finally里的语句</span><br><span class="line">// 返回 1</span><br></pre></td></tr></table></figure>
<blockquote>
<h4 id="不要在-finally里写-return"><a href="#不要在-finally里写-return" class="headerlink" title="不要在 finally里写 return"></a>不要在 finally里写 return</h4></blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public class Main &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">//        a();</span><br><span class="line">        System.out.println(a());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static int a()&#123;</span><br><span class="line">        try&#123;</span><br><span class="line">            b();</span><br><span class="line">            return 0;</span><br><span class="line">        &#125;catch (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            return 1;</span><br><span class="line">        &#125;finally&#123;</span><br><span class="line">            System.out.println(222);</span><br><span class="line">            return 3;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static void b()&#123;</span><br><span class="line">        c();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static void c()&#123;</span><br><span class="line">        d();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static void d()&#123;</span><br><span class="line">        throw new RuntimeException();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">执行结果</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line">java.lang.RuntimeException</span><br><span class="line">	at com.io.demo.Main.d(Main.java:36)</span><br><span class="line">	at com.io.demo.Main.c(Main.java:32)</span><br><span class="line">	at com.io.demo.Main.b(Main.java:28)</span><br><span class="line">	at com.io.demo.Main.a(Main.java:16)</span><br><span class="line">	at com.io.demo.Main.main(Main.java:11)</span><br><span class="line">222</span><br><span class="line">3</span><br><span class="line">*/</span><br></pre></td></tr></table></figure>
<ul>
<li>finally 里的 return 会打破原来的流程，取代 catch里的 return </li>
<li><strong>finally 里 应该只执行资源的清理工作</strong></li>
<li>finally 不是必要的，其实 catch 也不是必要的  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">// 可以没有 catch</span><br><span class="line">private static int a()&#123;</span><br><span class="line">    try&#123;</span><br><span class="line">        b();</span><br><span class="line">        return 0;</span><br><span class="line">    &#125;finally&#123;</span><br><span class="line">        System.out.println(222);</span><br><span class="line">        return 3;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 不能只有 try  ，报错</span><br><span class="line">private static int a()&#123;</span><br><span class="line">    try&#123;</span><br><span class="line">        b();</span><br><span class="line">        return 0;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<blockquote>
<h4 id="如果你catch里什么都不做，别人想杀了你"><a href="#如果你catch里什么都不做，别人想杀了你" class="headerlink" title="如果你catch里什么都不做，别人想杀了你"></a>如果你catch里什么都不做，别人想杀了你</h4></blockquote>
<ul>
<li>一般来说，必须在 catch 里做处理</li>
<li>不做处理，可能项目上线一周发现问题都很难排查，因为没有任何错误信息，这个错误信息被你吃了</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">private static void a()&#123;</span><br><span class="line">    try&#123;</span><br><span class="line">        b();</span><br><span class="line">    &#125;catch (Exception e)&#123;</span><br><span class="line">        // 异常被你吃掉了～</span><br><span class="line">        // 异常被你吃掉了～</span><br><span class="line">        // 异常被你吃掉了～</span><br><span class="line">    &#125;finally&#123;</span><br><span class="line">        System.out.println(222);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>你应该在 catch里这样</strong></p>
<ul>
<li>处理异常</li>
<li>在日志里打印异常</li>
<li>返回对应的异常处理</li>
</ul>
<h4 id="file-leak-detector"><a href="#file-leak-detector" class="headerlink" title="file-leak-detector"></a>file-leak-detector</h4><p>它是用于针对那些粗心的开发人员在自己的程序里忘了写 <code>close</code>导致各种各样的闹鬼问题，用于检测这种情况。</p>
<ul>
<li><a href="https://file-leak-detector.kohsuke.org" target="_blank" rel="noopener">https://file-leak-detector.kohsuke.org</a></li>
<li>kohsuke 就是 jenkins 的作者</li>
</ul>
<h4 id="try-with-resources-JDK7"><a href="#try-with-resources-JDK7" class="headerlink" title="try with resources (JDK7+)"></a>try with resources (JDK7+)</h4><blockquote>
<p>语法糖</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// 以前你要在 finally里 关闭资源</span><br><span class="line">private static void XXX(Connection conn) throws SQLException &#123;</span><br><span class="line">    PreparedStatement preparedStatement = null;</span><br><span class="line">    try&#123;</span><br><span class="line">        preparedStatement = conn.prepareStatement(&quot;sql&quot;);</span><br><span class="line">        preparedStatement.executeQuery();</span><br><span class="line">    &#125;finally &#123;</span><br><span class="line">        preparedStatement.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>try with resources改写后</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">private static void XXX(Connection conn) throws SQLException &#123;</span><br><span class="line">    try (PreparedStatement preparedStatement = conn.prepareStatement(&quot;sql&quot;)) &#123;</span><br><span class="line">        preparedStatement.executeQuery();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 你在 try 的括号里 声明了一个语句</span><br><span class="line">1. 你可以不加 finally ,java 会自动给你加 finally</span><br><span class="line">2. 在 try离开的时候 把括号内的资源清理掉</span><br></pre></td></tr></table></figure>
<p><strong>问题来了，什么样的东西可以自动被清理掉呢？</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">// PreparedStatement 点进去看看</span><br><span class="line">public interface PreparedStatement extends Statement &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line">// Statement 点进去看看</span><br><span class="line">public interface Statement extends Wrapper, AutoCloseable &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 应该就是它了   </span><br><span class="line">/**</span><br><span class="line"> * An object that may hold resources (such as file or socket handles)</span><br><span class="line"> * until it is closed. The &#123;@link #close()&#125; method of an &#123;@code AutoCloseable&#125;</span><br><span class="line"> * object is called automatically when exiting a &#123;@code</span><br><span class="line"> * try&#125;-with-resources block for which the object has been declared in</span><br><span class="line"> * the resource specification header. This construction ensures prompt</span><br><span class="line"> * release, avoiding resource exhaustion exceptions and errors that</span><br><span class="line"> * may otherwise occur.</span><br><span class="line"> */</span><br><span class="line">public interface AutoCloseable &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 任何实现 AutoCloseable 的对象在离开 try() 语句块的时候，都将调用 close();</span><br></pre></td></tr></table></figure>
<blockquote>
<p>一个注意点</p>
</blockquote>
<p><code>try with resource</code> 的限制，只能在同一方法里使用。如果你的业务要求你 <strong>在某处打开文件，另一个地方关闭文件，它就做不到</strong> </p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/oak/">oak</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2019/09/03/ZB-021-02-NIO/" title="ZB-021-02-NIO" itemprop="url">ZB-021-02-NIO</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Stevin" target="_blank" itemprop="author">Stevin</a>
		
  <p class="article-time">
    <time datetime="2019-09-03T14:25:29.000Z" itemprop="datePublished"> Published 2019-09-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h3 id="NIO-（Java-7-）"><a href="#NIO-（Java-7-）" class="headerlink" title="NIO （Java 7+）"></a>NIO （Java 7+）</h3><ul>
<li>New IO 新的IO</li>
<li>Non-blocking IO ⾮阻塞IO</li>
<li>NIO的Path - 就是旧版本的File<ul>
<li>它们之间可以转换</li>
<li>Path.toFile()</li>
<li>File.toPath()</li>
</ul>
</li>
</ul>
<h4 id="关于NIO你仅仅需要了解-Files"><a href="#关于NIO你仅仅需要了解-Files" class="headerlink" title="关于NIO你仅仅需要了解 Files"></a>关于NIO你仅仅需要了解 <code>Files</code></h4><p>比较有用的几个api</p>
<ul>
<li>Files.walkFileTree</li>
<li>Files.readAllLines 不依赖第三方库的时候使用</li>
</ul>
<h4 id="NIO到底干什么的"><a href="#NIO到底干什么的" class="headerlink" title="NIO到底干什么的"></a>NIO到底干什么的</h4><blockquote>
<p><strong>经典的<code>IO</code>模型是基于流的</strong></p>
</blockquote>
<ul>
<li>就是你访问磁盘/网络的时候都是以<strong>流</strong>的形式</li>
</ul>
<p>它的优点是： 非常的直观，方便抽象 读 read / 写 write </p>
<p>它的缺点是： 慢，因为它是 流 就像一个水流，一个字节一个字节按顺序的读或写，严重限制了它的性能。</p>
<blockquote>
<p><strong>NIO模型是基于块的</strong></p>
</blockquote>
<p>好处是： 块和块之间没有顺序的，可以同时的写，比基于流的要快</p>
<p>还有一个原因就是 上篇文章里说的 <a href="http://www.sohu.com/a/222322011_487482" target="_blank" rel="noopener">CPU说：这个世界太慢了</a> 所导致的 CPU和硬盘之间的矛盾</p>
<h4 id="由于IO慢逼迫我们这样做"><a href="#由于IO慢逼迫我们这样做" class="headerlink" title="由于IO慢逼迫我们这样做"></a>由于IO慢逼迫我们这样做</h4><blockquote>
<p>1.缓冲</p>
</blockquote>
<ul>
<li>buffer</li>
<li>cache</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cpu往硬盘写一个文件</span><br><span class="line">你有两个选择</span><br><span class="line"></span><br><span class="line">1. 一个一个字节的写 </span><br><span class="line">    这就导致了 </span><br><span class="line">        写一个字节 等一个磁盘写入时间 </span><br><span class="line">        再写一个字节 在等一个磁盘写入时间</span><br><span class="line">        循环往复 </span><br><span class="line">2. 攒一堆一块写， 比如缓冲区里是 1MB 攒够了一次写入磁盘</span><br></pre></td></tr></table></figure>
<blockquote>
<p>2.并发(多线程)</p>
</blockquote>
<h3 id="IO太慢了，怎么办？"><a href="#IO太慢了，怎么办？" class="headerlink" title="IO太慢了，怎么办？"></a>IO太慢了，怎么办？</h3><ul>
<li>BufferedReader/Writer</li>
<li>BufferedReader - ⼀次性读取好多东⻄到缓冲区⾥</li>
<li>BufferedWriter - ⼀次性写好多东⻄到缓冲区⾥</li>
<li>在内存中创建好，⼀次写⼊</li>
</ul>
<blockquote>
<p>换⾏符的故事</p>
</blockquote>
<ul>
<li>windows 换行是 <code>\r\n</code></li>
<li>linux 换行是 <code>\n</code></li>
</ul>
<p><strong>导致文件从不同系统复制过来后显示会有问题</strong></p>
<blockquote>
<p>这个缓冲区到底是什么</p>
</blockquote>
<ul>
<li>实际就是<code>char cb[]</code>，它是在内存里的</li>
</ul>
<h3 id="其实……不需要重复发明轮⼦"><a href="#其实……不需要重复发明轮⼦" class="headerlink" title="其实……不需要重复发明轮⼦"></a>其实……不需要重复发明轮⼦</h3><ul>
<li>需要任何IO的功能，尽管搜索，肯定有⼈把轮⼦造好了。<ul>
<li>FileUtils</li>
<li>IOUtils</li>
</ul>
</li>
</ul>
<h4 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h4><ul>
<li><a href="https://github.com/hcsp/read-write-files" target="_blank" rel="noopener">https://github.com/hcsp/read-write-files</a></li>
<li><a href="https://github.com/hcsp/save-pull-requests-to-csv" target="_blank" rel="noopener">https://github.com/hcsp/save-pull-requests-to-csv</a></li>
</ul>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/oak/">oak</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2019/09/03/ZB-021-01-File与IO/" title="ZB-021-01-File与IO" itemprop="url">ZB-021-01-File与IO</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Stevin" target="_blank" itemprop="author">Stevin</a>
		
  <p class="article-time">
    <time datetime="2019-09-03T12:05:47.000Z" itemprop="datePublished"> Published 2019-09-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h3 id="计算机常识"><a href="#计算机常识" class="headerlink" title="计算机常识"></a>计算机常识</h3><p>现在典型的计算机里分三级</p>
<ul>
<li>CPU<ul>
<li>计算机的<strong>大脑</strong>，负责一切运算</li>
</ul>
</li>
<li>内存 memory<ul>
<li>存数据，断电丢失</li>
</ul>
</li>
<li>硬盘 <strong>存数据，容量大，断电不丢失</strong><ol>
<li>HDD 以前的硬盘</li>
<li>SSD 现在的硬盘</li>
</ol>
</li>
</ul>
<blockquote>
<h4 id="假设你有台-3GHz的电脑"><a href="#假设你有台-3GHz的电脑" class="headerlink" title="假设你有台 3GHz的电脑"></a>假设你有台 3GHz的电脑</h4></blockquote>
<ul>
<li>3*10亿</li>
<li>每秒运行 30亿条指令 如<code>i = i + 1</code></li>
<li>一个指令大概 <code>0.3ns</code> 这是非常快的</li>
</ul>
<h3 id="CPU说：这个世界太慢了"><a href="#CPU说：这个世界太慢了" class="headerlink" title="CPU说：这个世界太慢了"></a><a href="http://www.sohu.com/a/222322011_487482" target="_blank" rel="noopener">CPU说：这个世界太慢了</a></h3><blockquote>
<p>来源：cizixs（51CTO博客作者）</p>
</blockquote>
<blockquote>
<p>链接：<a href="http://blog.51cto.com/13188467/2065321" target="_blank" rel="noopener">http://blog.51cto.com/13188467/2065321</a></p>
</blockquote>
<p>经常听到有人说磁盘很慢、网络很卡，这都是站在人类的感知维度去表述的，比如拷贝一个文件到硬盘需要几分钟到几十分钟，够我去吃个饭啦；而从网络下载一部电影，有时候需要几个小时，我都可以睡一觉了。</p>
<p>最为我们熟知的关于计算机不同组件速度差异的图表，是下面这种金字塔形式：越往上速度越快，容量越小，而价格越高。这张图只是给了我们一个直观地感觉，并没有对各个速度和性能做出量化的说明和解释。而实际上，不同层级之间的差异要比这张图大的多。<strong>这篇文章就让你站在 CPU 的角度看这个世界，说说到底它们有多慢。</strong></p>
<p><img src="https://raw.githubusercontent.com/slTrust/note/master/java/zb_024_01.png" alt></p>
<p>希望你看到看完这篇文章能明白两件事情：</p>
<ul>
<li>磁盘和网络真的很慢</li>
<li>性能优化是个复杂的系统性的活</li>
</ul>
<p>注：所有的数据都是来自这个地址。所有的数据会因为机器配置不同，或者硬件的更新而有出入，但是不影响我们直觉的感受。如果对这些数据比较感兴趣，这个网址给出了不同年份一些指标的数值。</p>
<h4 id="数据"><a href="#数据" class="headerlink" title="数据"></a>数据</h4><p>先来看看 CPU 的速度，就拿我的电脑来说，<strong>主频是 2.6G，也就是说每秒可以执行 2.6*10^9 个指令每个指令只需要 0.38ns</strong>（现在很多个人计算机的主频要比这个高，配置比较高的能达到 3.0G+）。我们把这个时间当做基本单位 1s，因为 1s 大概是人类能感知的最小时间单位。</p>
<p><img src="https://raw.githubusercontent.com/slTrust/note/master/java/zb_024_02.png" alt></p>
<p><strong>一级缓存读取时间为 0.5ns，换算成人类时间大约是 1.3s</strong>，大约一次或者两次心跳的时间。这里能看出缓存的重要性，因为它的速度可以赶上 CPU，程序本身的 locality 特性加上指令层级上的优化，cache 访问的命中率很高，这最终能极大提高效率。</p>
<p><strong>分支预测错误需要耗时 5ns，换算成人类时间大约是 13s</strong>，这个就有点久了，所以你会看到很多文章分析如何优化代码来降低分支预测的几率，比如这个得分非常高的 stackoverflow 问题。</p>
<p><strong>二级缓存时间就比较久了，大约在 7ns，换算成人类时间大约是 18.2s</strong>，可以看到的是如果一级缓存没有命中，然后去二级缓存读取数据，时间差了一个数量级。</p>
<p><strong>小知识：为什么需要多层的 CPU 缓存呢？</strong>这篇文章通过一个通俗易懂的例子给出了讲解。</p>
<p>我们继续，<strong>互斥锁的加锁和解锁时间需要 25ns，换算成人类时间大约是 65s</strong>，首次达到了一分钟。并发编程中，我们经常听说锁是一个很耗时的东西，因为在微波炉里加热一个东西需要一分钟的话，你要在那傻傻地等蛮久了。</p>
<p>然后就到了内存，<strong>每次内存寻址需要 100ns，换算成人类时间是 260s</strong>，也就是4分多钟，如果读一些不需要太多思考的文章，这么久能读完2-3千字（这个快阅读的时代，很少人在手机上能静心多这么字了）。看起来还不算坏，不多要从内存中读取一段数据需要的时间会更多。到了内存之后，时间就变了一个量级，CPU 和内存之间的速度瓶颈被称为冯诺依曼瓶颈。</p>
<p><strong>一次 CPU 上下文切换（系统调用）需要大约 1500ns，也就是 1.5us（这个数字参考了这篇文章，采用的是单核 CPU 线程平均时间），换算成人类时间大约是 65分钟</strong>，嗯，也就是一个小时。我们也知道上下文切换是很耗时的行为，毕竟每次浪费一个小时，也很让人有罪恶感的。上下文切换更恐怖的事情在于，这段时间里 CPU 没有做任何有用的计算，只是切换了两个不同进程的寄存器和内存状态；而且这个过程还破坏了缓存，让后续的计算更加耗时。</p>
<p><strong>在 1Gbps 的网络上传输 2K 的数据需要 20us，换算成人类时间是 14.4小时</strong>，这么久都能把《星球大战》六部曲看完了（甚至还加上吃饭撒尿的时间）！可以看到网络上非常少数据传输对于 CPU 来说，已经很漫长。而且这里的时间还是理论最大值，实际过程还要更慢一些。</p>
<p><strong>SSD 随机读取耗时为 150us，换算成人类时间大约是 4.5天</strong>。换句话说，SSD 读点数据，CPU 都能休假，报团参加周边游了。虽然我们知道 SSD 要比机械硬盘快很多，但是这个速度对于 CPU 来说也是像乌龟一样。I/O 设备 从硬盘开始速度开始变得漫长，这个时候我们就想起内存的好处了。尽量减少 IO 设备的读写，把最常用的数据放到内存中作为缓存是所有程序的通识。像 memcached 和 redis 这样的高速缓存系统近几年的异军突起，就是解决了这里的问题。</p>
<p><strong>从内存中读取 1MB 的连续数据，耗时大约为 250us，换算成人类时间是 7.5天</strong>，这次假期升级到国庆七天国外游了。</p>
<p><strong>同一个数据中心网络上跑一个来回需要 0.5ms，换算成人类时间大约是 15天</strong>，也就是半个月的时间。如果你的程序有段代码需要和数据中心的其他服务器交互，在这段时间里 CPU 都已经狂做了半个月的运算。减少不同服务组件的网络请求，是性能优化的一大课题。</p>
<p><strong>从 SSD 读取 1MB 的顺序数据，大约需要 1ms，换算成人类时间是 1个月</strong>。也就是说 SSD 读一个普通的文件，如果要等你做完，CPU 一个月时间就荒废了。尽管如此，SSD 已经很快啦，不信你看下面机械磁盘的表现。</p>
<p><strong>磁盘寻址时间为 10ms，换算成人类时间是 10个月</strong>，刚好够人类创造一个新的生命了。如果 CPU 需要让磁盘泡杯咖啡，在它眼里，磁盘去生了个孩子，回来告诉它你让我泡的咖啡好了。机械硬盘使用 RPM(Revolutions Per Minute/每分钟转速) 来评估磁盘的性能：RPM 越大，平均寻址时间更短，磁盘性能越好。寻址只是把磁头移动到正确的磁道上，然后才能读取指定扇区的内容。换句话说，寻址虽然很浪费时间，但其实它并没有办任何的正事（读取磁盘内容）。</p>
<p><strong>从磁盘读取 1MB 连续数据需要 20ms，换算成人类时间是 20个月</strong>。IO 设备是计算机系统的瓶颈，希望读到这里你能更深切地理解这句话！如果还不理解，不妨想想你在网上买的东西，快递送了将近两年，你的心情是怎么样的。</p>
<p>而<strong>从世界上不同城市网络上走一个来回，平均需要 150ms（参考世界各地 ping 报文的时间），换算成人类时间是 12.5年</strong>。不难理解，所有的程序和架构都会尽量避免不同城市甚至是跨国家的网络访问，CDN 就是这个问题的一个解决方案：让用户和最接近自己的服务器交互，从而减少网络上报文的传输时间。</p>
<p><strong>虚拟机重启一次大约要 4s 时间，换算成人类的时间是 3百多年</strong>。对于此，我想到了乔布斯要死命优化 Mac 系统开机启动时间的故事。如果机器能少重启而且每次启动能快一点，不仅能救人命，也能救 CPU 的命。</p>
<p><strong>物理服务器重启一次需要 5min，换算成人类时间是 2万5千年</strong>，快赶上人类的文明史了。5 分钟人类都要等一会了，更别提 CPU 了，所以没事不要乱重启服务器啊，分分钟终结一个文明的节奏。</p>
<h3 id="文件的本质"><a href="#文件的本质" class="headerlink" title="文件的本质"></a>文件的本质</h3><blockquote>
<h4 id="一切文件的本质"><a href="#一切文件的本质" class="headerlink" title="一切文件的本质"></a>一切文件的本质</h4></blockquote>
<ul>
<li>一段字节流<ul>
<li>文本文件(txt/代码/HTML等)</li>
<li>二进制文件</li>
</ul>
</li>
<li>由每个程序负责解释文件的字节流<ul>
<li>看到<code>.txt</code>就文本编辑器</li>
<li>看到<code>.png</code>就显示为图片</li>
<li>看到<code>.mp4</code>就播放</li>
<li>文本编辑器打开二进制文件乱码，而<code>JVM/IDEA</code> 认识</li>
</ul>
</li>
</ul>
<blockquote>
<p>为什么文件不用十进制而用十六进制</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">十进制 112 </span><br><span class="line"></span><br><span class="line">十六进制 70</span><br><span class="line"></span><br><span class="line">如果是16进制 秘诀就是 8421</span><br><span class="line">   7|0</span><br><span class="line">----------</span><br><span class="line">8421|8421 </span><br><span class="line">0111|0000 换算成二进制</span><br><span class="line"></span><br><span class="line">这个 8421就是 BCD编码</span><br><span class="line"></span><br><span class="line">而十进制 112 换算二进制就没这么快了</span><br><span class="line"></span><br><span class="line">所以这就是为什么用16进制来展示，并通过把中间部分拆开两半换算的原因</span><br></pre></td></tr></table></figure>
<h3 id="输入输出IO流详解"><a href="#输入输出IO流详解" class="headerlink" title="输入输出IO流详解"></a>输入输出IO流详解</h3><ul>
<li>InputStream</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">package java.io;</span><br><span class="line"></span><br><span class="line">public abstract class InputStream implements Closeable &#123;</span><br><span class="line">    ...</span><br><span class="line">    // 最重要的方法 read</span><br><span class="line">    public abstract int read() throws IOException;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>OutputStream</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">package java.io;</span><br><span class="line"></span><br><span class="line">public abstract class InputStream implements Closeable, Flushable&#123;</span><br><span class="line">    ...</span><br><span class="line">    // 最重要的方法 write</span><br><span class="line">    public abstract void write(int b) throws IOException;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<h4 id="如果你对操作系统不是十分熟悉，请使用绝对路径"><a href="#如果你对操作系统不是十分熟悉，请使用绝对路径" class="headerlink" title="如果你对操作系统不是十分熟悉，请使用绝对路径"></a>如果你对操作系统不是十分熟悉，请使用绝对路径</h4></blockquote>
<ul>
<li>从文件读取字节流</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public static void main(String[] args) throws IOException &#123;</span><br><span class="line">    InputStream inputStream = new FileInputStream(&quot;绝对路径的文件&quot;);</span><br><span class="line">    while(true)&#123;</span><br><span class="line">        int b = inputStream.read();</span><br><span class="line">        if(b == -1)&#123;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.print((char) b);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    OutputStream outputStream = new FileOutputStream(&quot;绝对路径的文件&quot;);</span><br><span class="line">    outputStream.write(&apos;p&apos;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>从网络读取字节流</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">HttpClient client = HttpClients.createDefault();</span><br><span class="line">HttpGet get = new HttpGet(&quot;https://www.baidu.com&quot;);</span><br><span class="line">HttpResponse response = client.execute(get);</span><br><span class="line"></span><br><span class="line">System.out.println(response.getStatusLine());</span><br><span class="line">System.out.println((char) response.getEntity().getContent().read());</span><br></pre></td></tr></table></figure>
<ul>
<li>从其他各种地方读取内容</li>
</ul>
<p>在java中 fork子进程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ProcessBuilder pb = new ProcessBuilder(&quot;ls&quot;);</span><br><span class="line">Process process = pb.start();</span><br><span class="line">System.out.println((char)process.getInputStream().read());</span><br></pre></td></tr></table></figure>
<h3 id="java中的File"><a href="#java中的File" class="headerlink" title="java中的File"></a>java中的File</h3><ul>
<li><strong>不要误会！不要误会！不要误会！</strong><ul>
<li>File并不代表⼀个“⽂件”，它只代表⼀个 <strong>路径</strong></li>
<li>抽象的“⽂件”路径：⽂件或者⽂件夹</li>
</ul>
</li>
<li><p>File的常⻅⽅法</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// 不要背这些api 最重要的是找到如何使用这些</span><br><span class="line">File file = new File(&quot;路径&quot;);</span><br><span class="line">file.isDirectory();</span><br><span class="line">file.exists();</span><br><span class="line">file.isFile();</span><br><span class="line">file.getAbsolutePath();</span><br><span class="line">file.listFiles(); // List&lt;File&gt;</span><br><span class="line">file.list();// 文件名</span><br><span class="line">file.isAbsolute(); //是不是绝对路径</span><br><span class="line">file.getName(); //获取文件名</span><br><span class="line">file.getParentFile();</span><br><span class="line">file.getCanonicalPath(); //获取经典路径  如 &quot;./././.././&quot; =&gt; /某个目录</span><br></pre></td></tr></table></figure>
</li>
<li><p>绝对路径与相对路径</p>
<ul>
<li>绝对路径在 windows上 <code>c:/ 或 d:/开头的</code> ，在linux上 以<code>/</code>开头的</li>
<li>相对路径<code>&quot;.&quot;</code> 当前路径</li>
</ul>
</li>
<li>读/写⽂件</li>
</ul>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/oak/">oak</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2019/09/02/ZB-020-http/" title="ZB-020-http" itemprop="url">ZB-020-http</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Stevin" target="_blank" itemprop="author">Stevin</a>
		
  <p class="article-time">
    <time datetime="2019-09-02T14:11:38.000Z" itemprop="datePublished"> Published 2019-09-02</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h3 id="HTTP"><a href="#HTTP" class="headerlink" title="HTTP"></a>HTTP</h3><ul>
<li><a href="https://www.runoob.com/http/http-methods.html" target="_blank" rel="noopener">http请求方法</a></li>
<li><a href="https://www.runoob.com/http/http-status-codes.html" target="_blank" rel="noopener">http状态码</a></li>
</ul>
<blockquote>
<h4 id="HTTP彩蛋"><a href="#HTTP彩蛋" class="headerlink" title="HTTP彩蛋"></a>HTTP彩蛋</h4></blockquote>
<ul>
<li><a href="https://http.cat" target="_blank" rel="noopener">https://http.cat</a> 图解状态码</li>
</ul>
<blockquote>
<p>451什么意思</p>
</blockquote>
<ul>
<li>来源于一本小说《华式451度》 </li>
</ul>
<p><strong>代表由于法律原因被禁止的请求</strong></p>
<blockquote>
<p>另一个彩蛋 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/418" target="_blank" rel="noopener">http staus 咖啡壶</a></p>
</blockquote>
<ul>
<li>没有任何卵用</li>
</ul>
<h4 id="参考知识"><a href="#参考知识" class="headerlink" title="参考知识"></a>参考知识</h4><ul>
<li><a href="https://sltrust.github.io/2017/10/12/N006_HTTP入门/" target="_blank" rel="noopener">https://sltrust.github.io/2017/10/12/N006_HTTP入门/</a></li>
<li><a href="https://sltrust.github.io/2019/06/06/Java-019-HTTP/" target="_blank" rel="noopener">https://sltrust.github.io/2019/06/06/Java-019-HTTP/</a></li>
<li><a href="https://sltrust.github.io/2019/06/15/Java-030-cookie和session/" target="_blank" rel="noopener">https://sltrust.github.io/2019/06/15/Java-030-cookie和session/</a></li>
</ul>
<h4 id="HTTP实战"><a href="#HTTP实战" class="headerlink" title="HTTP实战"></a>HTTP实战</h4><ul>
<li><a href="https://github.com/hcsp/http-login-and-use-cookie/pull/2" target="_blank" rel="noopener">https://github.com/hcsp/http-login-and-use-cookie/pull/2</a></li>
</ul>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/oak/">oak</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2019/08/24/ReactWheels11-03form组件/" title="ReactWheels11-03form组件" itemprop="url">ReactWheels11-03form组件</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Stevin" target="_blank" itemprop="author">Stevin</a>
		
  <p class="article-time">
    <time datetime="2019-08-24T12:47:55.000Z" itemprop="datePublished"> Published 2019-08-24</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h3 id="proposal-optional-chaining-提案"><a href="#proposal-optional-chaining-提案" class="headerlink" title="proposal optional chaining 提案"></a>proposal optional chaining 提案</h3><ul>
<li><a href="https://github.com/tc39/proposal-optional-chaining" target="_blank" rel="noopener">https://github.com/tc39/proposal-optional-chaining</a></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">var a = &#123;c:[0,2]&#125;</span><br><span class="line"></span><br><span class="line">a.c &amp;&amp; a.c.join(&apos;,&apos;)</span><br><span class="line"></span><br><span class="line">// 如果有这个提案就可以这样</span><br><span class="line">a?.c.join(&apos;,&apos;)</span><br></pre></td></tr></table></figure>
<h3 id="异步的表单验证"><a href="#异步的表单验证" class="headerlink" title="异步的表单验证"></a>异步的表单验证</h3><p>如用户名是否存在</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">const rules = [</span><br><span class="line">           &#123;key: &apos;username&apos;,validator: &#123;</span><br><span class="line">                   name:&apos;unique&apos;,</span><br><span class="line">                   validate(username:string)&#123;</span><br><span class="line">                       axios.get(&apos;/check_name&apos;,&#123;params:&#123;username&#125;&#125;)</span><br><span class="line">                           .then(()=&gt;&#123;</span><br><span class="line">                               </span><br><span class="line">                           &#125;,()=&gt;&#123;</span><br><span class="line"></span><br><span class="line">                           &#125;)</span><br><span class="line">                       // 但是结果是异步的  </span><br><span class="line">                       // 此时只能用 Promise</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       ]</span><br></pre></td></tr></table></figure>
<blockquote>
<h4 id="Promise"><a href="#Promise" class="headerlink" title="Promise"></a>Promise</h4></blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">const usernames = [&apos;frank&apos;,&apos;jack&apos;,&apos;tom&apos;];</span><br><span class="line">const checkUserName = (username: string,success:()=&gt;void,fail:()=&gt;void) =&gt;&#123;</span><br><span class="line">    setTimeout(()=&gt;&#123;</span><br><span class="line">        if(usernames.indexOf(username)&gt;0)&#123;</span><br><span class="line">            success()</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            fail();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,3000);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;key: &apos;username&apos;,validator: &#123;</span><br><span class="line">        name:&apos;unique&apos;,</span><br><span class="line">        validate(username:string)&#123;</span><br><span class="line">            return new Promise((resolve,reject)=&gt;&#123;</span><br><span class="line">                checkUserName(username, resolve, reject);</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Promise-1"><a href="#Promise-1" class="headerlink" title="Promise"></a>Promise</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cosnt x = ()=&gt;&#123;&#125;;</span><br><span class="line"></span><br><span class="line">Promise.all(promistList).then(x,x);</span><br><span class="line">// 等价于</span><br><span class="line">Promise.all(promistList).finally(x);</span><br></pre></td></tr></table></figure>
<h4 id="Todo"><a href="#Todo" class="headerlink" title="Todo"></a>Todo</h4><ul>
<li>支持子字段编辑(子表单)</li>
<li>支持更多的 type 如 图片上传 / 自定义 type</li>
<li>支持手机端</li>
</ul>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
</div>

</footer>


    </article>







  <nav id="page-nav" class="clearfix">
    <a class="extend prev" rel="prev" href="/page/9/"><span></span>Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="page-number" href="/page/9/">9</a><span class="page-number current">10</span><a class="page-number" href="/page/11/">11</a><a class="page-number" href="/page/12/">12</a><span class="space">&hellip;</span><a class="page-number" href="/page/51/">51</a><a class="extend next" rel="next" href="/page/11/">Next<span></span></a>
  </nav>

</div>
      <div class="openaside"><a class="navbutton" href="#" title="Show Sidebar"></a></div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div>
<aside class="clearfix">

  


  

  
<div class="tagslist">
	<p class="asidetitle">Tags</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/oak/" title="oak">oak<sup>71</sup></a></li>
			
		
			
				<li><a href="/tags/前端知识点/" title="前端知识点">前端知识点<sup>43</sup></a></li>
			
		
			
				<li><a href="/tags/java/" title="java">java<sup>37</sup></a></li>
			
		
			
				<li><a href="/tags/Node后端/" title="Node后端">Node后端<sup>34</sup></a></li>
			
		
			
				<li><a href="/tags/M06/" title="M06">M06<sup>29</sup></a></li>
			
		
			
				<li><a href="/tags/fullstack/" title="fullstack">fullstack<sup>27</sup></a></li>
			
		
			
				<li><a href="/tags/M07/" title="M07">M07<sup>27</sup></a></li>
			
		
			
				<li><a href="/tags/python/" title="python">python<sup>26</sup></a></li>
			
		
			
				<li><a href="/tags/M08/" title="M08">M08<sup>25</sup></a></li>
			
		
			
				<li><a href="/tags/M04/" title="M04">M04<sup>22</sup></a></li>
			
		
			
				<li><a href="/tags/M03/" title="M03">M03<sup>20</sup></a></li>
			
		
			
				<li><a href="/tags/M02/" title="M02">M02<sup>17</sup></a></li>
			
		
			
				<li><a href="/tags/React入门/" title="React入门">React入门<sup>17</sup></a></li>
			
		
			
				<li><a href="/tags/ReactWheels/" title="ReactWheels">ReactWheels<sup>16</sup></a></li>
			
		
			
				<li><a href="/tags/TS入门/" title="TS入门">TS入门<sup>16</sup></a></li>
			
		
			
				<li><a href="/tags/CSS/" title="CSS">CSS<sup>10</sup></a></li>
			
		
			
				<li><a href="/tags/M01/" title="M01">M01<sup>9</sup></a></li>
			
		
			
				<li><a href="/tags/vue/" title="vue">vue<sup>8</sup></a></li>
			
		
			
				<li><a href="/tags/ES6速学/" title="ES6速学">ES6速学<sup>7</sup></a></li>
			
		
			
				<li><a href="/tags/mongodb/" title="mongodb">mongodb<sup>7</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">Links</p>
    <ul>
        
          <li>
            
            	<a href="https://coderq.com" target="_blank" title="一个面向程序员交流分享的新一代社区">码农圈</a>
            
          </li>
        
          <li>
            
            	<a href="http://wuchong.me" target="_blank" title="Jark&#39;s Blog">Jark&#39;s Blog</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS</a>
</div>

  <div class="weiboshow">
  <p class="asidetitle">Weibo</p>
    <iframe width="100%" height="119" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=119&fansRow=2&ptype=1&speed=0&skin=9&isTitle=1&noborder=1&isWeibo=0&isFans=0&uid=&verifier=b3593ceb&dpc=1"></iframe>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello ,I&#39;m Larry Page in Google. <br/>
			This is my blog,believe it or not.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/2176287895" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		
		
		
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2020 
		
		<a href="/about" target="_blank" title="Stevin">Stevin</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
        
    }
  });
});
</script>












<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?e6d1f421bbc9962127a50488f9ed37d1";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="Back to Top"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
 </html>
