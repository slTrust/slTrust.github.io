
 <!DOCTYPE HTML>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
  
    <title>Almost</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Stevin">
    

    
    <meta property="og:type" content="website">
<meta property="og:title" content="Almost">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Almost">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Almost">

    
    <link rel="alternative" href="/atom.xml" title="Almost" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
</head>
</html>
  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="Almost" title="Almost"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Almost">Almost</a></h1>
				<h2 class="blog-motto"></h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="Menu">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="Search" />
						<input type="hidden" name="q" value="site:yoursite.com">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main">

   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2020/03/14/Node全解10-01child-process/" title="Node全解10_01child_process" itemprop="url">Node全解10_01child_process</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Stevin" target="_blank" itemprop="author">Stevin</a>
		
  <p class="article-time">
    <time datetime="2020-03-13T16:06:43.000Z" itemprop="datePublished"> Published 2020-03-14</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="child-process-子进程"><a href="#child-process-子进程" class="headerlink" title="child_process 子进程"></a>child_process 子进程</h1><h3 id="进程Process"><a href="#进程Process" class="headerlink" title="进程Process"></a>进程Process</h3><blockquote>
<p>场景</p>
</blockquote>
<ul>
<li>notepad.exe是一个程序，不是进程</li>
<li>双击 notepad.exe时，操作系统开启了一个进程</li>
</ul>
<blockquote>
<p>定义</p>
</blockquote>
<ul>
<li>进程是程序的执行实例</li>
<li>程序在CPU上执行时的活动叫做进程</li>
<li>实际上并没有明确的定义，只有一些规则</li>
</ul>
<blockquote>
<p>特点</p>
</blockquote>
<ul>
<li>一个进程可以创建另一个进程(父进程和子进程)</li>
<li>通过任务管理器可以查看到进程</li>
</ul>
<h3 id="了解-CPU"><a href="#了解-CPU" class="headerlink" title="了解 CPU"></a>了解 CPU</h3><blockquote>
<p>特点</p>
</blockquote>
<ul>
<li>一个单核CPU,在一个时刻，只能做一件事</li>
<li>那么如何让用户同时看电影，听歌，写代码呢？</li>
<li>答案是在不同进程中快速切换</li>
</ul>
<blockquote>
<p>多进程并发执行</p>
</blockquote>
<ul>
<li>指多个程序在宏观上并行，微观上串行</li>
<li>每个进程会出现 “执行-暂停-执行”的规律</li>
<li>多个进程之前会出现抢资源(如打印机)的现象</li>
</ul>
<h3 id="阻塞"><a href="#阻塞" class="headerlink" title="阻塞"></a>阻塞</h3><p><strong>等待执行的进程中</strong></p>
<ul>
<li>都是非运行态</li>
<li>一些(A)在等待 CPU资源</li>
<li>另一些(B)在等待 I/O完成 (如文件读取)</li>
<li>如果这个时候把 CPU分配给 B 进程， B还是在等 I/O</li>
<li>我们把这个 B 叫做阻塞进程</li>
<li>因此，分派程序只会把 CPU 分配给非阻塞进程</li>
</ul>
<h3 id="进程三个状态"><a href="#进程三个状态" class="headerlink" title="进程三个状态"></a>进程三个状态</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">就绪     ==》    运行 </span><br><span class="line">｜               ｜  </span><br><span class="line">《==    阻塞    《==</span><br></pre></td></tr></table></figure>
<h3 id="线程-Thread-引入"><a href="#线程-Thread-引入" class="headerlink" title="线程 Thread 引入"></a>线程 Thread 引入</h3><ul>
<li>以前： 面向进程设计的系统中，进程是程序的基本执行实体</li>
<li>后来： 面向线程设计的系统中，进程本身不是基本运行单位，而是线程的容器</li>
</ul>
<blockquote>
<p>引入原因</p>
</blockquote>
<ul>
<li>进程是执行的基本实体，也是资源分配的基本实体</li>
<li>导致进程的创建、切换、销毁太消耗CPU时间了</li>
<li>于是引入了线程，线程作为执行的基本实体</li>
<li>而进程作为资源分配的基本实例</li>
</ul>
<h3 id="线程-Thread"><a href="#线程-Thread" class="headerlink" title="线程 Thread"></a>线程 Thread</h3><ul>
<li>最新的操作系统里：线程才是CPU调度和执行的最小单元</li>
<li>一个进程中至少有一个线程，可以有多个线程</li>
<li>一个进程中的线程共享该进程的所有资源</li>
<li>进程的第一个线程叫做初始化线程</li>
<li>线程的调度可以由操作系统负责，也可以由用户自己负责</li>
</ul>
<blockquote>
<p>举例</p>
</blockquote>
<ul>
<li>浏览器进程有渲染引擎、V8引擎、存储模块、网络模块、用户界面模块等</li>
<li>每个模块都可以放在一个线程里</li>
</ul>
<blockquote>
<p>分析</p>
</blockquote>
<ul>
<li>子进程 VS 线程<ul>
<li>优先使用 线程</li>
</ul>
</li>
</ul>
<h3 id="child-process"><a href="#child-process" class="headerlink" title="child_process"></a>child_process</h3><p>Node.js操作子进程</p>
<blockquote>
<p>使用目的</p>
</blockquote>
<ul>
<li>子进程的运行结果存储在系统缓存之中(最大200KB)</li>
<li>等到子进程运行结束之后，主进程再用回调函数读取子进程的运行结果</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">const child_process = require(&apos;child_process&apos;);</span><br><span class="line"></span><br><span class="line">const &#123; exec &#125; = child_process;</span><br><span class="line"></span><br><span class="line">exec(&apos;ls&apos;, (error, stdout, stderr) =&gt; &#123;</span><br><span class="line">    console.log(error);</span><br><span class="line">    console.log(stdout);</span><br><span class="line">    console.log(stderr);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="exec-API"><a href="#exec-API" class="headerlink" title="exec API"></a>exec API</h4><blockquote>
<p>exec(cmd,options,fn)</p>
</blockquote>
<ul>
<li>execute 的缩写，用于执行 bash命令</li>
<li>同步版本：execSync</li>
</ul>
<blockquote>
<p>流</p>
</blockquote>
<ul>
<li>返回一个流</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">const streams = exec(&apos;ls&apos;);</span><br><span class="line">// 不用回调 用事件</span><br><span class="line">streams.stdout.on(&apos;data&apos;, (chunk) =&gt; &#123;</span><br><span class="line">    console.log(chunk)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Promise</p>
</blockquote>
<ul>
<li>可以使其 Promise 化(util.promisify)</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">const util = require(&apos;util&apos;);</span><br><span class="line">const child_process = require(&apos;child_process&apos;);</span><br><span class="line">const &#123; exec &#125; = child_process;</span><br><span class="line"></span><br><span class="line">const exec2 = util.promisify(exec);</span><br><span class="line"></span><br><span class="line">exec2(&apos;ls&apos;).then((data) =&gt; &#123;</span><br><span class="line">    console.log(data.stdout);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>有漏洞</p>
</blockquote>
<ul>
<li>如果cmd 被注入了，可能执行意外的代码</li>
<li>推荐使用 execFile</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// 类似 sql 那种 “;” 结束上一个命令 然后注入它的命令</span><br><span class="line">exec(&apos;ls; pwd&apos;, (error, stdout, stderr) =&gt; &#123;</span><br><span class="line">    console.log(error);</span><br><span class="line">    console.log(stdout);</span><br><span class="line">    console.log(stderr);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><strong>推荐使用 execFile 而不是 exec</strong></p>
<h4 id="execFile-API"><a href="#execFile-API" class="headerlink" title="execFile API"></a>execFile API</h4><ul>
<li>执行特定的程序</li>
<li>命令行参数用数组的形式传入，无法注入</li>
<li>同步版本： execFileSync</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">const child_process = require(&apos;child_process&apos;);</span><br><span class="line"></span><br><span class="line">const &#123; execFile &#125; = child_process;</span><br><span class="line"></span><br><span class="line">const user_input = &apos;. &amp;&amp; pwd&apos;;</span><br><span class="line"></span><br><span class="line">execFile(&apos;ls&apos;, [&apos;-la&apos;, user_input], (error, stdout, stderr) =&gt; &#123;</span><br><span class="line">    console.log(error);</span><br><span class="line">    console.log(stdout);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<ul>
<li>同样也支持流</li>
</ul>
<blockquote>
<h4 id="options-参数"><a href="#options-参数" class="headerlink" title="options 参数"></a>options 参数</h4></blockquote>
<ul>
<li>cwd</li>
<li>env</li>
<li>shell</li>
<li>maxBuffer 最大缓存 默认 1024*1024 字节</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">const child_process = require(&apos;child_process&apos;);</span><br><span class="line"></span><br><span class="line">const &#123; execFile &#125; = child_process;</span><br><span class="line"></span><br><span class="line">execFile(&apos;ls&apos;, [&apos;-la&apos;], &#123;</span><br><span class="line">    cwd: &apos;/&apos;, // 当前命令执行的工作目录</span><br><span class="line">    env: &#123; NODE_ENV: &apos;development&apos; &#125;,// 环境变量</span><br><span class="line">    maxBuffer: 1024 * 1024,// 设置最大缓存</span><br><span class="line">    // shell:  设置用什么 shell</span><br><span class="line">&#125;, (error, stdout) =&gt; &#123;</span><br><span class="line">    console.log(error)</span><br><span class="line">    console.log(stdout)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="spawn"><a href="#spawn" class="headerlink" title="spawn"></a>spawn</h3><ul>
<li>用法跟 execFile 几乎一样</li>
<li>没有回调函数，只能通过流事件获取结果</li>
<li>没有最大 200KB 的限制(因为是流)</li>
</ul>
<blockquote>
<p>经验</p>
</blockquote>
<ul>
<li>能用 spawn 的时候就不要用 execFile</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">const child_process = require(&apos;child_process&apos;);</span><br><span class="line">const &#123; spawn &#125; = child_process;</span><br><span class="line"></span><br><span class="line">const streams = spawn(&apos;ls&apos;, [&apos;-la&apos;], &#123;</span><br><span class="line">    cwd: &apos;/&apos;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">streams.stdout.on(&apos;data&apos;, (chunk) =&gt; &#123;</span><br><span class="line">    console.log(chunk.toString())</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="fork"><a href="#fork" class="headerlink" title="fork"></a>fork</h3><ul>
<li>创建一个子进程，执行Node脚本</li>
<li>fork(‘./child.js’) 相当于 <code>spawn(&#39;node&#39;,[&#39;./child.js&#39;])</code></li>
</ul>
<blockquote>
<p>特点</p>
</blockquote>
<ul>
<li>会多出一个 message 事件，用于父子通信</li>
<li>会多出一个 send 方法</li>
</ul>
<p>父.js</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">const child_process = require(&apos;child_process&apos;);</span><br><span class="line"></span><br><span class="line">var n = child_process.fork(&apos;./child.js&apos;);</span><br><span class="line">n.on(&apos;message&apos;, function (m) &#123;</span><br><span class="line">    console.log(&apos;父进程得到了值:&apos;, m);</span><br><span class="line">&#125;);</span><br><span class="line">n.send(&#123; hello: &apos;world&apos; &#125;);</span><br></pre></td></tr></table></figure>
<p>child.js</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">setTimeout(() =&gt; &#123;</span><br><span class="line">    process.send(&#123; foo: &apos;bar&apos; &#125;);</span><br><span class="line">&#125;, 2000);</span><br><span class="line"></span><br><span class="line">process.on(&apos;message&apos;, function (m) &#123;</span><br><span class="line">    console.log(&apos;子进程得到消息:&apos;, m);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="操作线程"><a href="#操作线程" class="headerlink" title="操作线程"></a>操作线程</h3><blockquote>
<h4 id="一些历史"><a href="#一些历史" class="headerlink" title="一些历史"></a>一些历史</h4></blockquote>
<ul>
<li>child_process.exec<ul>
<li>v0.1.90 加入 Node.js</li>
</ul>
</li>
<li>new Worker<ul>
<li>v10.5.0 加入 Node.js</li>
<li>v11.7.0 之前需要 –experimental-worker开启</li>
</ul>
</li>
<li>这个线程API太新了<ul>
<li>所以我们应该不会经常用到</li>
</ul>
</li>
<li>效率<ul>
<li>目前效率并不算很高， <a href="https://nodejs.org/api/worker_threads.html#worker_threads_worker_threads" target="_blank" rel="noopener">文档</a><a href="http://nodejs.cn/api/worker_threads.html#worker_threads_worker_threads" target="_blank" rel="noopener">中文</a> 自己都写了</li>
</ul>
</li>
</ul>
<h4 id="worker-threads-API"><a href="#worker-threads-API" class="headerlink" title="worker_threads API"></a>worker_threads API</h4><ul>
<li>isMainThread</li>
<li>new Worker(filename)</li>
<li><p><a href="http://nodejs.cn/api/worker_threads.html#worker_threads_worker_parentport" target="_blank" rel="noopener">parentPort 线程间通信</a></p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">const &#123; Worker, isMainThread, parentPort &#125; = require(&apos;worker_threads&apos;);</span><br><span class="line"></span><br><span class="line">if (isMainThread) &#123;</span><br><span class="line">    const worker = new Worker(__filename);</span><br><span class="line">    worker.once(&apos;message&apos;, (message) =&gt; &#123;</span><br><span class="line">        console.log(message);  // Prints &apos;Hello, world!&apos;.</span><br><span class="line">    &#125;);</span><br><span class="line">    worker.postMessage(&apos;Hello, world!&apos;);</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    // When a message from the parent thread is received, send it back:</span><br><span class="line">    parentPort.once(&apos;message&apos;, (message) =&gt; &#123;</span><br><span class="line">        parentPort.postMessage(message);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>postMessage</p>
</li>
</ul>
<blockquote>
<p>事件列表</p>
</blockquote>
<ul>
<li>message</li>
<li>exit</li>
</ul>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li>如果你对进程，线程感兴趣推荐学习任意一本关于操作系统的教科书</li>
<li><a href="https://github.com/slTrust/node-child_process" target="_blank" rel="noopener">代码仓库</a></li>
</ul>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/Node后端/">Node后端</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2020/03/13/Node全解09-02Stream自定义/" title="Node全解09_02Stream自定义" itemprop="url">Node全解09_02Stream自定义</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Stevin" target="_blank" itemprop="author">Stevin</a>
		
  <p class="article-time">
    <time datetime="2020-03-13T12:05:52.000Z" itemprop="datePublished"> Published 2020-03-13</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="自定义Stream"><a href="#自定义Stream" class="headerlink" title="自定义Stream"></a>自定义Stream</h1><h3 id="Writable-Stream"><a href="#Writable-Stream" class="headerlink" title="Writable Stream"></a>Writable Stream</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">const &#123; Writable &#125; = require(&quot;stream&quot;);</span><br><span class="line"></span><br><span class="line">const outStream = new Writable(&#123;</span><br><span class="line">    write(chunk, encoding, callback) &#123;</span><br><span class="line">        console.log(chunk.toString());</span><br><span class="line">        callback();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">// process.stdin 就是标准输入</span><br><span class="line">process.stdin.pipe(outStream);</span><br></pre></td></tr></table></figure>
<h3 id="Readable-Stream"><a href="#Readable-Stream" class="headerlink" title="Readable Stream"></a>Readable Stream</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">const &#123; Readable &#125; = require(&apos;stream&apos;)</span><br><span class="line"></span><br><span class="line">const inStream = new Readable()</span><br><span class="line"></span><br><span class="line">inStream.push(&apos;ABCDEFGHIJKLM&apos;)</span><br><span class="line">inStream.push(&apos;NOPQRSTUVWXYZ&apos;)</span><br><span class="line"></span><br><span class="line">inStream.push(null) // No more data</span><br><span class="line"></span><br><span class="line">inStream.on(&apos;data&apos;, (chunk) =&gt; &#123;</span><br><span class="line">    process.stdout.write(chunk)</span><br><span class="line">    console.log(&apos;写数据了&apos;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">// 把所有数据都 push进去了 然后在 pipe</span><br></pre></td></tr></table></figure>
<blockquote>
<p>对方调用 read 我们才提供数据</p>
</blockquote>
<ul>
<li>如果你想创建一个可读的流应该是 等别人 read在推 而不是上面 那样提前push好</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">const &#123; Readable &#125; = require(&quot;stream&quot;);</span><br><span class="line"></span><br><span class="line">const inStream = new Readable(&#123;</span><br><span class="line">  read(size) &#123;</span><br><span class="line">    const char = String.fromCharCode(this.currentCharCode++)</span><br><span class="line">    this.push(char);</span><br><span class="line">    console.log(`推了 $&#123;char&#125;`)</span><br><span class="line">    if (this.currentCharCode &gt; 90) &#123; // Z</span><br><span class="line">      this.push(null);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">inStream.currentCharCode = 65 // A</span><br><span class="line"></span><br><span class="line">inStream.pipe(process.stdout)</span><br></pre></td></tr></table></figure>
<h3 id="Duplex-流"><a href="#Duplex-流" class="headerlink" title="Duplex 流"></a>Duplex 流</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">const &#123; Duplex &#125; = require(&quot;stream&quot;);</span><br><span class="line">const inoutStream = new Duplex(&#123;</span><br><span class="line">    write(chunk, encoding, callback) &#123;</span><br><span class="line">    console.log(chunk.toString());</span><br><span class="line">    callback();</span><br><span class="line">&#125;,</span><br><span class="line">read(size) &#123;</span><br><span class="line">    this.push(String.fromCharCode(this.currentCharCode++));</span><br><span class="line">        if (this.currentCharCode &gt; 90) &#123;</span><br><span class="line">            this.push(null);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">inoutStream.currentCharCode = 65;</span><br><span class="line">process.stdin.pipe(inoutStream).pipe(process.stdout);</span><br></pre></td></tr></table></figure>
<h3 id="Transform"><a href="#Transform" class="headerlink" title="Transform"></a>Transform</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">const &#123; Transform &#125; = require(&quot;stream&quot;);</span><br><span class="line">const upperCaseTr = new Transform(&#123;</span><br><span class="line">    transform(chunk, encoding, callback) &#123;</span><br><span class="line">    this.push(chunk.toString().toUpperCase());</span><br><span class="line">    callback();</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line">process.stdin.pipe(upperCaseTr).pipe(process.stdout);</span><br></pre></td></tr></table></figure>
<h3 id="内置的-Transform-Stream"><a href="#内置的-Transform-Stream" class="headerlink" title="内置的 Transform Stream"></a>内置的 Transform Stream</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">const fs = require(&quot;fs&quot;);</span><br><span class="line">const zlib = require(&quot;zlib&quot;);</span><br><span class="line">const file = process.argv[2]; // 文件路径</span><br><span class="line"></span><br><span class="line">fs.createReadStream(file) // 创建流 一点一点的读</span><br><span class="line">    .pipe(zlib.createGzip()) // 每次读就传给 gzip 压缩</span><br><span class="line">    .pipe(fs.createWriteStream(file + &quot;.gz&quot;)); // 将压缩后的 gzip流 传给一个可写的流</span><br></pre></td></tr></table></figure>
<blockquote>
<p>加密 / 压缩 / 打印进入 / 完成提示</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">const fs = require(&quot;fs&quot;);</span><br><span class="line">const zlib = require(&quot;zlib&quot;);</span><br><span class="line">const file = process.argv[2];</span><br><span class="line">const crypto = require(&quot;crypto&quot;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">const &#123; Transform &#125; = require(&quot;stream&quot;);</span><br><span class="line"></span><br><span class="line">const reportProgress = new Transform(&#123;</span><br><span class="line">    transform(chunk, encoding, callback) &#123;</span><br><span class="line">        process.stdout.write(&quot;.&quot;);</span><br><span class="line">        callback(null, chunk);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">fs.createReadStream(file)</span><br><span class="line">    .pipe(crypto.createCipher(&quot;aes192&quot;, &quot;123456&quot;)) // 加密</span><br><span class="line">    .pipe(zlib.createGzip()) // 压缩</span><br><span class="line">    .pipe(reportProgress) // 变换流 每次传入数据打一个点</span><br><span class="line">    .pipe(fs.createWriteStream(file + &quot;.gz&quot;))</span><br><span class="line">    .on(&quot;finish&quot;, () =&gt; console.log(&quot;Done&quot;)); // 完成后的后续</span><br><span class="line"></span><br><span class="line">// 注意调用顺序</span><br><span class="line">// 一定要 先加密 在 gzip 反之无法打开文件</span><br></pre></td></tr></table></figure>
<h3 id="Stream-的用途在-Node-js-里应用非常广泛"><a href="#Stream-的用途在-Node-js-里应用非常广泛" class="headerlink" title="Stream 的用途在 Node.js 里应用非常广泛"></a>Stream 的用途在 Node.js 里应用非常广泛</h3><blockquote>
<p>Readable Stream</p>
</blockquote>
<ul>
<li>HTTP Response</li>
<li>HTTP Request</li>
<li>fs read stream</li>
<li>zlib stream</li>
<li>TCP sockets</li>
<li>child process stdout &amp; stderr</li>
<li>process.stdin</li>
<li>其他</li>
</ul>
<blockquote>
<p>Writable Stream</p>
</blockquote>
<ul>
<li>HTTP Response</li>
<li>HTTP Request</li>
<li>fs write stream</li>
<li>zlib stream</li>
<li>TCP sockets</li>
<li>child process stdin</li>
<li>process.stdout, process.stderr</li>
<li>其他</li>
</ul>
<h3 id="数据流的积压问题-Back-Pressure"><a href="#数据流的积压问题-Back-Pressure" class="headerlink" title="数据流的积压问题 Back Pressure"></a>数据流的积压问题 Back Pressure</h3><p><strong>一定要看</strong></p>
<ul>
<li><a href="https://nodejs.org/zh-cn/docs/guides/backpressuring-in-streams/" target="_blank" rel="noopener">https://nodejs.org/zh-cn/docs/guides/backpressuring-in-streams/</a></li>
</ul>
<h3 id="highWaterMark-是干什么的？"><a href="#highWaterMark-是干什么的？" class="headerlink" title="highWaterMark 是干什么的？"></a>highWaterMark 是干什么的？</h3><ul>
<li><a href="http://nodejs.cn/api/stream.html#stream_buffering" target="_blank" rel="noopener">http://nodejs.cn/api/stream.html#stream_buffering</a></li>
</ul>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="https://jscomplete.com/learn/node-beyond-basics/node-streams" target="_blank" rel="noopener">Node’s Stream英文版</a></li>
</ul>
<blockquote>
<p>Node.js Stream 文档</p>
</blockquote>
<ul>
<li><a href="https://nodejs.org/api/stream.html" target="_blank" rel="noopener">英文</a></li>
<li><a href="http://nodejs.cn/api/stream.html" target="_blank" rel="noopener">中文</a></li>
</ul>
<blockquote>
<p>面试题</p>
</blockquote>
<ul>
<li><a href="https://juejin.im/post/5b421b5ee51d45198651159b" target="_blank" rel="noopener">面试高级前端工程师必问之流-stream</a></li>
</ul>
<blockquote>
<p>例子代码仓库</p>
</blockquote>
<ul>
<li><a href="https://github.com/slTrust/node-stream" target="_blank" rel="noopener">https://github.com/slTrust/node-stream</a></li>
</ul>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/Node后端/">Node后端</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2020/03/13/Node全解09-01stream/" title="Node全解09_01stream" itemprop="url">Node全解09_01stream</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Stevin" target="_blank" itemprop="author">Stevin</a>
		
  <p class="article-time">
    <time datetime="2020-03-13T00:05:20.000Z" itemprop="datePublished"> Published 2020-03-13</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="Stream"><a href="#Stream" class="headerlink" title="Stream"></a>Stream</h1><h3 id="第一个-Stream-例子"><a href="#第一个-Stream-例子" class="headerlink" title="第一个 Stream 例子"></a>第一个 Stream 例子</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">const fs = require(&apos;fs&apos;)</span><br><span class="line">const stream = fs.createWriteStream(&apos;./big_file.txt&apos;)</span><br><span class="line">for (let i = 0; i &lt; 1000000; i++) &#123;</span><br><span class="line">    stream.write(`这是第$&#123;i&#125;行内容，我们需要很多内容，要不停的写文件啊啊啊啊啊啊啊回车\n`)</span><br><span class="line">&#125;</span><br><span class="line">stream.end() // 别忘了关闭 stream</span><br><span class="line">console.log(&apos;done&apos;)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>分析</p>
</blockquote>
<ul>
<li>打开流，多次往里面塞内容，关闭流</li>
<li>看起来就是可以写多次嘛，没什么大不了</li>
<li>最终我们得到一个 100M 左右的文件</li>
</ul>
<blockquote>
<p>释义</p>
</blockquote>
<ul>
<li>stream 是流，但默认没有水，</li>
<li>stream.write 可以让水流中有水(数据)</li>
<li>每次写的小数据叫做 chunk (块)</li>
<li>产生数据的一段叫做 source (源头)</li>
<li>得到数据的一段叫做 sink (水池)  上面例子的水池就是big_file.txt</li>
</ul>
<h3 id="第二个-stream-例子"><a href="#第二个-stream-例子" class="headerlink" title="第二个 stream 例子"></a>第二个 stream 例子</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">const fs = require(&apos;fs&apos;);</span><br><span class="line">const http = require(&apos;http&apos;);</span><br><span class="line">const server = http.createServer()</span><br><span class="line">server.on(&apos;request&apos;, (request, response) =&gt; &#123;</span><br><span class="line">    fs.readFile(&apos;./big_file.txt&apos;, (error,</span><br><span class="line">        data) =&gt; &#123;</span><br><span class="line">        if (error) throw error</span><br><span class="line">        response.end(data)</span><br><span class="line">        console.log(&apos;done&apos;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line">server.listen(8888)</span><br><span class="line">console.log(8888)</span><br></pre></td></tr></table></figure>
<p><strong>运行这个例子</strong> 并在浏览器打开 <a href="http://localhost:8888/" target="_blank" rel="noopener">http://localhost:8888/</a></p>
<p><strong>打开活动监视器 / 任务管理器 搜索 node</strong> 查看内存占用 一下飙升到110M左右</p>
<blockquote>
<p>这个例子的结论</p>
</blockquote>
<ul>
<li>如果用户请求过来，由于big_file.txt 的大小是 100M左右，再加上 Node.js 本身占用的几兆，所以Node.js 总体占用的内存是 110兆内存</li>
<li>一个用户占用 100M左右 10个呢？ 服务器内存是不是就不够用了</li>
</ul>
<h3 id="第三个例子"><a href="#第三个例子" class="headerlink" title="第三个例子"></a>第三个例子</h3><p>用 stream 改写</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">const fs = require(&apos;fs&apos;);</span><br><span class="line">const http = require(&apos;http&apos;);</span><br><span class="line">const server = http.createServer()</span><br><span class="line">server.on(&apos;request&apos;, (request, response) =&gt; &#123;</span><br><span class="line">    const stream =</span><br><span class="line">        fs.createReadStream(&apos;./big_file.txt&apos;)</span><br><span class="line">    stream.pipe(response)</span><br><span class="line">&#125;)</span><br><span class="line">server.listen(8888)</span><br></pre></td></tr></table></figure>
<ul>
<li>查看 Node.js 内存占用，基本不会超过 30MB</li>
<li>文件 steam 和 response stream 是通过管道相连的</li>
<li><strong>流 可以使你的内存降的非常低</strong></li>
</ul>
<h4 id="管道-Pipe"><a href="#管道-Pipe" class="headerlink" title="管道 Pipe"></a>管道 Pipe</h4><p>两个流可以用一个管道相连<br>stream1 的末尾接上 stream2 的开端<br>只要 stream1 有数据，就会流到 stream2</p>
<blockquote>
<p>常用代码</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stream1.pipe(stream2)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>链式调用</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">a.pipe(b).pipe(c)</span><br><span class="line"></span><br><span class="line">// 等价于</span><br><span class="line">a.pipe(b)</span><br><span class="line">b.pipe(c)</span><br></pre></td></tr></table></figure>
<blockquote>
<h4 id="管道可以通过事件实现"><a href="#管道可以通过事件实现" class="headerlink" title="管道可以通过事件实现"></a>管道可以通过事件实现</h4></blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// stream1 一有数据就塞给 stream2</span><br><span class="line">stream1.on(&apos;data&apos;, (chunk)=&gt;&#123;</span><br><span class="line">    stream2.write(chunk)</span><br><span class="line">&#125;)</span><br><span class="line">// stream1 停了 ，就停了 stream2</span><br><span class="line">stream1.on(&apos;end&apos;, ()=&gt;&#123;</span><br><span class="line">    stream2.end()</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="Stream-对象的原型链"><a href="#Stream-对象的原型链" class="headerlink" title="Stream 对象的原型链"></a>Stream 对象的原型链</h3><p><code>s = fs.createReadStream(path)</code></p>
<ul>
<li>那么它的对象层级为</li>
<li>自身属性(fs.createReadStream 构造)</li>
<li>原型： stream.Readable.prototype</li>
<li>二级原型： stream.Stream.prototype</li>
<li>三级原型： events.EventEmitter.prototype</li>
<li>四级原型： Object.prototype</li>
</ul>
<p><strong>Stream对象 都继承了 EventEmitter</strong></p>
<blockquote>
<p>如何查看它的原型</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">const fs = require(&apos;fs&apos;);</span><br><span class="line">const stream = require(&apos;stream&apos;);</span><br><span class="line">const events = require(&apos;events&apos;);</span><br><span class="line">const s = fs.createReadStream(&apos;./big_file.txt&apos;)</span><br><span class="line"></span><br><span class="line">console.log(s)</span><br><span class="line"></span><br><span class="line">console.log(stream.Readable.prototype);</span><br><span class="line"></span><br><span class="line">console.log(events.EventEmitter.prototype);</span><br><span class="line"></span><br><span class="line">// 运行技巧</span><br><span class="line">node --inspect-brk xxx.js</span><br><span class="line">// 打开浏览器 点击 step over</span><br></pre></td></tr></table></figure>
<h3 id="支持的事件和方法"><a href="#支持的事件和方法" class="headerlink" title="支持的事件和方法"></a>支持的事件和方法</h3><h4 id="Readable-Stream"><a href="#Readable-Stream" class="headerlink" title="Readable Stream"></a>Readable Stream</h4><blockquote>
<p>事件</p>
</blockquote>
<ul>
<li><strong>data,end</strong></li>
<li>error,close,readable</li>
</ul>
<blockquote>
<p>方法</p>
</blockquote>
<ul>
<li><strong>pipe()</strong></li>
<li>unpipe()</li>
<li>wrap()</li>
<li>destroy()</li>
<li>read()</li>
<li>unshift()</li>
<li>resume() / pause() </li>
<li>isPaused()</li>
<li>setEncoding()</li>
</ul>
<h4 id="Writeable-Stream"><a href="#Writeable-Stream" class="headerlink" title="Writeable Stream"></a>Writeable Stream</h4><blockquote>
<p>事件 </p>
</blockquote>
<ul>
<li><p><strong>drain</strong> 面试爱问</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">// 假设 stream1 开始 一秒写 10M数据 后来 stream1 一秒写 1000M数据</span><br><span class="line">// 这样就会堵车 ， 所有有了 drain 不堵车了</span><br><span class="line">stream1.on(&apos;data&apos;, (chunk)=&gt;&#123;</span><br><span class="line">    const flag = stream2.write(chunk)</span><br><span class="line">    if(flag === false)&#123;</span><br><span class="line">        // done write  堵车了，你别写了</span><br><span class="line">    &#125;</span><br><span class="line">    // 不堵车了</span><br><span class="line">    stream2.on(&apos;drain&apos;,()=&gt;&#123;</span><br><span class="line">        // go on write</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">&#125;)</span><br><span class="line">// stream1 停了 ，就停了 stream2</span><br><span class="line">stream1.on(&apos;end&apos;, ()=&gt;&#123;</span><br><span class="line">    stream2.end()</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>finish</strong></p>
</li>
<li>error,close,pipe,unpipe</li>
</ul>
<blockquote>
<p>方法</p>
</blockquote>
<ul>
<li><code>write(),destroy(),end(),cork(),uncork(),setDefaultcoding()</code></li>
</ul>
<h3 id="Stream-分类"><a href="#Stream-分类" class="headerlink" title="Stream 分类"></a>Stream 分类</h3><ul>
<li>Readable 可读</li>
<li>Writeable 可写</li>
<li>Duplex 可读可写(双向) 同时读和写，注意 其实就是两个管道 但是两个管道没有交叉点</li>
<li>Transform 可读可写(变化) <code>例子 webpack  你写的是ES6 读到的是 ES5</code></li>
</ul>
<h3 id="Readable-Stream-1"><a href="#Readable-Stream-1" class="headerlink" title="Readable Stream"></a>Readable Stream</h3><p><strong>静止态 paused 和 流动态 flowing</strong></p>
<ul>
<li>默认处于 paused 态</li>
<li>添加 data 事件监听，它就变成 flowing</li>
<li>删掉 data 事件监听， 它就变成 paused</li>
<li>paused() 可以让它 变为 paused</li>
<li>resume() 可以让它 变为 flowing</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">const fs = require(&apos;fs&apos;);</span><br><span class="line">const stream = fs.createReadStream(&apos;./big_file.txt&apos;)</span><br><span class="line">stream.pipe(response)</span><br><span class="line">stream.pause();</span><br><span class="line">setTimeout(()=&gt;&#123;</span><br><span class="line">    stream.resume</span><br><span class="line">&#125;,3000)</span><br></pre></td></tr></table></figure>
<h3 id="Writeable-Stream-1"><a href="#Writeable-Stream-1" class="headerlink" title="Writeable Stream"></a>Writeable Stream</h3><h4 id="drain-流干了事件"><a href="#drain-流干了事件" class="headerlink" title="drain 流干了事件"></a>drain 流干了事件</h4><ul>
<li>表示可以加水了</li>
<li>我们调用 stream.write(chunk)的时候，可能会得到 false</li>
<li>false 代表写的太快了，数据积压了</li>
<li>这个时候不能在 write 了，要监听 drain</li>
<li>等 drain 事件触发了，才能继续 write</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">const fs = require(&apos;fs&apos;)</span><br><span class="line"></span><br><span class="line">function writeOneMillionTimes(writer, data) &#123;</span><br><span class="line">    let i = 1000000</span><br><span class="line">    write()</span><br><span class="line"></span><br><span class="line">    function write() &#123;</span><br><span class="line">        let ok = true</span><br><span class="line">        do &#123;</span><br><span class="line">            i--</span><br><span class="line">            if (i === 0) &#123;</span><br><span class="line">                // Last time!</span><br><span class="line">                writer.write(data)</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                // See if we should continue, or wait.</span><br><span class="line">                // Don&apos;t pass the callback, because we&apos;re not done yet.</span><br><span class="line">                ok = writer.write(data)</span><br><span class="line">                if (ok === false) &#123;</span><br><span class="line">                    console.log(&apos;不能再写了&apos;)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; while (i &gt; 0 &amp;&amp; ok)</span><br><span class="line">        if (i &gt; 0) &#123;</span><br><span class="line">            // Had to stop early!</span><br><span class="line">            // Write some more once it drains.</span><br><span class="line">            writer.once(&apos;drain&apos;, () =&gt; &#123;</span><br><span class="line">                console.log(&apos;干涸了&apos;)</span><br><span class="line">                write()</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const writer = fs.createWriteStream(&apos;./big_file.txt&apos;)</span><br><span class="line">writeOneMillionTimes(writer, &apos;hello world&apos;)</span><br></pre></td></tr></table></figure>
<h4 id="finish-事件"><a href="#finish-事件" class="headerlink" title="finish 事件"></a>finish 事件</h4><ul>
<li>调用 steam.end() 之后 而且</li>
<li>缓冲区数据已经传给底层系统之后</li>
<li>触发 finish 事件</li>
</ul>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/Node后端/">Node后端</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2020/03/12/Node全解08-01sql进阶/" title="Node全解08_01sql进阶" itemprop="url">Node全解08_01sql进阶</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Stevin" target="_blank" itemprop="author">Stevin</a>
		
  <p class="article-time">
    <time datetime="2020-03-12T14:04:12.000Z" itemprop="datePublished"> Published 2020-03-12</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="sql进阶"><a href="#sql进阶" class="headerlink" title="sql进阶"></a>sql进阶</h1><h3 id="sql-必会的内容"><a href="#sql-必会的内容" class="headerlink" title="sql 必会的内容"></a>sql 必会的内容</h3><ul>
<li><a href="https://sltrust.github.io/2019/06/11/Java-025-sql%E8%BF%9B%E9%98%B6/" target="_blank" rel="noopener">sql进阶</a></li>
<li><a href="https://sltrust.github.io/2019/06/11/Java-026-sql%E8%8C%83%E5%BC%8F/" target="_blank" rel="noopener">三大范式</a></li>
<li><a href="https://sltrust.github.io/2019/06/13/Java-028-%E8%B4%AD%E7%89%A9%E8%BD%A6%E5%AE%9E%E4%BE%8B/" target="_blank" rel="noopener">一对一 一对多 多对多关系</a></li>
<li><a href="https://sltrust.github.io/tags/mysql/" target="_blank" rel="noopener">mysql入门</a></li>
</ul>
<h3 id="缓存字段"><a href="#缓存字段" class="headerlink" title="缓存字段"></a>缓存字段</h3><p>假设一个博客包含多个评论 comments</p>
<blockquote>
<p>如何获取评论数</p>
</blockquote>
<ul>
<li>select count(id)form comments where blob_id = 9 这样太慢了</li>
<li>可以在 blob 表添加一个 comment_count 字段</li>
<li>每次添加 comment 则 +1</li>
<li>每次删除 comment 则 -1</li>
</ul>
<h3 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">start transaction;</span><br><span class="line">语句1;语句2;语句3；</span><br><span class="line">commit;</span><br></pre></td></tr></table></figure>
<p>只要一句出错，则全部不生效</p>
<h3 id="MySQL-存储引擎"><a href="#MySQL-存储引擎" class="headerlink" title="MySQL 存储引擎"></a>MySQL 存储引擎</h3><ul>
<li>SHOW ENGINEA;</li>
</ul>
<blockquote>
<p>常见的</p>
</blockquote>
<ul>
<li>InnoDB 默认</li>
<li>MyISAM 拥有较高的插入，查询速度 不支持事务</li>
<li>Memory 在内存中，快速访问数据</li>
<li>Archive 只支持 insert 和 select</li>
</ul>
<blockquote>
<p>InnoDB</p>
</blockquote>
<ul>
<li>它是事务型数据库的首选，支持事务，遵循ACID、支持行锁和外键</li>
</ul>
<h3 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h3><blockquote>
<p>语法</p>
</blockquote>
<ul>
<li>create unique index index1 on users(name(100)) <ul>
<li>唯一性的加 unique 反之去掉</li>
<li>users(name(100)) 表名(字段名(长度))</li>
</ul>
</li>
<li>show index in users;</li>
</ul>
<blockquote>
<p>用途</p>
</blockquote>
<ul>
<li>提交搜索效率</li>
<li>where xxx&gt;100 那么我们可以创建 xxx的索引</li>
<li>where xxx&gt;100 and yyy&gt;200 创建 xxx,yyy的索引</li>
</ul>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/Node后端/">Node后端</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2020/03/12/Node全解07-01docker-mysql/" title="Node全解07_01docker_mysql" itemprop="url">Node全解07_01docker_mysql</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Stevin" target="_blank" itemprop="author">Stevin</a>
		
  <p class="article-time">
    <time datetime="2020-03-12T00:03:29.000Z" itemprop="datePublished"> Published 2020-03-12</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h3 id="docker-启动-mysql"><a href="#docker-启动-mysql" class="headerlink" title="docker 启动 mysql"></a>docker 启动 mysql</h3><ul>
<li>docker 安装 不说了 自行解决</li>
<li>进入 Docker 上面的 mysql 主页</li>
<li>选择版本 如 5.7.27 或者 8.0.18</li>
<li>使用docker run 容器的名字</li>
<li>name 是容器的名字</li>
<li>MYSQL_ROOT_PASSWORD 是密码</li>
<li>tag是 版本号，我们选 5.7.27</li>
<li>再加一个端口映射 -p 3306:3306</li>
<li>最终命令</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker run --name mysql01 -e MYSQL_ROOT_PASSWORD=123456 -p 3306:3306 -d mysql:5.7.27</span><br><span class="line"></span><br><span class="line"># 查看容器</span><br><span class="line">docker ps -a</span><br><span class="line"># 删除容器</span><br><span class="line">docker rm -f id</span><br><span class="line"># 删除镜像</span><br><span class="line">docker rmi -f id</span><br></pre></td></tr></table></figure>
<p><strong>注意</strong></p>
<ul>
<li>docker启动的容器默认不会持久化</li>
<li>容器删掉了，数据就没了</li>
<li>如果需要持久化，自行搜索 [docker mysql 数据目录]</li>
<li>目前我们不需要持久化</li>
</ul>
<h4 id="连接-docker-mysql"><a href="#连接-docker-mysql" class="headerlink" title="连接 docker mysql"></a>连接 docker mysql</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it 镜像名称 bash</span><br><span class="line">这句话就是进入容器内部，容器内是一个 linux系统</span><br><span class="line">然后你就可以在这个系统里运行 mysql</span><br></pre></td></tr></table></figure>
<h4 id="mysql-命令"><a href="#mysql-命令" class="headerlink" title="mysql 命令"></a>mysql 命令</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p 回车 输入密码 123456</span><br><span class="line">命令 show databases; 可以查看所有的数据库</span><br><span class="line">如果你手抖就 ctrl + c 重新来</span><br><span class="line">命令 use xxx; 选择使用的数据库</span><br><span class="line">show tables; 查看对应库下的所有表</span><br><span class="line"></span><br><span class="line">select * from user; 查看表内容</span><br></pre></td></tr></table></figure>
<h3 id="什么是数据库"><a href="#什么是数据库" class="headerlink" title="什么是数据库"></a>什么是数据库</h3><p><strong>数据库Database</strong></p>
<ul>
<li>将大量数据保存起来，通过计算机加工而成的可以运行高效访问的数据集合称为数据库</li>
<li>根据保存格式不同，数据库一般分为<ul>
<li>关系型数据库 使用最广泛</li>
<li>面向对象数据库、xml数据库、键值对数据库、层次数据库</li>
</ul>
</li>
</ul>
<p><strong>数据库管理系统 DBMS</strong></p>
<ul>
<li>用来管理数据库的系统称之为数据库管理系统</li>
<li>如 MySQL 、PostgreSQL、SQL Server、DB2、Oracle</li>
</ul>
<h4 id="mysql-一个bug"><a href="#mysql-一个bug" class="headerlink" title="mysql 一个bug"></a>mysql 一个bug</h4><ul>
<li>mysql不要使用 utf-8 记住永远不要再 mysql里使用 utf-8 而是用 <strong>utf-8mb4</strong></li>
</ul>
<h3 id="Node-js-访问数据库"><a href="#Node-js-访问数据库" class="headerlink" title="Node.js 访问数据库"></a>Node.js 访问数据库</h3><ul>
<li><a href="https://github.com/mysqljs/mysql" target="_blank" rel="noopener">mysqljs</a> 里面是例子代码</li>
<li>新建目录 node-mysql</li>
<li>yarn init -y</li>
<li>抄文档 yarn add mysql</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">var mysql = require(&apos;mysql&apos;);</span><br><span class="line">var connection = mysql.createConnection(&#123;</span><br><span class="line">    host: &apos;localhost&apos;,</span><br><span class="line">    user: &apos;root&apos;,</span><br><span class="line">    password: &apos;123456&apos;,</span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">connection.connect();</span><br><span class="line">/*</span><br><span class="line">CREATE DATABASE IF NOT EXISTS fang </span><br><span class="line">    CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci</span><br><span class="line">*/</span><br><span class="line">// 创建库</span><br><span class="line">connection.query(&apos;CREATE DATABASE IF NOT EXISTS fang CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_520_ci;&apos;, function (error, results, fields) &#123;</span><br><span class="line">    if (error) throw error;</span><br><span class="line">    console.log(results);</span><br><span class="line">&#125;);</span><br><span class="line">connection.query(&apos;use fang;&apos;);</span><br><span class="line">// 创建表</span><br><span class="line">connection.query(`CREATE TABLE IF NOT EXISTS user(</span><br><span class="line">    name text,</span><br><span class="line">    age int</span><br><span class="line">)`, function (error, results, fields) &#123;</span><br><span class="line">    if (error) throw error;</span><br><span class="line">    console.log(results);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">connection.end();</span><br></pre></td></tr></table></figure>
<h3 id="CRM学习法-搞定mysql"><a href="#CRM学习法-搞定mysql" class="headerlink" title="CRM学习法 搞定mysql"></a>CRM学习法 搞定mysql</h3><ul>
<li>了解如何连接 mysql</li>
<li>如何创建 数据库</li>
<li>如何创建表</li>
<li>对表 CRUD</li>
</ul>
<p><strong>如果你是新手千万不要写update 和 delete语句</strong></p>
<blockquote>
<h3 id="推荐你用这个解决sql语法"><a href="#推荐你用这个解决sql语法" class="headerlink" title="推荐你用这个解决sql语法"></a>推荐你用这个解决sql语法</h3></blockquote>
<ul>
<li>devdocs.io 开启 postgresql 文档</li>
<li>菜鸟教程</li>
</ul>
<h3 id="mysql-数据类型"><a href="#mysql-数据类型" class="headerlink" title="mysql 数据类型"></a>mysql 数据类型</h3><p><strong>五大类</strong></p>
<ul>
<li>数字<ul>
<li>太多了</li>
</ul>
</li>
<li>字符串<ul>
<li>char(100) 固定占用100字符，即使你存一个 字符串1</li>
<li>varchar(100) 变长存储 省空间</li>
<li>binary(1024)</li>
<li>varbinary(1024)</li>
<li>blob</li>
<li>text 存博客这种</li>
<li>enum(‘v1’,’v2’)</li>
<li>set(‘v1’,’v2’)</li>
<li>具体看文档</li>
</ul>
</li>
<li>时间和日期类型<ul>
<li>date 年月日</li>
<li>time 某事某分某秒</li>
<li>datetime 年月日 时分秒</li>
<li>timestamp 时间戳</li>
<li>year 只存年</li>
<li>关注一下 ISO 8601<ul>
<li>很多程序员处理不好日期数据，就是因为不了解它</li>
<li>如何把日期处理为 ISO 8601格式</li>
</ul>
</li>
</ul>
</li>
<li>JSON类型 5.7.8以上</li>
<li>其他特殊类型</li>
</ul>
<blockquote>
<p>参考文档</p>
</blockquote>
<ul>
<li>dev.mysql.com</li>
<li>菜鸟教程</li>
</ul>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/Node后端/">Node后端</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2020/03/11/Node全解06-01翻译工具/" title="Node全解06_01翻译工具" itemprop="url">Node全解06_01翻译工具</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Stevin" target="_blank" itemprop="author">Stevin</a>
		
  <p class="article-time">
    <time datetime="2020-03-10T23:02:33.000Z" itemprop="datePublished"> Published 2020-03-11</time>
    
  </p>
</header>
    <div class="article-content">
        
        <blockquote>
<p>待更新</p>
</blockquote>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/Node后端/">Node后端</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2020/03/10/Node全解05静态服务器/" title="Node全解05静态服务器" itemprop="url">Node全解05静态服务器</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Stevin" target="_blank" itemprop="author">Stevin</a>
		
  <p class="article-time">
    <time datetime="2020-03-10T03:01:23.000Z" itemprop="datePublished"> Published 2020-03-10</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="HTTP模块"><a href="#HTTP模块" class="headerlink" title="HTTP模块"></a>HTTP模块</h1><blockquote>
<h4 id="一些有用的工具"><a href="#一些有用的工具" class="headerlink" title="一些有用的工具"></a>一些有用的工具</h4></blockquote>
<p><strong>node-dev</strong></p>
<ul>
<li>当文件更新时自动重启 node</li>
<li>避免每次改完代码都要重新运行的麻烦</li>
<li>不宜在生产环境使用</li>
</ul>
<p><strong>ts-node</strong></p>
<ul>
<li>让 node 支持直接运行 TS代码</li>
<li>不宜在生产环境使用</li>
</ul>
<p><strong>ts-node-dev</strong></p>
<ul>
<li>这个工具结合了上面两个工具</li>
<li>可以用 TS 开发 Node.js 程序，且会自动重启</li>
<li>不宜在生产环境使用，非常适合用来学习</li>
</ul>
<p>你可以这样安装 <code>yarn global add ts-node-dev</code></p>
<blockquote>
<h4 id="一些有用的工具2"><a href="#一些有用的工具2" class="headerlink" title="一些有用的工具2"></a>一些有用的工具2</h4></blockquote>
<p><strong>WebStorm自动格式化</strong></p>
<ul>
<li>ReformatCode 设置为 Ctrl + L 或者其他键位</li>
<li>可以快速帮你格式化 TS / JS 代码</li>
</ul>
<p><strong>WebStorm自动写代码</strong></p>
<ul>
<li>Complete Current Statement 设置为 Ctrl + Enter 或者其他键位</li>
<li>Show Context Actions 设置为 Alt + Enter 或者其他键位</li>
</ul>
<p><strong>VSCode配置</strong></p>
<ul>
<li>开启自动保存 autosave </li>
<li>format on save</li>
<li>format</li>
</ul>
<blockquote>
<h4 id="一些有用的工具3"><a href="#一些有用的工具3" class="headerlink" title="一些有用的工具3"></a>一些有用的工具3</h4></blockquote>
<p><strong>WebStorm Git配置</strong></p>
<ul>
<li>选择设置 =》 搜索 git =&gt; path选中你安装的git路径</li>
</ul>
<p><strong>VSCode配置</strong></p>
<ul>
<li>设置 搜索 settings 打开设置 json</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;git.enabled&quot;: true,</span><br><span class="line">    &quot;git.path&quot;: &quot;/usr/bin/git&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Curl命令</strong></p>
<ul>
<li>get: <code>curl -v url</code></li>
<li>post: <code>curl -v -d &quot;name=xxx&quot; url</code></li>
<li>设置请求头： <code>-H &#39;Content-Type:application/json&#39;</code></li>
<li>设置动词： <code>-X PUT</code></li>
<li>JSON请求： <code>curl -d &#39;{&quot;name&quot;:&quot;bob&quot;}&#39; -H &#39;Content-Type:pplication/json&#39; url</code></li>
</ul>
<h3 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h3><ul>
<li>项目目录 node-server-demo</li>
<li>由于我们写 ts 别忘了安装 <code>yarn global add ts-node-dev</code></li>
<li>yarn init -y</li>
<li>yarn add –dev @types/node 安装 node 声明文件</li>
<li><p>新建 index.ts</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">import * as http from &apos;http&apos;;</span><br><span class="line"></span><br><span class="line">const server = http.createServer();</span><br><span class="line"></span><br><span class="line">server.on(&apos;request&apos;, (request, response) =&gt; &#123;</span><br><span class="line">    console.log(&apos;有人请求了&apos;)</span><br><span class="line">    response.end(&quot;hi&quot;);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">server.listen(8888);</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动服务ts-node-dev index.ts</p>
</li>
<li>发请求<code>curl http://localhost:8888</code></li>
</ul>
<h3 id="server-是什么东西"><a href="#server-是什么东西" class="headerlink" title="server 是什么东西"></a>server 是什么东西</h3><p><strong>http.Server 类的实例</strong></p>
<ul>
<li>根据文档能知道 http.createServer 的返回值类型</li>
<li>根据文档知道 server 拥有几个事件和方法</li>
<li>其中目前能用上的 只有 request事件 和 listen()</li>
</ul>
<p><strong>继承自net.Server</strong></p>
<ul>
<li>根据文档知道继承关系</li>
<li>看到 net.Server 又有几个方法</li>
<li>其中也就 error事件 和 address() 能用上</li>
</ul>
<blockquote>
<h4 id="一些技巧"><a href="#一些技巧" class="headerlink" title="一些技巧"></a>一些技巧</h4></blockquote>
<ul>
<li>有的时候 <strong>点不出来东西</strong>，那是因为 类型声明文件不够匹配可能写的是 any</li>
<li>所以你可以通过 加类型声明 来达到 “点出来提示”</li>
<li>如果你用的是 vscode 请安装 auto import</li>
</ul>
<p>index.ts</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">import * as http from &apos;http&apos;;</span><br><span class="line">import &#123; IncomingMessage, ServerResponse &#125; from &apos;http&apos;;</span><br><span class="line"></span><br><span class="line">const server = http.createServer();</span><br><span class="line"></span><br><span class="line">server.on(&apos;request&apos;, (request: IncomingMessage, response: ServerResponse) =&gt; &#123;</span><br><span class="line">    console.log(request.constructor);</span><br><span class="line">    console.log(response.constructor);</span><br><span class="line">    // 得知它是什么 然后声明它的类型 , 这样你在 request. 的时候才会有提示</span><br><span class="line">    console.log(request.httpVersion);</span><br><span class="line">    console.log(request.url);</span><br><span class="line">    response.end(&quot;hi&quot;);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">server.listen(8888);</span><br></pre></td></tr></table></figure>
<h3 id="如何获取请求体的内容"><a href="#如何获取请求体的内容" class="headerlink" title="如何获取请求体的内容"></a>如何获取请求体的内容</h3><ul>
<li><code>request.on(&#39;data&#39;, fn)</code></li>
<li><code>request.on(&#39;end&#39;, fn)</code></li>
<li><code>curl -v  -d &quot;name=aaa&quot; http://localhost:8888</code></li>
</ul>
<p><strong>有个问题：这个上传方式就算用户上传1G的东西都可以拿到，因为你是一小段一小段拿到然后拼起来，只要服务器内存够。就可以处理上传的内容</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">import * as http from &apos;http&apos;;</span><br><span class="line">import &#123; IncomingMessage, ServerResponse &#125; from &apos;http&apos;;</span><br><span class="line"></span><br><span class="line">const server = http.createServer();</span><br><span class="line"></span><br><span class="line">server.on(&apos;request&apos;, (request: IncomingMessage, response: ServerResponse) =&gt; &#123;</span><br><span class="line">    console.log(request.constructor);</span><br><span class="line">    console.log(response.constructor);</span><br><span class="line">    // 得知它是什么 然后声明它的类型 , 这样你在 request. 的时候才会有提示</span><br><span class="line">    console.log(&apos;request.httpVersion&apos;)</span><br><span class="line">    console.log(request.httpVersion);</span><br><span class="line">    console.log(&apos;request.url&apos;);</span><br><span class="line">    console.log(request.url);</span><br><span class="line">    console.log(&apos;request.headers&apos;);</span><br><span class="line">    console.log(request.headers);</span><br><span class="line">    console.log(&apos;request.method&apos;);</span><br><span class="line">    console.log(request.method);</span><br><span class="line"></span><br><span class="line">    // 获取请求体</span><br><span class="line">    const array = [];</span><br><span class="line">    request.on(&apos;data&apos;, (chunk) =&gt; &#123;</span><br><span class="line">        array.push(chunk)</span><br><span class="line">    &#125;)</span><br><span class="line">    request.on(&apos;end&apos;, () =&gt; &#123;</span><br><span class="line">        const body = Buffer.concat(array).toString();</span><br><span class="line">        console.log(body)</span><br><span class="line">        response.end(&quot;hi&quot;);</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">server.listen(8888);</span><br></pre></td></tr></table></figure>
<h4 id="request-response-是啥"><a href="#request-response-是啥" class="headerlink" title="request,response 是啥"></a>request,response 是啥</h4><blockquote>
<p>找类</p>
</blockquote>
<ul>
<li>根据文档， request 是 http. IncomingMessage 的实例</li>
<li>根据文档， response 是 http. ServerResponse 的实例</li>
</ul>
<blockquote>
<p>Request</p>
</blockquote>
<ul>
<li>拥有 headers, method , url 等属性</li>
<li>从 stream.Readable 类继承了 data/end/error 事件</li>
<li>为什么不直接拿到请求的消息体呢？ 根TCP相关</li>
</ul>
<blockquote>
<p>Response</p>
</blockquote>
<ul>
<li>拥有 getHeader/setHeader/end/write 等方法</li>
<li><p>拥有 statusCode 属性，可读可写</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">response.statusCode = 404;</span><br><span class="line">// 设置响应头</span><br><span class="line">response.setHeader(&apos;x-frank&apos;, &apos;I am frank&apos;)</span><br><span class="line">response.write(&apos;1\n&apos;);</span><br><span class="line">response.write(&apos;2\n&apos;);</span><br><span class="line">response.write(&apos;3\n&apos;);</span><br><span class="line">response.write(&apos;4\n&apos;);</span><br><span class="line">response.end(); // 如果你设置了 404 就 end里不传任何东西</span><br></pre></td></tr></table></figure>
<ul>
<li>你也可以写回一个 image 但是要设置文件头标示它是一个 image</li>
</ul>
</li>
<li>继承了 Stream,目前用不上</li>
</ul>
<h3 id="项目1-根据url返回不同类型文件"><a href="#项目1-根据url返回不同类型文件" class="headerlink" title="项目1 根据url返回不同类型文件"></a>项目1 根据url返回不同类型文件</h3><ul>
<li><a href="http://localhost:8888/index.html" target="_blank" rel="noopener">http://localhost:8888/index.html</a></li>
<li><a href="http://localhost:8888/main.js" target="_blank" rel="noopener">http://localhost:8888/main.js</a></li>
<li><a href="http://localhost:8888/style.css" target="_blank" rel="noopener">http://localhost:8888/style.css</a></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">import * as http from &apos;http&apos;;</span><br><span class="line">import &#123; IncomingMessage, ServerResponse &#125; from &apos;http&apos;;</span><br><span class="line">import * as fs from &apos;fs&apos;;</span><br><span class="line">import * as p from &apos;path&apos;;</span><br><span class="line"></span><br><span class="line">const server = http.createServer();</span><br><span class="line">const publicDir = p.relative(__dirname, &apos;public&apos;);</span><br><span class="line"></span><br><span class="line">server.on(&apos;request&apos;, (request: IncomingMessage, response: ServerResponse) =&gt; &#123;</span><br><span class="line">    const &#123; method, url, headers &#125; = request;</span><br><span class="line">    switch (url) &#123;</span><br><span class="line">        case &apos;/index.html&apos;:</span><br><span class="line">            response.setHeader(&apos;Content-Type&apos;, &apos;text/html;charset=utf-8&apos;);</span><br><span class="line">            fs.readFile(p.resolve(publicDir, &apos;index.html&apos;), (error, data) =&gt; &#123;</span><br><span class="line">                if (error) throw error;</span><br><span class="line">                response.end(data.toString());</span><br><span class="line">            &#125;)</span><br><span class="line">            break;</span><br><span class="line">        case &apos;/style.css&apos;:</span><br><span class="line">            response.setHeader(&apos;Content-Type&apos;, &apos;text/css;charset=utf-8&apos;);</span><br><span class="line">            fs.readFile(p.resolve(publicDir, &apos;style.css&apos;), (error, data) =&gt; &#123;</span><br><span class="line">                if (error) throw error;</span><br><span class="line">                response.end(data.toString());</span><br><span class="line">            &#125;)</span><br><span class="line">            break;</span><br><span class="line">        case &apos;/main.js&apos;:</span><br><span class="line">            response.setHeader(&apos;Content-Type&apos;, &apos;text/javascript;charset=utf-8&apos;);</span><br><span class="line">            fs.readFile(p.resolve(publicDir, &apos;main.js&apos;), (error, data) =&gt; &#123;</span><br><span class="line">                if (error) throw error;</span><br><span class="line">                response.end(data.toString());</span><br><span class="line">            &#125;)</span><br><span class="line">            break;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">server.listen(8888);</span><br></pre></td></tr></table></figure>
<h3 id="项目2-处理查询参数"><a href="#项目2-处理查询参数" class="headerlink" title="项目2 处理查询参数"></a>项目2 处理查询参数</h3><ul>
<li>使用 url模块 <code>url.path()</code></li>
<li><a href="http://localhost:8888/index.html?q=aa" target="_blank" rel="noopener">http://localhost:8888/index.html?q=aa</a></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">import * as url from &apos;url&apos;;</span><br><span class="line"></span><br><span class="line">server.on(&apos;request&apos;, (request: IncomingMessage, response: ServerResponse) =&gt; &#123;</span><br><span class="line">    const &#123; method, url: path, headers &#125; = request;</span><br><span class="line">    const &#123; pathname, search &#125; = url.parse(path);</span><br><span class="line">    switch (pathname) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="项目3-匹配任意文件"><a href="#项目3-匹配任意文件" class="headerlink" title="项目3 匹配任意文件"></a>项目3 匹配任意文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">// 匹配任意文件</span><br><span class="line">import * as http from &apos;http&apos;;</span><br><span class="line">import &#123; IncomingMessage, ServerResponse &#125; from &apos;http&apos;;</span><br><span class="line">import * as fs from &apos;fs&apos;;</span><br><span class="line">import * as p from &apos;path&apos;;</span><br><span class="line">import * as url from &apos;url&apos;;</span><br><span class="line"></span><br><span class="line">const server = http.createServer();</span><br><span class="line">const publicDir = p.relative(__dirname, &apos;public&apos;);</span><br><span class="line"></span><br><span class="line">server.on(&apos;request&apos;, (request: IncomingMessage, response: ServerResponse) =&gt; &#123;</span><br><span class="line">    const &#123; method, url: path, headers &#125; = request;</span><br><span class="line">    const &#123; pathname, search &#125; = url.parse(path);</span><br><span class="line"></span><br><span class="line">    // /index.html ==&gt; index.html</span><br><span class="line">    let filename = pathname.substr(1);</span><br><span class="line">    if (filename === &apos;&apos;) &#123;</span><br><span class="line">        filename = &apos;index.html&apos;</span><br><span class="line">    &#125;</span><br><span class="line">    response.setHeader(&apos;Content-Type&apos;, &apos;text/html;charset=utf-8&apos;);</span><br><span class="line">    fs.readFile(p.resolve(publicDir, filename), (error, data) =&gt; &#123;</span><br><span class="line">        if (error) &#123;</span><br><span class="line">            if (error.errno === -4058) &#123;</span><br><span class="line">                response.statusCode = 404;</span><br><span class="line">                response.end(&apos;你要的文件不存在啊！！！&apos;);</span><br><span class="line">            &#125; else if (error.errno === -4068) &#123;</span><br><span class="line">                // http://localhost:8888/xxx</span><br><span class="line">                response.statusCode = 403;</span><br><span class="line">                response.end(&apos;无权限查看目录内容&apos;);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                response.statusCode = 500;</span><br><span class="line">                response.end(&apos;服务器繁忙，请稍后再试&apos;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            response.end(data.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">server.listen(8888);</span><br></pre></td></tr></table></figure>
<h3 id="项目4-处理非get请求-添加缓存文件时间"><a href="#项目4-处理非get请求-添加缓存文件时间" class="headerlink" title="项目4 处理非get请求 添加缓存文件时间"></a>项目4 处理非get请求 添加缓存文件时间</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">if (method !== &apos;GET&apos;) &#123;</span><br><span class="line">    response.statusCode = 200;</span><br><span class="line">    response.setHeader(&apos;Content-Type&apos;, &apos;text/html;charset=utf-8&apos;);</span><br><span class="line">    response.end(&quot;这是一个假的响应&quot;);</span><br><span class="line">    return;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">response.setHeader(&apos;Cache-Control&apos;, `public,max-age=$&#123;cacheAge&#125;`);</span><br></pre></td></tr></table></figure>
<h3 id="免费用-WebStorm的途径"><a href="#免费用-WebStorm的途径" class="headerlink" title="免费用 WebStorm的途径"></a>免费用 WebStorm的途径</h3><p><strong>申请条件</strong></p>
<ul>
<li>开源项目的贡献者</li>
<li>你的项目是开源的 如MIT</li>
<li>你的项目是不盈利的</li>
<li>你的项目至少活跃3个月</li>
<li>你定期发布更新的版本</li>
<li>满足条件就 点击申请按钮</li>
</ul>
<p><strong>填写材料</strong></p>
<ul>
<li>邮箱地址一定不要错</li>
<li>No. of required licenses 填 1</li>
<li>项目描述用 google 翻译即可</li>
<li>正版 JetBrains 全家桶唾手可得，价值$649/年</li>
</ul>
<h3 id="项目地址"><a href="#项目地址" class="headerlink" title="项目地址"></a>项目地址</h3><p><a href="https://github.com/slTrust/node-server-demo" target="_blank" rel="noopener">https://github.com/slTrust/node-server-demo</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/Node后端/">Node后端</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2020/03/09/Node全解04调试工具/" title="Node全解04调试工具" itemprop="url">Node全解04调试工具</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Stevin" target="_blank" itemprop="author">Stevin</a>
		
  <p class="article-time">
    <time datetime="2020-03-09T06:00:19.000Z" itemprop="datePublished"> Published 2020-03-09</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="调试工具"><a href="#调试工具" class="headerlink" title="调试工具"></a>调试工具</h1><h3 id="WebStorm"><a href="#WebStorm" class="headerlink" title="WebStorm"></a>WebStorm</h3><ul>
<li>打开一个项目目录</li>
<li>点击工具栏 Run</li>
<li>Edit Configurations</li>
<li>点击 “+”</li>
<li>然后配置你的测试配置<ul>
<li>Name 你这个配置的名称</li>
<li>Node interpreter node环境</li>
<li>Wroking directory: 工作目录</li>
<li>JavaScript file: 测试的文件 xxx.js</li>
<li>Application parameters: 输入的参数</li>
</ul>
</li>
<li>点击OK</li>
<li>再次点击 Run 子菜单里会多了一个 你刚刚的配置<ul>
<li>Run xxx 直接运行</li>
<li>debug xxx 设置断点运行</li>
</ul>
</li>
</ul>
<h3 id="VS-Code"><a href="#VS-Code" class="headerlink" title="VS Code"></a>VS Code</h3><ul>
<li>侧边栏点击 小虫子那个按钮</li>
<li>点击 启动程序 ， 如果没反应 点击它右边有个 控制台的按钮</li>
<li><p>会让你配置一个 json</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    // Use IntelliSense to learn about possible attributes.</span><br><span class="line">    // Hover to view descriptions of existing attributes.</span><br><span class="line">    // For more information, visit: https://go.microsoft.com/fwlink/?linkid=830387</span><br><span class="line">    &quot;version&quot;: &quot;0.2.0&quot;,</span><br><span class="line">    &quot;configurations&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;type&quot;: &quot;node&quot;,</span><br><span class="line">            &quot;request&quot;: &quot;launch&quot;,</span><br><span class="line">            // 启动程序</span><br><span class="line">            &quot;name&quot;: &quot;Launch Program&quot;,</span><br><span class="line">            &quot;skipFiles&quot;: [</span><br><span class="line">                &quot;&lt;node_internals&gt;/**&quot;</span><br><span class="line">            ],</span><br><span class="line">            // 入口文件</span><br><span class="line">            &quot;program&quot;: &quot;$&#123;workspaceFolder&#125;/cli.js&quot;,</span><br><span class="line">            &quot;args&quot;: [&quot;add&quot;, &quot;task&quot;, &quot;100&quot;]</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>再次点击运行按钮</p>
</li>
</ul>
<h3 id="命令行-Chrome-断点"><a href="#命令行-Chrome-断点" class="headerlink" title="命令行 + Chrome 断点"></a>命令行 + Chrome 断点</h3><blockquote>
<p>第一种方式： 你可以在 js文件 添加 debugger 运行时就会停在当前行</p>
</blockquote>
<blockquote>
<p>第二种方式： 终端添加参数 <code>--inspect-brk</code></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// 你原来是这样</span><br><span class="line">node cli.js add abc</span><br><span class="line"></span><br><span class="line">// 现在你这样,它就会停下来等你</span><br><span class="line">node --inspect-brk cli.js add abc</span><br></pre></td></tr></table></figure>
<ul>
<li>运行上述命令后，打开 Chrome 右键调试</li>
<li>你会看到弹出的工具栏 左上角 多了一个绿色 的 Node.js 图标 点击即可</li>
<li>注意！ 如果你直接添加的命令是 <code>--inspect</code> 它会直接执行 不停下来 ，所以要加 <code>-brk</code> 它就会等你连接</li>
</ul>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/Node后端/">Node后端</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2020/03/09/Node全解03-01jest/" title="Node全解03_01jest" itemprop="url">Node全解03_01jest</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Stevin" target="_blank" itemprop="author">Stevin</a>
		
  <p class="article-time">
    <time datetime="2020-03-09T01:59:42.000Z" itemprop="datePublished"> Published 2020-03-09</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="单元测试-JEST使用"><a href="#单元测试-JEST使用" class="headerlink" title="单元测试 JEST使用"></a>单元测试 JEST使用</h1><ul>
<li><a href="https://jestjs.io/" target="_blank" rel="noopener">jest</a></li>
</ul>
<p>代码使用我们上次写的<a href="https://github.com/slTrust/node-todo-1/tree/867474eb4f246258b847364f8a46bd6836ef7e4c" target="_blank" rel="noopener">Node命令行工具</a> </p>
<h3 id="如何测试"><a href="#如何测试" class="headerlink" title="如何测试"></a>如何测试</h3><blockquote>
<p>步骤</p>
</blockquote>
<ul>
<li>选择测试工具： jest</li>
<li>设计测试用例</li>
<li>写测试，运行测试，改代码</li>
<li>单元测试、功能测试、集成测试</li>
</ul>
<blockquote>
<p>重点</p>
</blockquote>
<ul>
<li>单元测试不应该和外界打交道(那是集成测试做的) 应该 mock<ul>
<li>不能操作硬盘</li>
<li>不能操作网络</li>
<li>不能操作任何东西，只能操作你自己</li>
</ul>
</li>
<li>单元测试的对象是函数</li>
<li>功能测试的对象是模块</li>
<li>集成测试的对象是系统</li>
<li>我们先搞定单元测试</li>
</ul>
<h3 id="直接-CRM学习法"><a href="#直接-CRM学习法" class="headerlink" title="直接 CRM学习法"></a>直接 CRM学习法</h3><ul>
<li><a href="https://jestjs.io/docs/en/getting-started" target="_blank" rel="noopener">Jest官网 Docs</a></li>
<li><code>yarn add --dev jest</code></li>
<li><p>修改package.json</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&quot;scripts&quot;: &#123;</span><br><span class="line">    &quot;test&quot;: &quot;jest&quot;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
</li>
<li><p>新建 <code>__test__</code> 目录 并在它下面创建 <code>db.spec.js</code></p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">const db = require(&quot;../db.js&quot;)</span><br><span class="line">describe(&quot;db&quot;,()=&gt;&#123;</span><br><span class="line">    it(&quot;can read&quot;,()=&gt;&#123;</span><br><span class="line">        expect(db.read instanceof Function).toBe(true)</span><br><span class="line">    &#125;)  </span><br><span class="line"></span><br><span class="line">    it(&quot;can write&quot;,()=&gt;&#123;</span><br><span class="line">        expect(db.write instanceof Function).toBe(true)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p>运行 npm run test</p>
</li>
</ul>
<h4 id="如何测试读文件呢？"><a href="#如何测试读文件呢？" class="headerlink" title="如何测试读文件呢？"></a>如何测试读文件呢？</h4><blockquote>
<h4 id="如果你想这样测试！！！-请放弃"><a href="#如果你想这样测试！！！-请放弃" class="headerlink" title="如果你想这样测试！！！ 请放弃"></a>如果你想这样测试！！！ 请放弃</h4></blockquote>
<ul>
<li>不该和外界打交道，万一你的文件已经存在了呢？这样就会有干扰</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fs.writeFileSync(&apos;/xxx.json&apos;,`[&#123;&quot;title&quot;:&quot;hi&quot;,&quot;done&quot;:true&#125;]`)</span><br><span class="line">db.read(&apos;/xxx.json&apos;)</span><br></pre></td></tr></table></figure>
<p><strong>请搜索 jest mock fs</strong> <a href="https://jestjs.io/docs/en/manual-mocks" target="_blank" rel="noopener">jest doc 的 Manual Mocks章节</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jest.mock(&apos;fs&apos;) // 意思是 jest 接管 fs模块</span><br></pre></td></tr></table></figure>
<h4 id="Mock-fs-模块"><a href="#Mock-fs-模块" class="headerlink" title="Mock fs 模块"></a>Mock fs 模块</h4><ul>
<li><p>新建 <code>__mocks__/fs.js</code> 代表 mock 一个假的 fs模块</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// 声明是 fs的 jest 的假模块</span><br><span class="line">const fs = jest.genMockFromModule(&apos;fs&apos;);</span><br><span class="line"></span><br><span class="line">fs.x = ()=&gt;&#123;</span><br><span class="line">    console.log(&apos;hi&apos;)</span><br><span class="line">    return &apos;xxx&apos;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module.exports = fs;</span><br></pre></td></tr></table></figure>
</li>
<li><p>db.spec.js</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">const db = require(&quot;../db.js&quot;)</span><br><span class="line">const fs = require(&apos;fs&apos;); </span><br><span class="line">jest.mock(&apos;fs&apos;); </span><br><span class="line"></span><br><span class="line">describe(&quot;db&quot;,()=&gt;&#123;</span><br><span class="line">    it(&quot;can read&quot;,()=&gt;&#123;</span><br><span class="line">        expect(fs.x()).toBe(&apos;xxx&apos;)</span><br><span class="line">    &#125;)  </span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p>运行 npm run test 成功</p>
</li>
</ul>
<h3 id="完整版-mock-fs"><a href="#完整版-mock-fs" class="headerlink" title="完整版 mock fs"></a>完整版 mock fs</h3><p><code>__mocks__/fs.js</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">// 声明是 fs的 jest 的假模块</span><br><span class="line">const fs = jest.genMockFromModule(&apos;fs&apos;);</span><br><span class="line">const _fs = jest.requireActual(&apos;fs&apos;);</span><br><span class="line"></span><br><span class="line">Object.assign(fs,_fs);</span><br><span class="line"></span><br><span class="line">let readMocks = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">fs.setReadFileMock = (path, error, data)=&gt;&#123;</span><br><span class="line">    readMocks[path] = [error,data];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 覆盖 fs的 readFile()</span><br><span class="line">fs.readFile = (path, options, callBack) =&gt; &#123;</span><br><span class="line">    // 如果你 fs.readFile(&apos;xxx&apos;,fn) 代表第二个参数是 callBack</span><br><span class="line">    if(callBack === undefined)&#123;</span><br><span class="line">        callBack = options</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if(path in readMocks)&#123;</span><br><span class="line">        callBack(...readMocks[path])</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        _fs.readFile(path, options, callBack)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">let writeMocks = &#123;&#125;</span><br><span class="line"></span><br><span class="line">fs.setWriteFileMock = (path, fn)=&gt;&#123;</span><br><span class="line">    writeMocks[path] = fn;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fs.writeFile = (path,data,options, callBack) =&gt; &#123;</span><br><span class="line">    if(callBack === undefined)&#123;</span><br><span class="line">        callBack = options;</span><br><span class="line">    &#125;</span><br><span class="line">    if(path in writeMocks)&#123;</span><br><span class="line">        writeMocks[path](path, data, options, callBack)</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        _fs.writeFile(path, data, options, callBack)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fs.clearMocks = ()=&gt;&#123;</span><br><span class="line">    readMocks = &#123;&#125;;</span><br><span class="line">    writeMocks = &#123;&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module.exports = fs;</span><br></pre></td></tr></table></figure>
<p><code>__tests__/db.spec.js</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">const db = require(&quot;../db.js&quot;)</span><br><span class="line">const fs = require(&apos;fs&apos;); </span><br><span class="line">jest.mock(&apos;fs&apos;); </span><br><span class="line"></span><br><span class="line">describe(&quot;db&quot;,()=&gt;&#123;</span><br><span class="line">    afterEach(()=&gt;&#123;</span><br><span class="line">        // 每个it 执行之后</span><br><span class="line">        fs.clearMocks();</span><br><span class="line">    &#125;)</span><br><span class="line">    it(&quot;can read&quot;, async () =&gt;&#123;</span><br><span class="line">        const data = [&#123;title:&quot;hi&quot;,done:true&#125;]</span><br><span class="line">        fs.setReadFileMock(&apos;/xxx&apos;,null,JSON.stringify(data));</span><br><span class="line">        const list = await db.read(&apos;/xxx&apos;);</span><br><span class="line">        expect(list).toStrictEqual(data)</span><br><span class="line">    &#125;)  </span><br><span class="line"></span><br><span class="line">    it(&quot;can wriete&quot;, async () =&gt;&#123;</span><br><span class="line">        let fakeFile;</span><br><span class="line">        fs.setWriteFileMock(&apos;/yyy&apos;,(path, data, options, callBack)=&gt;&#123;</span><br><span class="line">            fakeFile = data;</span><br><span class="line">            callBack(null)</span><br><span class="line">        &#125;)</span><br><span class="line">        const list = [&#123;title:&quot;见欧阳娜娜&quot;,done:true&#125;, &#123;title:&quot;见迪丽热巴&quot;,done:true&#125;]</span><br><span class="line">        await db.write(list,&apos;/yyy&apos;);</span><br><span class="line">        expect(fakeFile).toBe(JSON.stringify(list) + &quot;\n&quot;);</span><br><span class="line">    &#125;)  </span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="代码仓库"><a href="#代码仓库" class="headerlink" title="代码仓库"></a>代码仓库</h3><ul>
<li><a href="https://github.com/slTrust/node-todo-1" target="_blank" rel="noopener">https://github.com/slTrust/node-todo-1</a></li>
</ul>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/Node后端/">Node后端</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2020/03/08/Node全解02-02node命令行程序/" title="Node全解02_02node命令行程序" itemprop="url">Node全解02_02node命令行程序</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Stevin" target="_blank" itemprop="author">Stevin</a>
		
  <p class="article-time">
    <time datetime="2020-03-08T15:58:45.000Z" itemprop="datePublished"> Published 2020-03-08</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h3 id="继续完善代码"><a href="#继续完善代码" class="headerlink" title="继续完善代码"></a>继续完善代码</h3><blockquote>
<h3 id="001-如果用户输入-node-cli-js-就显示所有任务"><a href="#001-如果用户输入-node-cli-js-就显示所有任务" class="headerlink" title="001 如果用户输入 node cli.js 就显示所有任务"></a>001 如果用户输入 <code>node cli.js</code> 就显示所有任务</h3></blockquote>
<p>cli.js</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// 用户实际输入的 命令参数</span><br><span class="line">// console.log(process.argv)</span><br><span class="line"></span><br><span class="line">if(process.argv.length === 2)&#123;</span><br><span class="line">  // 说明用户直接运行 node cli.js</span><br><span class="line">  api.showAll()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>index.js</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">module.exports.showAll = async (title) =&gt;&#123;</span><br><span class="line">    const list = await db.read();</span><br><span class="line">    list.forEach((task, index)=&gt;&#123;</span><br><span class="line">        console.log(`$&#123;task.done ? &apos;[x]&apos; : &apos;[_]&apos;&#125;$&#123;index&#125; - $&#123;task.title&#125;`)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<h3 id="002-在用户输入-node-cli-js-时候-假如有很多任务-如何通过上下按钮-切换呢？"><a href="#002-在用户输入-node-cli-js-时候-假如有很多任务-如何通过上下按钮-切换呢？" class="headerlink" title="002 在用户输入 node cli.js 时候 假如有很多任务 如何通过上下按钮 切换呢？"></a>002 在用户输入 <code>node cli.js</code> 时候 假如有很多任务 如何通过上下按钮 切换呢？</h3></blockquote>
<ul>
<li><a href="https://github.com/SBoudrias/Inquirer.js" target="_blank" rel="noopener">inquirer.js</a></li>
<li><a href="https://github.com/SBoudrias/Inquirer.js/tree/master/packages/inquirer/examples" target="_blank" rel="noopener">example </a></li>
<li><a href="https://github.com/SBoudrias/Inquirer.js/blob/master/packages/inquirer/examples/list.js" target="_blank" rel="noopener">参考 example 提供的 list.js</a></li>
</ul>
<blockquote>
<h3 id="003-完成所有功能"><a href="#003-完成所有功能" class="headerlink" title="003 完成所有功能"></a>003 完成所有功能</h3></blockquote>
<p>index.js</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">const inquirer = require(&apos;inquirer&apos;);</span><br><span class="line">const db = require(&apos;./db.js&apos;);</span><br><span class="line"></span><br><span class="line">module.exports.add = async (title) =&gt;&#123;</span><br><span class="line">    // 读取之前的任务</span><br><span class="line">    const list = await db.read();</span><br><span class="line">    // 往里面添加一个任务</span><br><span class="line">    list.push(&#123;title,done:false&#125;);</span><br><span class="line">    // 存储任务到文件</span><br><span class="line">    console.log(&apos;read~~~~&apos;)</span><br><span class="line">    console.log(list)</span><br><span class="line">    await db.write(list);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module.exports.clear = async (title) =&gt;&#123;</span><br><span class="line">    await db.write([]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module.exports.showAll = async (title) =&gt;&#123;</span><br><span class="line">    const list = await db.read();</span><br><span class="line">    inquirer</span><br><span class="line">        .prompt([</span><br><span class="line">            &#123;</span><br><span class="line">                type: &apos;list&apos;,</span><br><span class="line">                name: &apos;index&apos;,</span><br><span class="line">                message: &apos;请选择你想操作的任务&apos;,</span><br><span class="line">                choices: [ </span><br><span class="line">                    &#123;name:&apos;退出&apos;,value:&apos;-1&apos;&#125;,</span><br><span class="line">                  </span><br><span class="line">                    ...list.map((task, index)=&gt;&#123;</span><br><span class="line">                    return &#123;name: `$&#123;task.done ? &apos;[x]&apos; : &apos;[_]&apos;&#125;$&#123;index&#125; - $&#123;task.title&#125;`, value: index.toString()&#125;</span><br><span class="line">                &#125;),</span><br><span class="line">                &#123;name:&apos;创建任务&apos;,value:&apos;-2&apos;&#125;</span><br><span class="line">            ]</span><br><span class="line">            &#125;,</span><br><span class="line">        ])</span><br><span class="line">        .then(answers =&gt; &#123;</span><br><span class="line">            const index = parseInt(answers.index);</span><br><span class="line">            if(index &gt;= 0)&#123;</span><br><span class="line">                inquirer</span><br><span class="line">                .prompt([</span><br><span class="line">                    &#123;</span><br><span class="line">                        type: &apos;list&apos;,</span><br><span class="line">                        name: &apos;action&apos;,</span><br><span class="line">                        message: &apos;请选择操作&apos;,</span><br><span class="line">                        choices: [ </span><br><span class="line">                            &#123;name:&apos;退出&apos;,value:&apos;quit&apos;&#125;,</span><br><span class="line">                            &#123;name:&apos;已完成&apos;,value:&apos;makeAsDone&apos;&#125;,</span><br><span class="line">                            &#123;name:&apos;未完成&apos;,value:&apos;maksAsUndone&apos;&#125;,</span><br><span class="line">                            &#123;name:&apos;改标题&apos;,value:&apos;updateTitle&apos;&#125;,</span><br><span class="line">                            &#123;name:&apos;删除&apos;,value:&apos;remove&apos;&#125;,</span><br><span class="line">                        ]</span><br><span class="line">                    &#125;,</span><br><span class="line">                ])</span><br><span class="line">                .then(answers2 =&gt; &#123;</span><br><span class="line">                    switch(answers2.action)&#123;</span><br><span class="line">                        case &apos;makeAsDone&apos;:</span><br><span class="line">                            list[index].done = true;</span><br><span class="line">                            db.write(list);</span><br><span class="line">                            break;</span><br><span class="line">                        case &apos;maksAsUndone&apos;:</span><br><span class="line">                            list[index].done = false;</span><br><span class="line">                            db.write(list);</span><br><span class="line">                            break;</span><br><span class="line">                        case &apos;updateTitle&apos;:</span><br><span class="line">                            inquirer.prompt([</span><br><span class="line">                                &#123;type: &apos;input&apos;,</span><br><span class="line">                                name: &apos;title&apos;,</span><br><span class="line">                                message:&apos;新的标题&apos;,</span><br><span class="line">                                default: list[index].title</span><br><span class="line">                            &#125;]).then(answer =&gt; &#123;</span><br><span class="line">                                list[index].title = answer.title</span><br><span class="line">                                db.write(list)</span><br><span class="line">                              &#125;);</span><br><span class="line">                            break;</span><br><span class="line">                        case &apos;remove&apos;:</span><br><span class="line">                            list.splice(index,1);</span><br><span class="line">                            db.write(list);</span><br><span class="line">                            break;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;else if( index === -2)&#123;</span><br><span class="line">                // 创建任务</span><br><span class="line">                inquirer.prompt([</span><br><span class="line">                    &#123;type: &apos;input&apos;,</span><br><span class="line">                    name: &apos;title&apos;,</span><br><span class="line">                    message:&apos;输入任务标题&apos;</span><br><span class="line">                &#125;]).then(answer =&gt; &#123;</span><br><span class="line">                    list.push(&#123;</span><br><span class="line">                        title: answer.title,</span><br><span class="line">                        done: false</span><br><span class="line">                    &#125;)</span><br><span class="line">                    db.write(list);</span><br><span class="line">                  &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<h3 id="004-优化代码"><a href="#004-优化代码" class="headerlink" title="004 优化代码"></a>004 优化代码</h3></blockquote>
<p>index.js</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line">const inquirer = require(&apos;inquirer&apos;);</span><br><span class="line">const db = require(&apos;./db.js&apos;);</span><br><span class="line"></span><br><span class="line">module.exports.add = async (title) =&gt;&#123;</span><br><span class="line">    // 读取之前的任务</span><br><span class="line">    const list = await db.read();</span><br><span class="line">    // 往里面添加一个任务</span><br><span class="line">    list.push(&#123;title,done:false&#125;);</span><br><span class="line">    // 存储任务到文件</span><br><span class="line">    console.log(&apos;read~~~~&apos;)</span><br><span class="line">    console.log(list)</span><br><span class="line">    await db.write(list);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module.exports.clear = async () =&gt;&#123;</span><br><span class="line">    await db.write([]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function askForCreateTask(list)&#123;</span><br><span class="line">    inquirer.prompt([</span><br><span class="line">        &#123;type: &apos;input&apos;,</span><br><span class="line">        name: &apos;title&apos;,</span><br><span class="line">        message:&apos;输入任务标题&apos;</span><br><span class="line">    &#125;]).then(answer =&gt; &#123;</span><br><span class="line">        list.push(&#123;</span><br><span class="line">            title: answer.title,</span><br><span class="line">            done: false</span><br><span class="line">        &#125;)</span><br><span class="line">        db.write(list);</span><br><span class="line">      &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function makeAsDone(list,index)&#123;</span><br><span class="line">    list[index].done = true;</span><br><span class="line">    db.write(list);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function maksAsUndone(list,index)&#123;</span><br><span class="line">    list[index].done = false;</span><br><span class="line">    db.write(list);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function updateTitle(list,index)&#123;</span><br><span class="line">    inquirer.prompt([</span><br><span class="line">        &#123;type: &apos;input&apos;,</span><br><span class="line">        name: &apos;title&apos;,</span><br><span class="line">        message:&apos;新的标题&apos;,</span><br><span class="line">        default: list[index].title</span><br><span class="line">    &#125;]).then(answer =&gt; &#123;</span><br><span class="line">        list[index].title = answer.title</span><br><span class="line">        db.write(list)</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function remove(list,index)&#123;</span><br><span class="line">    list.splice(index,1);</span><br><span class="line">    db.write(list);</span><br><span class="line">&#125;</span><br><span class="line">                </span><br><span class="line">function askForAction(list, index)&#123;</span><br><span class="line">    const actions = &#123;</span><br><span class="line">        makeAsDone,</span><br><span class="line">        maksAsUndone,</span><br><span class="line">        updateTitle,</span><br><span class="line">        remove</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    inquirer</span><br><span class="line">    .prompt([</span><br><span class="line">        &#123;</span><br><span class="line">            type: &apos;list&apos;,</span><br><span class="line">            name: &apos;action&apos;,</span><br><span class="line">            message: &apos;请选择操作&apos;,</span><br><span class="line">            choices: [ </span><br><span class="line">                &#123;name:&apos;退出&apos;,value:&apos;quit&apos;&#125;,</span><br><span class="line">                &#123;name:&apos;已完成&apos;,value:&apos;makeAsDone&apos;&#125;,</span><br><span class="line">                &#123;name:&apos;未完成&apos;,value:&apos;maksAsUndone&apos;&#125;,</span><br><span class="line">                &#123;name:&apos;改标题&apos;,value:&apos;updateTitle&apos;&#125;,</span><br><span class="line">                &#123;name:&apos;删除&apos;,value:&apos;remove&apos;&#125;,</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">    ])</span><br><span class="line">    .then(answers2 =&gt; &#123;</span><br><span class="line">        const action = actions[answers2.action];</span><br><span class="line">        console.log(action);</span><br><span class="line">        action &amp;&amp; action(list, index);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function printTasks(list)&#123;</span><br><span class="line">    inquirer</span><br><span class="line">    .prompt([</span><br><span class="line">        &#123;</span><br><span class="line">            type: &apos;list&apos;,</span><br><span class="line">            name: &apos;index&apos;,</span><br><span class="line">            message: &apos;请选择你想操作的任务&apos;,</span><br><span class="line">            choices: [ </span><br><span class="line">                &#123;name:&apos;退出&apos;,value:&apos;-1&apos;&#125;,</span><br><span class="line">              </span><br><span class="line">                ...list.map((task, index)=&gt;&#123;</span><br><span class="line">                return &#123;name: `$&#123;task.done ? &apos;[x]&apos; : &apos;[_]&apos;&#125;$&#123;index&#125; - $&#123;task.title&#125;`, value: index.toString()&#125;</span><br><span class="line">            &#125;),</span><br><span class="line">            &#123;name:&apos;创建任务&apos;,value:&apos;-2&apos;&#125;</span><br><span class="line">        ]</span><br><span class="line">        &#125;,</span><br><span class="line">    ])</span><br><span class="line">    .then(answers =&gt; &#123;</span><br><span class="line">        const index = parseInt(answers.index);</span><br><span class="line">        if(index &gt;= 0)&#123;</span><br><span class="line">            askForAction(list,index);</span><br><span class="line">        &#125;else if( index === -2)&#123;</span><br><span class="line">            // 创建任务</span><br><span class="line">            askForCreateTask(list);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module.exports.showAll = async (title) =&gt;&#123;</span><br><span class="line">    const list = await db.read();</span><br><span class="line">    printTasks(list);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>优化技巧，给一坨代码起个名字法</strong></p>
<blockquote>
<h3 id="005-发布代码"><a href="#005-发布代码" class="headerlink" title="005 发布代码"></a>005 发布代码</h3></blockquote>
<ul>
<li>修改 package.json</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&quot;bin&quot;:&#123;</span><br><span class="line">    &quot;t&quot;: &quot;cli.js&quot;</span><br><span class="line">&#125;,</span><br><span class="line">&quot;files&quot;:[&quot;*.js&quot;]</span><br></pre></td></tr></table></figure>
<ul>
<li>添加 node shebang 在 cli.js 第一行</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env node</span><br></pre></td></tr></table></figure>
<ul>
<li>如果你是 mac 添加文件可执行权限<ul>
<li><code>chmod +x cli.js</code></li>
</ul>
</li>
<li><p>nrm 安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm install -g nrm</span><br><span class="line"></span><br><span class="line">// 如果你是别的源 你就 nrm use npm</span><br></pre></td></tr></table></figure>
</li>
<li><p>发布你的代码</p>
<ul>
<li>如果是 yarn 你就<code>yarn login 和 yarn publish</code></li>
<li>如果是npm 你就<code>npm adduser 和 npm puhlish</code></li>
<li>注意把淘宝源切换为原始源</li>
</ul>
</li>
</ul>
<h4 id="代码仓库"><a href="#代码仓库" class="headerlink" title="代码仓库"></a>代码仓库</h4><ul>
<li><a href="https://github.com/slTrust/node-todo-1/" target="_blank" rel="noopener">https://github.com/slTrust/node-todo-1/</a></li>
</ul>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/Node后端/">Node后端</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>







  <nav id="page-nav" class="clearfix">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/49/">49</a><a class="extend next" rel="next" href="/page/2/">Next<span></span></a>
  </nav>

</div>
      <div class="openaside"><a class="navbutton" href="#" title="Show Sidebar"></a></div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div>
<aside class="clearfix">

  


  

  
<div class="tagslist">
	<p class="asidetitle">Tags</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/oak/" title="oak">oak<sup>71</sup></a></li>
			
		
			
				<li><a href="/tags/前端知识点/" title="前端知识点">前端知识点<sup>43</sup></a></li>
			
		
			
				<li><a href="/tags/java/" title="java">java<sup>37</sup></a></li>
			
		
			
				<li><a href="/tags/Node后端/" title="Node后端">Node后端<sup>34</sup></a></li>
			
		
			
				<li><a href="/tags/M06/" title="M06">M06<sup>29</sup></a></li>
			
		
			
				<li><a href="/tags/fullstack/" title="fullstack">fullstack<sup>27</sup></a></li>
			
		
			
				<li><a href="/tags/M07/" title="M07">M07<sup>27</sup></a></li>
			
		
			
				<li><a href="/tags/python/" title="python">python<sup>26</sup></a></li>
			
		
			
				<li><a href="/tags/M08/" title="M08">M08<sup>25</sup></a></li>
			
		
			
				<li><a href="/tags/M04/" title="M04">M04<sup>22</sup></a></li>
			
		
			
				<li><a href="/tags/M03/" title="M03">M03<sup>20</sup></a></li>
			
		
			
				<li><a href="/tags/M02/" title="M02">M02<sup>17</sup></a></li>
			
		
			
				<li><a href="/tags/React入门/" title="React入门">React入门<sup>17</sup></a></li>
			
		
			
				<li><a href="/tags/ReactWheels/" title="ReactWheels">ReactWheels<sup>16</sup></a></li>
			
		
			
				<li><a href="/tags/TS入门/" title="TS入门">TS入门<sup>16</sup></a></li>
			
		
			
				<li><a href="/tags/M01/" title="M01">M01<sup>9</sup></a></li>
			
		
			
				<li><a href="/tags/vue/" title="vue">vue<sup>8</sup></a></li>
			
		
			
				<li><a href="/tags/ES6速学/" title="ES6速学">ES6速学<sup>7</sup></a></li>
			
		
			
				<li><a href="/tags/mongodb/" title="mongodb">mongodb<sup>7</sup></a></li>
			
		
			
				<li><a href="/tags/mysql/" title="mysql">mysql<sup>7</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">Links</p>
    <ul>
        
          <li>
            
            	<a href="https://coderq.com" target="_blank" title="一个面向程序员交流分享的新一代社区">码农圈</a>
            
          </li>
        
          <li>
            
            	<a href="http://wuchong.me" target="_blank" title="Jark&#39;s Blog">Jark&#39;s Blog</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS</a>
</div>

  <div class="weiboshow">
  <p class="asidetitle">Weibo</p>
    <iframe width="100%" height="119" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=119&fansRow=2&ptype=1&speed=0&skin=9&isTitle=1&noborder=1&isWeibo=0&isFans=0&uid=&verifier=b3593ceb&dpc=1"></iframe>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello ,I&#39;m Larry Page in Google. <br/>
			This is my blog,believe it or not.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/2176287895" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		
		
		
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2020 
		
		<a href="/about" target="_blank" title="Stevin">Stevin</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
        
    }
  });
});
</script>












<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?e6d1f421bbc9962127a50488f9ed37d1";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="Back to Top"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
 </html>
