<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  

  
  <title>Almost</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Almost">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Almost">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Almost">
  
    <link rel="alternate" href="/atom.xml" title="Almost" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Almost</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-Webpack-03loader" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/02/28/Webpack-03loader/" class="article-date">
  <time datetime="2021-02-28T03:03:07.000Z" itemprop="datePublished">2021-02-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/02/28/Webpack-03loader/">Webpack-03loader</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="loader"><a href="#loader" class="headerlink" title="loader"></a>loader</h1><h2 id="如何加载css文件"><a href="#如何加载css文件" class="headerlink" title="如何加载css文件"></a>如何加载css文件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">// 收集依赖读取代码 看见 import/require 的时候</span><br><span class="line">const code = readFileSync(filepath).toString()</span><br><span class="line"></span><br><span class="line">// 重点：正则判断</span><br><span class="line">if(/\.css$/.test(filepath))&#123;</span><br><span class="line">  // 此时 css文件的内容 变成了 js的一个字符串</span><br><span class="line">  code = `</span><br><span class="line">    const str = $&#123;JSON.stringify(code)&#125;</span><br><span class="line">    if(document)&#123;</span><br><span class="line">      const style = document.createElement(&apos;style&apos;)</span><br><span class="line">      style.innerHTML = str;</span><br><span class="line">      document.head.appendChild(style)</span><br><span class="line">    &#125;</span><br><span class="line">    export default str;</span><br><span class="line">  `</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="loader-可以是一个函数-or-异步函数"><a href="#loader-可以是一个函数-or-异步函数" class="headerlink" title="loader 可以是一个函数 or 异步函数"></a>loader 可以是一个函数 or 异步函数</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">function transform(code)&#123;</span><br><span class="line">  const code2 = doXXX(code)</span><br><span class="line">  return code2</span><br><span class="line">&#125;</span><br><span class="line">module.exports = transform</span><br><span class="line"></span><br><span class="line">// or</span><br><span class="line">async function transform(code)&#123;</span><br><span class="line">  const code2 = await doXXX(code)</span><br><span class="line">  return code2</span><br><span class="line">&#125;</span><br><span class="line">module.exports = transform</span><br></pre></td></tr></table></figure>
<ul>
<li>css-loader.js</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">function transform(code)&#123;</span><br><span class="line">  return `</span><br><span class="line">    const str= $&#123;JSON.stringify(code)&#125;</span><br><span class="line">    if(document)&#123;</span><br><span class="line">      const style = document.createElement(&apos;style&apos;)</span><br><span class="line">      style.innerHTML = str;</span><br><span class="line">      document.head.appendChild(style)</span><br><span class="line">    &#125;</span><br><span class="line">    export default str;</span><br><span class="line">  `</span><br><span class="line">&#125;</span><br><span class="line">module.exports = transform</span><br></pre></td></tr></table></figure>
<ul>
<li>核心逻辑<ul>
<li>为啥用 require 加载loader,因为webpack的loader是从 config里读取的，要动态的加载</li>
<li>第二个原因是 旧版的node不支持 import</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if(/\.css$/.test(filepath))&#123;</span><br><span class="line">  // 此时 css文件的内容 变成了 js的一个字符串</span><br><span class="line">  code = require(&apos;./loaders/css-loader.js&apos;)(code)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="loader的优化"><a href="#loader的优化" class="headerlink" title="loader的优化"></a>loader的优化</h3><ul>
<li>单一职责原则</li>
<li>每个loader只做一件事</li>
</ul>
<h4 id="大概流程"><a href="#大概流程" class="headerlink" title="大概流程"></a>大概流程</h4><ul>
<li>sass-loader 将 <code>.scss</code> 文件转化为 <code>.css</code></li>
<li>css-loader 将 <code>.css</code> 文件转化为 js 里的一个变量 字符串str</li>
<li>style-loader  通过 生成style标签 将 str 内容插入到 style里<ul>
<li>本质是在 原有代码基础上 插入一部分代码</li>
<li>这个时机在哪？这个要参考webpack</li>
</ul>
</li>
</ul>
<h4 id="webpack-style-loader思路"><a href="#webpack-style-loader思路" class="headerlink" title="webpack style-loader思路"></a>webpack style-loader思路</h4><ul>
<li>style-loader 在 pitch 钩子里通过 css-loader 来require 内容</li>
<li>然后</li>
</ul>
<h3 id="webpack-loader-是什么"><a href="#webpack-loader-是什么" class="headerlink" title="webpack-loader 是什么"></a>webpack-loader 是什么</h3><ul>
<li>webpack自带的打包只支持 js</li>
<li>当我们想要加载 css/scss/ts/md 文件时，需要用loader</li>
<li>loader 原理就是把文件内容包装成能运行的JS</li>
</ul>
<blockquote>
<p>例如</p>
</blockquote>
<ul>
<li>加载 css 用到 style-loader 和 css-loader</li>
<li>css-loader 把代码 从 CSS 变成 export default str 形式的JS</li>
<li>style-loader 把代码挂在到 head 里的 style 里</li>
</ul>
<blockquote>
<p>例如</p>
</blockquote>
<ul>
<li>file-loader 如果是 图片，图片小就变成 base64,图片大就在 形如public 的资源目录里生成这个文件，然后读取这个文件的相对路径</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2021/02/28/Webpack-03loader/" data-id="cknvgpu9d00zy0xjpws3bj6ue" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Webpack/">Webpack</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Webpack-02打包器" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/02/27/Webpack-02打包器/" class="article-date">
  <time datetime="2021-02-27T10:54:33.000Z" itemprop="datePublished">2021-02-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/02/27/Webpack-02打包器/">Webpack-02打包器</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Webpack解决那些问题"><a href="#Webpack解决那些问题" class="headerlink" title="Webpack解决那些问题"></a>Webpack解决那些问题</h1><ul>
<li>浏览器不支持 <code>import/export</code>,因为浏览器里这样运行不了</li>
<li>代码<a href="https://github.com/slTrust/webpack-demo-2" target="_blank" rel="noopener">仓库</a></li>
<li>安装好依赖</li>
</ul>
<h2 id="怎样解决这个问题"><a href="#怎样解决这个问题" class="headerlink" title="怎样解决这个问题"></a>怎样解决这个问题</h2><h3 id="不同浏览器功能不同"><a href="#不同浏览器功能不同" class="headerlink" title="不同浏览器功能不同"></a>不同浏览器功能不同</h3><ul>
<li>现代浏览器可以通过<code>&lt;script type=&quot;module&quot;&gt;</code> 来支持 import/export</li>
<li>但是 IE8~15 不支持</li>
</ul>
<h3 id="兼容策略"><a href="#兼容策略" class="headerlink" title="兼容策略"></a>兼容策略</h3><ul>
<li>激进策略：所有代码放到 <code>&lt;script type=&quot;module&quot;&gt;</code> 里<ul>
<li>缺点：<ul>
<li>http请求文件过多</li>
<li>不被IE支持</li>
</ul>
</li>
</ul>
</li>
<li>平稳兼容：把关键字转译为普通代码，并把所有文件打包为一个文件<ul>
<li>缺点：需要写复杂的代码，完成这个事。<strong>这就是我们的任务</strong></li>
</ul>
</li>
</ul>
<h2 id="解决问题1-import-export-转化成函数"><a href="#解决问题1-import-export-转化成函数" class="headerlink" title="解决问题1: import/export 转化成函数"></a>解决问题1: import/export 转化成函数</h2><ul>
<li>通过<code>@babel/preset-env</code> 把ES6 转化为 ES5</li>
<li>bundler_1.ts</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">const code = readFileSync(filepath).toString()</span><br><span class="line">// step01 code 不要原封不动的放到 这里，而是变成es5</span><br><span class="line">const &#123; code: es5Code &#125; = babel.transform(code, &#123;</span><br><span class="line">  presets: [&apos;@babel/preset-env&apos;]</span><br><span class="line">&#125;)</span><br><span class="line">// 初始化 depRelation[key]</span><br><span class="line">depRelation[key] = &#123; deps: [], code: es5Code &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>运行<code>node -r ts-node/register bundler_1.ts</code> 后打印 depRelation</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &apos;index.js&apos;: &#123;</span><br><span class="line">    deps: [ &apos;a.js&apos;, &apos;b.js&apos; ],</span><br><span class="line">    code: &apos;&quot;use strict&quot;;\n&apos; +</span><br><span class="line">      &apos;\n&apos; +</span><br><span class="line">      &apos;var _a = _interopRequireDefault(require(&quot;./a.js&quot;));\n&apos; +</span><br><span class="line">      &apos;\n&apos; +</span><br><span class="line">      &apos;var _b = _interopRequireDefault(require(&quot;./b.js&quot;));\n&apos; +</span><br><span class="line">      &apos;\n&apos; +</span><br><span class="line">      &apos;function _interopRequireDefault(obj) &#123; return obj &amp;&amp; obj.__esModule ? obj : &#123; &quot;default&quot;: obj &#125;; &#125;\n&apos; +</span><br><span class="line">      &apos;\n&apos; +</span><br><span class="line">      &apos;console.log(_a[&quot;default&quot;].getB());\n&apos; +</span><br><span class="line">      &apos;console.log(_b[&quot;default&quot;].getA());&apos;</span><br><span class="line">  &#125;,</span><br><span class="line">  &apos;a.js&apos;: &#123;</span><br><span class="line">    deps: [ &apos;b.js&apos; ],</span><br><span class="line">    code: &apos;&quot;use strict&quot;;\n&apos; +</span><br><span class="line">      &apos;\n&apos; +</span><br><span class="line">      &apos;Object.defineProperty(exports, &quot;__esModule&quot;, &#123;\n&apos; +</span><br><span class="line">      &apos;  value: true\n&apos; +</span><br><span class="line">      &apos;&#125;);\n&apos; +</span><br><span class="line">      &apos;exports[&quot;default&quot;] = void 0;\n&apos; +</span><br><span class="line">      &apos;\n&apos; +</span><br><span class="line">      &apos;var _b = _interopRequireDefault(require(&quot;./b.js&quot;));\n&apos; +</span><br><span class="line">      &apos;\n&apos; +</span><br><span class="line">      &apos;function _interopRequireDefault(obj) &#123; return obj &amp;&amp; obj.__esModule ? obj : &#123; &quot;default&quot;: obj &#125;; &#125;\n&apos; +</span><br><span class="line">      &apos;\n&apos; +</span><br><span class="line">      &apos;var a = &#123;\n&apos; +</span><br><span class="line">      &quot;  value: &apos;a&apos;,\n&quot; +</span><br><span class="line">      &apos;  getB: function getB() &#123;\n&apos; +</span><br><span class="line">      `    return _b[&quot;default&quot;].value + &apos; from a.js&apos;;\n` +</span><br><span class="line">      &apos;  &#125;\n&apos; +</span><br><span class="line">      &apos;&#125;;\n&apos; +</span><br><span class="line">      &apos;var _default = a;\n&apos; +</span><br><span class="line">      &apos;exports[&quot;default&quot;] = _default;&apos;</span><br><span class="line">  &#125;,</span><br><span class="line">  &apos;b.js&apos;: &#123;</span><br><span class="line">    deps: [ &apos;a.js&apos; ],</span><br><span class="line">    code: &apos;&quot;use strict&quot;;\n&apos; +</span><br><span class="line">      &apos;\n&apos; +</span><br><span class="line">      &apos;Object.defineProperty(exports, &quot;__esModule&quot;, &#123;\n&apos; +</span><br><span class="line">      &apos;  value: true\n&apos; +</span><br><span class="line">      &apos;&#125;);\n&apos; +</span><br><span class="line">      &apos;exports[&quot;default&quot;] = void 0;\n&apos; +</span><br><span class="line">      &apos;\n&apos; +</span><br><span class="line">      &apos;var _a = _interopRequireDefault(require(&quot;./a.js&quot;));\n&apos; +</span><br><span class="line">      &apos;\n&apos; +</span><br><span class="line">      &apos;function _interopRequireDefault(obj) &#123; return obj &amp;&amp; obj.__esModule ? obj : &#123; &quot;default&quot;: obj &#125;; &#125;\n&apos; +</span><br><span class="line">      &apos;\n&apos; +</span><br><span class="line">      &apos;var b = &#123;\n&apos; +</span><br><span class="line">      &quot;  value: &apos;b&apos;,\n&quot; +</span><br><span class="line">      &apos;  getA: function getA() &#123;\n&apos; +</span><br><span class="line">      `    return _a[&quot;default&quot;].value + &apos; from b.js&apos;;\n` +</span><br><span class="line">      &apos;  &#125;\n&apos; +</span><br><span class="line">      &apos;&#125;;\n&apos; +</span><br><span class="line">      &apos;var _default = b;\n&apos; +</span><br><span class="line">      &apos;exports[&quot;default&quot;] = _default;&apos;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="观察a-js变化"><a href="#观察a-js变化" class="headerlink" title="观察a.js变化"></a>观察a.js变化</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// a.js代码</span><br><span class="line">import b from &apos;./b.js&apos;</span><br><span class="line">const a = &#123;</span><br><span class="line">  value: &apos;a&apos;,</span><br><span class="line">  getB: () =&gt; b.value + &apos; from a.js&apos;</span><br><span class="line">&#125;</span><br><span class="line">export default a</span><br></pre></td></tr></table></figure>
<ul>
<li>import 不见了，变成了 <code>require()</code></li>
<li>export 不见了，变成了 <code>exports[&#39;default&#39;]</code></li>
<li>这里的code 是字符串</li>
</ul>
<h3 id="es5后的-a-js内容字符串整理"><a href="#es5后的-a-js内容字符串整理" class="headerlink" title="es5后的 a.js内容字符串整理"></a>es5后的 a.js内容字符串整理</h3><ul>
<li>疑问1<ul>
<li>实际效果是 <code>exports[&#39;__esModule&#39;]=true</code></li>
<li>给当前模块添加 __esModule 属性，方便跟 CommonJS模块 区分</li>
<li>这样写是为了解决特定环境的一些问题，不要细究。。。</li>
</ul>
</li>
<li>疑问2 <code>exports[&quot;default&quot;] = void 0;</code><ul>
<li><code>void 0; // 等价于 赋值 undefined</code></li>
<li>强制清空 <code>exports[&#39;default&#39;]</code>的值</li>
</ul>
</li>
<li>疑问3 <code>import b from &#39;./b.js&#39;</code> 变成了 <code>var _b = _interopRequireDefault(require(&quot;./b.js&quot;));</code><ul>
<li><code>_interopRequireDefault</code> _ 代表内部的一个函数</li>
<li>意图就是给模块添加 default</li>
</ul>
</li>
<li>疑问4<ul>
<li>给 require 的obj添加一个 default</li>
<li>如果是 _esModule 代表有默认导出</li>
<li>反之 <code>obj = { &quot;default&quot;: obj }</code></li>
</ul>
</li>
<li>疑问5 <code>b.value  变成了 _b[&quot;default&quot;].value</code><ul>
<li>因为 require 的obj 经过 <code>_interopRequireDefault</code> 处理，有了默认 <code>obj:{default:obj}</code></li>
<li>所以 变成了 <code>_b[&quot;default&quot;].value</code></li>
</ul>
</li>
<li>疑问6 <code>var _default = a;exports[&quot;default&quot;] = _default;</code><ul>
<li>简化后就是 <code>exports[&#39;default&#39;] = a</code></li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&quot;use strict&quot;; //开启严格模式</span><br><span class="line">// 疑问1</span><br><span class="line">Object.defineProperty(exports, &quot;__esModule&quot;, &#123;value: true&#125;);</span><br><span class="line">// 疑问2</span><br><span class="line">exports[&quot;default&quot;] = void 0; </span><br><span class="line"></span><br><span class="line">// 疑问3</span><br><span class="line">var _b = _interopRequireDefault(require(&quot;./b.js&quot;));</span><br><span class="line"></span><br><span class="line">// 疑问4</span><br><span class="line">function _interopRequireDefault(obj) &#123; </span><br><span class="line">  return obj &amp;&amp; obj._esModule ? obj : &#123; &quot;default&quot;: obj &#125;; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var a = &#123;</span><br><span class="line">  value: &apos;a&apos;,</span><br><span class="line">  getB: function getB() &#123;</span><br><span class="line">    // 疑问5 </span><br><span class="line">    return _b[&quot;default&quot;].value + &apos; from a.js&apos;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">// 疑问6</span><br><span class="line">var _default = a;</span><br><span class="line">exports[&quot;default&quot;] = _default;</span><br></pre></td></tr></table></figure>
<ul>
<li>结论：我们通过 babel/core 把 ESModule 语法变成了 CommonJS 规则<ul>
<li>CommonJS 就是使用 require/exports 定义模块</li>
</ul>
</li>
</ul>
<h2 id="打包所有文件成为一个文件"><a href="#打包所有文件成为一个文件" class="headerlink" title="打包所有文件成为一个文件"></a>打包所有文件成为一个文件</h2><ul>
<li>所有改动参考 <code>bundler_1.ts =&gt; bundler_1.ts</code></li>
</ul>
<h3 id="第一步：改变depRelation的结构为数组"><a href="#第一步：改变depRelation的结构为数组" class="headerlink" title="第一步：改变depRelation的结构为数组"></a>第一步：改变depRelation的结构为数组</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">var depRelation = [</span><br><span class="line">  &#123;</span><br><span class="line">    key:&apos;index.js&apos;,</span><br><span class="line">    deps:[&apos;a.js&apos;,&apos;b.js&apos;],</span><br><span class="line">    code:`字符串code`</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    key:&apos;a.js&apos;,</span><br><span class="line">    deps:[&apos;b.js&apos;],</span><br><span class="line">    code:`字符串code`</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    key:&apos;b.js&apos;,</span><br><span class="line">    deps:[&apos;a.js&apos;],</span><br><span class="line">    code:`字符串code`</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">// 为什么把 depRelation 变成了数组，因为对象&#123;&#125; 没有第一项的概念</span><br><span class="line">// 数组第一项是入口</span><br></pre></td></tr></table></figure>
<h3 id="第二步：code是字符串，需要变成一个函数"><a href="#第二步：code是字符串，需要变成一个函数" class="headerlink" title="第二步：code是字符串，需要变成一个函数"></a>第二步：code是字符串，需要变成一个函数</h3><ul>
<li>require, module, exports 是 CommonJS2 的规范<ul>
<li>module基本用不到，可以忽略</li>
<li>重点看 require/exports</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">code2 = `function (require, module, exports) &#123;</span><br><span class="line">  $&#123;code&#125;</span><br><span class="line">&#125;`</span><br><span class="line">// 此时 code2还是字符串</span><br><span class="line">// 把 `code:$&#123;code2&#125;`写入到文件</span><br><span class="line">code:function (require, module, exports) &#123;</span><br><span class="line">  // ... code代码</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 最终写入的文件效果</span><br><span class="line">var depRelation = [</span><br><span class="line">  &#123;</span><br><span class="line">    key:&apos;index.js&apos;,</span><br><span class="line">    deps:[&apos;a.js&apos;,&apos;b.js&apos;],</span><br><span class="line">    code:function (require, module, exports) &#123;</span><br><span class="line">      // ... code代码</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  ...</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h3 id="第三步：execute-这个入口"><a href="#第三步：execute-这个入口" class="headerlink" title="第三步：execute 这个入口"></a>第三步：execute 这个入口</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">const modules = &#123;&#125; // 用于缓存，防止重复加载</span><br><span class="line">execute(depRelation[0].key) // a.js</span><br><span class="line">function execute(key) &#123;</span><br><span class="line">  // 如果已经 require 过，就直接返回上次的结果</span><br><span class="line">  if (modules[key]) &#123; return modules[key] &#125;</span><br><span class="line">  // 找到 a.js 的代码</span><br><span class="line">  var item = depRelation.find(i =&gt; i.key === key) </span><br><span class="line">  // 找不到就报错，中断执行</span><br><span class="line">  if (!item) &#123; throw new Error(`$&#123;item&#125; is not found`) &#125;</span><br><span class="line">  // 把相对路径变成项目路径</span><br><span class="line">  var pathToKey = (path) =&gt; &#123;...&#125;</span><br><span class="line">  // 创建 require 函数</span><br><span class="line">  var require = (path) =&gt; &#123;</span><br><span class="line">    return execute(pathToKey(path))</span><br><span class="line">  &#125;</span><br><span class="line">  // 初始化当前模块</span><br><span class="line">  // modules[&apos;a.js&apos;] = &#123; __esModule: true &#125; 辨识我是ES模块</span><br><span class="line">  modules[key] = &#123; __esModule: true &#125;</span><br><span class="line">  // 初始化 module 方便 code 往 module.exports 上添加属性</span><br><span class="line">  //  module = &#123; exports: modules[&apos;a.js&apos;] &#125;</span><br><span class="line">  var module = &#123; exports: modules[key] &#125;</span><br><span class="line">  // 调用 code 函数，往 module.exports 上添加导出属性</span><br><span class="line">  // 第二个参数 module 大部分时候是无用的，主要用于兼容旧代码</span><br><span class="line">  item.code(require, module, module.exports)</span><br><span class="line">  // item.code执行的时候，把它导出的内容挂在 module.exports</span><br><span class="line"></span><br><span class="line">  // 返回当前模块 modules[&apos;a.js&apos;]</span><br><span class="line">  return modules[key]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="最终dist-js文件的内容"><a href="#最终dist-js文件的内容" class="headerlink" title="最终dist.js文件的内容"></a>最终dist.js文件的内容</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">var depRelation = [&#123;</span><br><span class="line">  key: &quot;index.js&quot;,</span><br><span class="line">  deps: [&quot;a.js&quot;, &quot;b.js&quot;],</span><br><span class="line">  code: function (require, module, exports) &#123;</span><br><span class="line">    &quot;use strict&quot;;</span><br><span class="line"></span><br><span class="line">    var _a = _interopRequireDefault(require(&quot;./a.js&quot;));</span><br><span class="line"></span><br><span class="line">    var _b = _interopRequireDefault(require(&quot;./b.js&quot;));</span><br><span class="line"></span><br><span class="line">    function _interopRequireDefault(obj) &#123; return obj &amp;&amp; obj.__esModule ? obj : &#123; &quot;default&quot;: obj &#125;; &#125;</span><br><span class="line"></span><br><span class="line">    console.log(_a[&quot;default&quot;].getB());</span><br><span class="line">    console.log(_b[&quot;default&quot;].getA());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;, &#123;</span><br><span class="line">  key: &quot;a.js&quot;,</span><br><span class="line">  deps: [&quot;b.js&quot;],</span><br><span class="line">  code: function (require, module, exports) &#123;</span><br><span class="line">    &quot;use strict&quot;;</span><br><span class="line"></span><br><span class="line">    Object.defineProperty(exports, &quot;__esModule&quot;, &#123;</span><br><span class="line">      value: true</span><br><span class="line">    &#125;);</span><br><span class="line">    exports[&quot;default&quot;] = void 0;</span><br><span class="line"></span><br><span class="line">    var _b = _interopRequireDefault(require(&quot;./b.js&quot;));</span><br><span class="line"></span><br><span class="line">    function _interopRequireDefault(obj) &#123; return obj &amp;&amp; obj.__esModule ? obj : &#123; &quot;default&quot;: obj &#125;; &#125;</span><br><span class="line"></span><br><span class="line">    var a = &#123;</span><br><span class="line">      value: &apos;a&apos;,</span><br><span class="line">      getB: function getB() &#123;</span><br><span class="line">        return _b[&quot;default&quot;].value + &apos; from a.js&apos;;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    var _default = a;</span><br><span class="line">    exports[&quot;default&quot;] = _default;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;, &#123;</span><br><span class="line">  key: &quot;b.js&quot;,</span><br><span class="line">  deps: [&quot;a.js&quot;],</span><br><span class="line">  code: function (require, module, exports) &#123;</span><br><span class="line">    &quot;use strict&quot;;</span><br><span class="line"></span><br><span class="line">    Object.defineProperty(exports, &quot;__esModule&quot;, &#123;</span><br><span class="line">      value: true</span><br><span class="line">    &#125;);</span><br><span class="line">    exports[&quot;default&quot;] = void 0;</span><br><span class="line"></span><br><span class="line">    var _a = _interopRequireDefault(require(&quot;./a.js&quot;));</span><br><span class="line"></span><br><span class="line">    function _interopRequireDefault(obj) &#123; return obj &amp;&amp; obj.__esModule ? obj : &#123; &quot;default&quot;: obj &#125;; &#125;</span><br><span class="line"></span><br><span class="line">    var b = &#123;</span><br><span class="line">      value: &apos;b&apos;,</span><br><span class="line">      getA: function getA() &#123;</span><br><span class="line">        return _a[&quot;default&quot;].value + &apos; from b.js&apos;;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    var _default = b;</span><br><span class="line">    exports[&quot;default&quot;] = _default;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;]</span><br><span class="line">var modules = &#123;&#125;</span><br><span class="line">execute(depRelation[0].key)</span><br><span class="line">function execute(key) &#123;</span><br><span class="line">  // 如果已经 require 过，就直接返回上次的结果</span><br><span class="line">  if (modules[key]) &#123; return modules[key] &#125;</span><br><span class="line">  // 找到要执行的项目</span><br><span class="line">  var item = depRelation.find(i =&gt; i.key === key)</span><br><span class="line">  // 找不到就报错，中断执行</span><br><span class="line">  if (!item) &#123; throw new Error(`$&#123;item&#125; is not found`) &#125;</span><br><span class="line">  // 把相对路径变成项目路径</span><br><span class="line">  var pathToKey = (path) =&gt; &#123;</span><br><span class="line">    var dirname = key.substring(0, key.lastIndexOf(&apos;/&apos;) + 1)</span><br><span class="line">    var projectPath = (dirname + path).replace(/\.\//g, &apos;&apos;).replace(/\/\//, &apos;/&apos;)</span><br><span class="line">    return projectPath</span><br><span class="line">  &#125;</span><br><span class="line">  // 创建 require 函数</span><br><span class="line">  var require = (path) =&gt; &#123;</span><br><span class="line">    return execute(pathToKey(path))</span><br><span class="line">  &#125;</span><br><span class="line">  // 初始化当前模块</span><br><span class="line">  modules[key] = &#123; __esModule: true &#125;</span><br><span class="line">  // 初始化 module 方便 code 往 module.exports 上添加属性</span><br><span class="line">  var module = &#123; exports: modules[key] &#125;</span><br><span class="line">  // 调用 code 函数，往 module.exports 上添加导出属性</span><br><span class="line">  // 第二个参数 module 大部分时候是无用的，主要用于兼容旧代码</span><br><span class="line">  item.code(require, module, module.exports)</span><br><span class="line">  // 返回当前模块</span><br><span class="line">  return modules[key]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="打包器完成"><a href="#打包器完成" class="headerlink" title="打包器完成"></a>打包器完成</h2><ul>
<li>拼接构造 dist.js 的内容，然后写入到文件</li>
<li>参考 bundeler_3.ts 内容</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2021/02/27/Webpack-02打包器/" data-id="cknvgpu9g01020xjpk8r4wmvk" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Webpack/">Webpack</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Webpack-01AST-Babel-依赖" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/02/27/Webpack-01AST-Babel-依赖/" class="article-date">
  <time datetime="2021-02-27T08:42:51.000Z" itemprop="datePublished">2021-02-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/02/27/Webpack-01AST-Babel-依赖/">Webpack-01AST_Babel_依赖</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Webpack"><a href="#Webpack" class="headerlink" title="Webpack"></a>Webpack</h1><h2 id="前置工作"><a href="#前置工作" class="headerlink" title="前置工作"></a>前置工作</h2><ul>
<li>下载代码<a href="https://github.com/slTrust/webpack-demo-1" target="_blank" rel="noopener">仓库</a></li>
<li>安装好依赖，参考README 运行我们的代码</li>
</ul>
<h2 id="Babel原理"><a href="#Babel原理" class="headerlink" title="Babel原理"></a>Babel原理</h2><ul>
<li>parse：把代码code变成 AST</li>
<li>traverse:遍历 AST 进行修改</li>
<li>generate：把修改后的 AST 变成 code2</li>
</ul>
<blockquote>
<p>过程如下</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">       parse        traverse       generate</span><br><span class="line">code --------&gt; ast  -------&gt;  ast2 -------&gt; code2</span><br></pre></td></tr></table></figure>
<h3 id="为啥不用-“正则”-来实现"><a href="#为啥不用-“正则”-来实现" class="headerlink" title="为啥不用 “正则” 来实现"></a>为啥不用 “正则” 来实现</h3><ul>
<li>因为代码很复杂 <code>let a = &#39;let&#39;</code> 单纯一个变量声明，你就很难处理，更何况其他ES6及以上语法呢？</li>
</ul>
<h3 id="let-to-var"><a href="#let-to-var" class="headerlink" title="let to var"></a>let to var</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">import &#123; parse &#125; from &quot;@babel/parser&quot;</span><br><span class="line">import traverse from &quot;@babel/traverse&quot;</span><br><span class="line">import generate from &quot;@babel/generator&quot;</span><br><span class="line"></span><br><span class="line">const code = `let a = &apos;let&apos;; let b = 2`</span><br><span class="line">const ast = parse(code, &#123; sourceType: &apos;module&apos; &#125;)</span><br><span class="line">traverse(ast, &#123;</span><br><span class="line">  enter: item =&gt; &#123;</span><br><span class="line">    if (item.node.type === &apos;VariableDeclaration&apos;) &#123;</span><br><span class="line">      if (item.node.kind === &apos;let&apos;) &#123;</span><br><span class="line">        item.node.kind = &apos;var&apos;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line">const result = generate(ast, &#123;&#125;, code)</span><br><span class="line">console.log(result.code)</span><br></pre></td></tr></table></figure>
<h3 id="代码转换为ES5"><a href="#代码转换为ES5" class="headerlink" title="代码转换为ES5"></a>代码转换为ES5</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">import &#123; parse &#125; from &quot;@babel/parser&quot;</span><br><span class="line">import * as babel from &quot;@babel/core&quot;</span><br><span class="line"></span><br><span class="line">const code = `let a = &apos;let&apos;;let b = 2; const c = 3`</span><br><span class="line">const ast = parse(code, &#123; sourceType: &apos;module&apos; &#125;)</span><br><span class="line">const result = babel.transformFromAstSync(ast, code, &#123;</span><br><span class="line">  presets: [&apos;@babel/preset-env&apos;]</span><br><span class="line">&#125;)</span><br><span class="line">console.log(result.code)</span><br></pre></td></tr></table></figure>
<h3 id="将js文件转换为ES5"><a href="#将js文件转换为ES5" class="headerlink" title="将js文件转换为ES5"></a>将js文件转换为ES5</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">import &#123; parse &#125; from &quot;@babel/parser&quot;</span><br><span class="line">import * as babel from &quot;@babel/core&quot;</span><br><span class="line">import * as fs from &apos;fs&apos;</span><br><span class="line"></span><br><span class="line">const code = fs.readFileSync(&apos;./test.js&apos;).toString()</span><br><span class="line">const ast = parse(code, &#123; sourceType: &apos;module&apos; &#125;)</span><br><span class="line">const result = babel.transformFromAstSync(ast, code, &#123;</span><br><span class="line">  presets: [&apos;@babel/preset-env&apos;]</span><br><span class="line">&#125;)</span><br><span class="line">fs.writeFileSync(&apos;./test.es5.js&apos;, result.code)</span><br></pre></td></tr></table></figure>
<h2 id="除了转换ES5代码还能做什么"><a href="#除了转换ES5代码还能做什么" class="headerlink" title="除了转换ES5代码还能做什么"></a>除了转换ES5代码还能做什么</h2><h3 id="依赖分析-004-dep-ts"><a href="#依赖分析-004-dep-ts" class="headerlink" title="依赖分析: 004_dep.ts"></a>依赖分析: 004_dep.ts</h3><ul>
<li>project1目录的 index.js</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">import a from &apos;./a.js&apos;</span><br><span class="line">import b from &apos;./b.js&apos;</span><br><span class="line">console.log(a.value + b.value)</span><br></pre></td></tr></table></figure>
<h4 id="代码思路-004-dep-ts"><a href="#代码思路-004-dep-ts" class="headerlink" title="代码思路 004_dep.ts"></a>代码思路 004_dep.ts</h4><p>1、调用 collectCodeAndDeps(‘index.js’)<br>2、 先把 depRelation[‘index.js’] 初始化为 { deps: [], code: ‘index.js的源码’ }<br>3、然后把 index.js 源码 code 变成 ast<br>4、遍历 ast，看看 import 了哪些依赖，假设依赖了 a.js 和 b.js<br>5、把 a.js 和 b.js 写到 depRelation[‘index.js’].deps 里<br>6、最终得到的 depRelation 就收集了 index.js 的依赖 </p>
<h3 id="升级：依赖里还有依赖-005-dep-ts"><a href="#升级：依赖里还有依赖-005-dep-ts" class="headerlink" title="升级：依赖里还有依赖 005_dep.ts"></a>升级：依赖里还有依赖 005_dep.ts</h3><ul>
<li><p>三层依赖关系</p>
</li>
<li><p>index.js -&gt; a -&gt; dir/a2 -&gt; dir/dir_in_dir/a3</p>
</li>
<li>index.js -&gt; b -&gt; dir/b2 -&gt; dir/dir_in_dir/b3</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">function collectCodeAndDeps(filepath: string) &#123;</span><br><span class="line">  const key = getProjectPath(filepath) // 文件的项目路径，如 index.js</span><br><span class="line">  // 获取文件内容，将内容放至 depRelation</span><br><span class="line">  const code = readFileSync(filepath).toString()</span><br><span class="line">  // 初始化 depRelation[key]</span><br><span class="line">  depRelation[key] = &#123; deps: [], code: code &#125;</span><br><span class="line">  // 将代码转为 AST</span><br><span class="line">  const ast = parse(code, &#123; sourceType: &apos;module&apos; &#125;)</span><br><span class="line">  // 分析文件依赖，将内容放至 depRelation</span><br><span class="line">  traverse(ast, &#123;</span><br><span class="line">    enter: path =&gt; &#123;</span><br><span class="line">      if (path.node.type === &apos;ImportDeclaration&apos;) &#123;</span><br><span class="line">        // path.node.source.value 往往是一个相对路径，如 ./a.js，需要先把它转为一个绝对路径</span><br><span class="line">        const depAbsolutePath = resolve(dirname(filepath), path.node.source.value)</span><br><span class="line">        // 然后转为项目路径</span><br><span class="line">        const depProjectPath = getProjectPath(depAbsolutePath)</span><br><span class="line">        // 把依赖写进 depRelation</span><br><span class="line">        depRelation[key].deps.push(depProjectPath)</span><br><span class="line"></span><br><span class="line">        // 递归依赖收集的核心一句话</span><br><span class="line">        // 递归依赖收集的核心一句话</span><br><span class="line">        // 递归依赖收集的核心一句话</span><br><span class="line">        collectCodeAndDeps(depAbsolutePath)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h4><ul>
<li>collectCodeAndDeps 太长了，缩写为 collect</li>
<li>调用 collect(‘index.js’)</li>
<li>发现依赖 ‘./a.js’ 于是调用 collect(‘a.js’)</li>
<li>发现依赖 ‘./dir/a2.js’ 于是调用 collect(‘dir/a2.js’)</li>
<li>发现依赖 ‘./dir_in_dir/a3.js’ 于是调用 collect(‘dir/dir_in_dir/a3.js’)</li>
<li>没有更多依赖了，a.js 这条线结束，发现下一个依赖 ‘./b.js’</li>
<li>以此类推，其实就是递归</li>
</ul>
<h3 id="代码如果是循环依赖呢-006-dep-ts"><a href="#代码如果是循环依赖呢-006-dep-ts" class="headerlink" title="代码如果是循环依赖呢? 006_dep.ts"></a>代码如果是循环依赖呢? 006_dep.ts</h3><ul>
<li>index -&gt; a -&gt; b</li>
<li>index -&gt; b -&gt; a</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">// a.js</span><br><span class="line">import b from &apos;./b.js&apos;</span><br><span class="line">const a = &#123;</span><br><span class="line">  value: b.value + 1,</span><br><span class="line">&#125;</span><br><span class="line">export default a</span><br><span class="line"></span><br><span class="line">// b.js</span><br><span class="line">import a from &apos;./a.js&apos;</span><br><span class="line">const b = &#123;</span><br><span class="line">  value: a.value + 1,</span><br><span class="line">&#125;</span><br><span class="line">export default b</span><br></pre></td></tr></table></figure>
<ul>
<li>求值</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// a.js里</span><br><span class="line">a.value = b.value +1</span><br><span class="line">// b.js里</span><br><span class="line">b.value = a.value +1</span><br><span class="line"></span><br><span class="line">// 神经病，a 依赖b，但是 b必须先执行，同时 b又依赖 a</span><br><span class="line">// 运行代码 报错</span><br><span class="line">Maximum call stack size exceeded</span><br><span class="line">// 爆栈了</span><br></pre></td></tr></table></figure>
<h4 id="难道不能-“循环依赖”吗？007-dep-ts"><a href="#难道不能-“循环依赖”吗？007-dep-ts" class="headerlink" title="难道不能 “循环依赖”吗？007_dep.ts"></a>难道不能 “循环依赖”吗？007_dep.ts</h4><h3 id="解决循环依赖问题，用一个map-，如果已经读取过，就return"><a href="#解决循环依赖问题，用一个map-，如果已经读取过，就return" class="headerlink" title="解决循环依赖问题，用一个map ，如果已经读取过，就return"></a>解决循环依赖问题，用一个map ，如果已经读取过，就return</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if (Object.keys(depRelation).includes(key)) &#123;</span><br><span class="line">  console.warn(`duplicated dependency: $&#123;key&#125;`) // 注意，重复依赖不一定是循环依赖</span><br><span class="line">  return</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>分析依赖，是不需要执行代码的，所以这是可行的</li>
<li>由于不需要执行代码，所以这个叫做“静态分析”</li>
<li>假如执行代码，就会出现循环引用问题</li>
</ul>
<h4 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h4><ul>
<li>模块里可以循环依赖<ul>
<li><code>a-&gt;b,b-&gt;a</code></li>
</ul>
</li>
<li>但是不能有逻辑漏洞<ul>
<li><code>a.value = b.value +1</code></li>
<li><code>b.value = a.value +1</code></li>
</ul>
</li>
<li>如何写出解决循环依赖的代码 project5 </li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">// a.js</span><br><span class="line">import b from &apos;./b.js&apos;</span><br><span class="line">const a = &#123;</span><br><span class="line">  value: &apos;a&apos;,</span><br><span class="line">  getB: () =&gt; b.value + &apos; from a.js&apos;</span><br><span class="line">&#125;</span><br><span class="line">export default a</span><br><span class="line"></span><br><span class="line">// b.js</span><br><span class="line">import a from &apos;./a.js&apos;</span><br><span class="line">const b = &#123;</span><br><span class="line">  value: &apos;b&apos;,</span><br><span class="line">  getA: () =&gt; a.value + &apos; from b.js&apos;</span><br><span class="line">&#125;</span><br><span class="line">export default b</span><br></pre></td></tr></table></figure>
<p><strong>这样循环链就断了，运行就不会报错</strong></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><h3 id="AST"><a href="#AST" class="headerlink" title="AST"></a>AST</h3><ul>
<li>parse 将 code 变成 ast</li>
<li>traverse: 遍历 AST 进行修改</li>
<li>generate: 把修改后的 AST 变成代码 code2</li>
</ul>
<h3 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h3><ul>
<li>babel 可以把高级代码翻译为 ES5</li>
<li>@babel/parser</li>
<li>@babel/traverse</li>
<li>@babel/generator</li>
<li>@babel/core 包含前三者</li>
<li>@babel/preset-env 内置很多规则</li>
</ul>
<h3 id="循环依赖"><a href="#循环依赖" class="headerlink" title="循环依赖"></a>循环依赖</h3><ul>
<li>有的循环依赖可以正常执行</li>
<li>有的循环依赖不可以</li>
<li>但都可以做静态分析</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2021/02/27/Webpack-01AST-Babel-依赖/" data-id="cknvgpu9f01000xjpj01fa7gm" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Webpack/">Webpack</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Webpack-00前置内容理解webpack" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/02/26/Webpack-00前置内容理解webpack/" class="article-date">
  <time datetime="2021-02-26T05:22:51.000Z" itemprop="datePublished">2021-02-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/02/26/Webpack-00前置内容理解webpack/">Webpack-00前置内容理解webpack</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="理解-Webpack-实现流程"><a href="#理解-Webpack-实现流程" class="headerlink" title="理解 Webpack 实现流程"></a>理解 Webpack 实现流程</h1><ul>
<li><a href="https://github.com/slTrust/webpack-easy" target="_blank" rel="noopener">仓库</a></li>
</ul>
<h2 id="理解node-模块化"><a href="#理解node-模块化" class="headerlink" title="理解node 模块化"></a>理解node 模块化</h2><p>src目录有 如下内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">//name.js</span><br><span class="line">let name = &apos;my name is xxx&apos;</span><br><span class="line">exports.name = name</span><br><span class="line"></span><br><span class="line">// action.js</span><br><span class="line">let action = &apos;make webpack&apos;</span><br><span class="line">exports.action = action</span><br><span class="line"></span><br><span class="line">// index.js</span><br><span class="line">let action = require(&apos;./action.js&apos;).action</span><br><span class="line">let name = require(&apos;./name.js&apos;).name</span><br><span class="line">let msg = `$&#123;name&#125; is $&#123;action&#125;`</span><br><span class="line">console.log(msg)</span><br></pre></td></tr></table></figure>
<ul>
<li>如果你学过模块化，or用过 require.js</li>
<li>意思是每个文件代表一个模块，当一个文件(index.js)需要另一个文件内容的时候（name.js） ，我们可以 <code>require(&#39;./name.js&#39;)</code></li>
<li>require得到的东西，就是这个模块文件如name.js 里 <code>exports</code>对象</li>
<li>可以通过 require 拿到一个模块里的东西，同时可以用 exports 把模块需要暴露出的东西 暴露出去</li>
<li><p>require/exports 就实现了模块化</p>
<ul>
<li>好处是：代码更加清晰，修改模块的时候更加的方便</li>
</ul>
</li>
<li><p>运行 <code>node src/index.js</code> 得到执行</p>
</li>
</ul>
<h3 id="怎么就能执行了？"><a href="#怎么就能执行了？" class="headerlink" title="怎么就能执行了？"></a>怎么就能执行了？</h3><ul>
<li>因为我们使用的是 node环境，而node环境内部天生支持模块化，使用的是 commonJS规范</li>
</ul>
<h3 id="如何支持浏览器？"><a href="#如何支持浏览器？" class="headerlink" title="如何支持浏览器？"></a>如何支持浏览器？</h3><ul>
<li>不可以直接引入 index.js ，因为浏览器没有 require/exports 这些东西</li>
<li>你需要对源码进行处理</li>
<li>使用“一些工具”对代码进行处理加工变成一个文件，放到dist里 浏览器引入 dist里的js </li>
<li>这个工具就是 webpack</li>
</ul>
<h2 id="实现思路"><a href="#实现思路" class="headerlink" title="实现思路"></a>实现思路</h2><ul>
<li>浏览器是不认识 require/exports 的</li>
</ul>
<h3 id="step01先套壳（此时代码是无法运行的）"><a href="#step01先套壳（此时代码是无法运行的）" class="headerlink" title="step01先套壳（此时代码是无法运行的）"></a>step01先套壳（此时代码是无法运行的）</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">// index.js</span><br><span class="line">function (require, exports, module) &#123;</span><br><span class="line">  let action = require(&apos;./action.js&apos;).action</span><br><span class="line">  let name = require(&apos;./name.js&apos;).name</span><br><span class="line">  let msg = `$&#123;name&#125; is $&#123;action&#125;`</span><br><span class="line">  console.log(msg)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// action.js</span><br><span class="line">function (require, exports, module) &#123;</span><br><span class="line">  let action = &apos;make webpack&apos;</span><br><span class="line">  exports.action = action</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// name.js</span><br><span class="line">function (require, exports, module) &#123;</span><br><span class="line">  let name = &apos;my name is xxx&apos;</span><br><span class="line">  exports.name = name</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="step02-模块有一个模块id，放入到一个对象里modules（命名空间）"><a href="#step02-模块有一个模块id，放入到一个对象里modules（命名空间）" class="headerlink" title="step02 模块有一个模块id，放入到一个对象里modules（命名空间）"></a>step02 模块有一个模块id，放入到一个对象里modules（命名空间）</h3><ul>
<li>如下代码还无法运行</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">modules = &#123;</span><br><span class="line">  // index.js</span><br><span class="line">  0: function (require, exports) &#123;</span><br><span class="line">    let action = require(&apos;./action.js&apos;).action</span><br><span class="line">    let name = require(&apos;./name.js&apos;).name</span><br><span class="line">    let msg = `$&#123;name&#125; is $&#123;action&#125;`</span><br><span class="line">    console.log(msg)</span><br><span class="line">  &#125;,</span><br><span class="line">  // action.js</span><br><span class="line">  1: function (require, exports) &#123;</span><br><span class="line">    let action = &apos;make webpack&apos;</span><br><span class="line">    exports.action = action</span><br><span class="line">  &#125;,</span><br><span class="line">  // name.js</span><br><span class="line">  2: function (require, exports) &#123;</span><br><span class="line">    let name = &apos;my name is xxx&apos;</span><br><span class="line">    exports.name = name</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 所有的模块归拢到一处</span><br><span class="line">// 用一个 modules 收集</span><br><span class="line">// 过程就是，我们又一个工具 比如叫做 webpack,把我们的代码变成如下内容，然后把每个modules挨个执行一下</span><br><span class="line"></span><br><span class="line">// 执行模块返回结果</span><br><span class="line">function exec(id) &#123;</span><br><span class="line">  let fn = modules[id]</span><br><span class="line">  let exports = &#123;&#125;</span><br><span class="line">  fn(require, exports)</span><br><span class="line"></span><br><span class="line">  // 浏览器不是 node环境，所以没有 require，我们需要创造一个require</span><br><span class="line">  function require(path) &#123;</span><br><span class="line">    // 根据模块的路径，返回执行的结果</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 模块0 是我们的入口文件</span><br><span class="line">exec(0)</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>浏览器不是node环境没有require</strong></li>
<li><strong>浏览器不是node环境没有require</strong></li>
<li><strong>浏览器不是node环境没有require</strong></li>
<li>所以webpack的作用是把模块化的js处理成一个文件如 bundle.js 在浏览器执行</li>
</ul>
<h3 id="COMMONJS规范写源码的时候"><a href="#COMMONJS规范写源码的时候" class="headerlink" title="COMMONJS规范写源码的时候"></a>COMMONJS规范写源码的时候</h3><ul>
<li>必须用 require(‘xx.js’) 去加载一个模块</li>
<li>就是去执行这个模块，拿到这个模块里的 exports 对象</li>
<li>同时模块希望被别人用的时候，我们需要在 exports 绑定东西</li>
</ul>
<h3 id="step03改变modules的数据格式"><a href="#step03改变modules的数据格式" class="headerlink" title="step03改变modules的数据格式"></a>step03改变modules的数据格式</h3><ul>
<li>资源映射和启动入口</li>
<li>代码可以在 “node环境/浏览器”执行</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">modules = &#123;</span><br><span class="line">  // index.js</span><br><span class="line">  0: [</span><br><span class="line">    function (require, exports) &#123;</span><br><span class="line">      let action = require(&apos;./action.js&apos;).action</span><br><span class="line">      let name = require(&apos;./name.js&apos;).name</span><br><span class="line">      let msg = `$&#123;name&#125; is $&#123;action&#125;`</span><br><span class="line">      console.log(msg)</span><br><span class="line">    &#125;,</span><br><span class="line">    // 依赖的模块 路径和 id的映射</span><br><span class="line">    &#123;</span><br><span class="line">      &apos;./action.js&apos;: 1,</span><br><span class="line">      &apos;./name.js&apos;: 2</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  // action.js</span><br><span class="line">  1: [</span><br><span class="line">    function (require, exports) &#123;</span><br><span class="line">      let action = &apos;make webpack&apos;</span><br><span class="line">      exports.action = action</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;&#125;</span><br><span class="line">  ],</span><br><span class="line">  // name.js</span><br><span class="line">  2: [</span><br><span class="line">    function (require, exports) &#123;</span><br><span class="line">      let name = &apos;my name is xxx&apos;</span><br><span class="line">      exports.name = name</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;&#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 所有的模块归拢到一处</span><br><span class="line">// 用一个 modules 收集</span><br><span class="line">// 过程就是，我们又一个工具 比如叫做 webpack,把我们的代码变成如下内容，然后把每个modules挨个执行一下</span><br><span class="line"></span><br><span class="line">// 执行模块返回结果</span><br><span class="line">function exec(id) &#123;</span><br><span class="line">  /*</span><br><span class="line">  mapping 形如</span><br><span class="line">  &#123;</span><br><span class="line">    &apos;./action.js&apos;: 1,</span><br><span class="line">    &apos;./name.js&apos;: 2</span><br><span class="line">  &#125;</span><br><span class="line">  */</span><br><span class="line">  let [fn, mapping] = modules[id]</span><br><span class="line">  let exports = &#123;&#125;</span><br><span class="line">  fn &amp;&amp; fn(require, exports)</span><br><span class="line"></span><br><span class="line">  // 浏览器不是 node环境，所以没有 require，我们需要创造一个require</span><br><span class="line">  function require(path) &#123;</span><br><span class="line">    // 根据模块的路径，返回执行的结果</span><br><span class="line">    return exec(mapping[path])</span><br><span class="line">  &#125;</span><br><span class="line">  return exports</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 模块0 是我们的入口文件</span><br><span class="line">exec(0)</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2021/02/26/Webpack-00前置内容理解webpack/" data-id="cknvgpu9d00zx0xjpj1emjg8y" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Webpack/">Webpack</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Node-web05-09-03博客系统使用nginx" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/02/23/Node-web05-09-03博客系统使用nginx/" class="article-date">
  <time datetime="2021-02-23T03:53:11.000Z" itemprop="datePublished">2021-02-23</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/02/23/Node-web05-09-03博客系统使用nginx/">Node-web05-09-03博客系统使用nginx</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <ul>
<li><a href="https://github.com/slTrust/next-demo-2" target="_blank" rel="noopener">代码仓库</a></li>
</ul>
<h2 id="基于上一篇你构建好的情况下，不然不用看了"><a href="#基于上一篇你构建好的情况下，不然不用看了" class="headerlink" title="基于上一篇你构建好的情况下，不然不用看了"></a>基于上一篇你构建好的情况下，不然不用看了</h2><h3 id="Nginx咋用"><a href="#Nginx咋用" class="headerlink" title="Nginx咋用"></a>Nginx咋用</h3><ul>
<li>google <a href="https://hub.docker.com/_/nginx" target="_blank" rel="noopener">docker nginx</a></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 看见一个模版命令</span><br><span class="line">docker run --name some-nginx -v /some/content:/usr/share/nginx/html:ro -d nginx</span><br><span class="line"></span><br><span class="line"># --name给容器起个名字</span><br><span class="line"># -v 挂载的内容</span><br><span class="line"># -d 持久的运行 </span><br><span class="line"># --network=host 容器共享阿里云的端口</span><br></pre></td></tr></table></figure>
<h4 id="CRM之-改改试一下"><a href="#CRM之-改改试一下" class="headerlink" title="CRM之 改改试一下"></a>CRM之 改改试一下</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ssh blog@dev1</span><br><span class="line">docker run --name nginx1 --network=host -d nginx:1.19.1</span><br><span class="line"></span><br><span class="line"># 去安全组开放 80端口</span><br><span class="line">浏览器访问你的 ip 即可</span><br></pre></td></tr></table></figure>
<h4 id="nginx配置"><a href="#nginx配置" class="headerlink" title="nginx配置"></a>nginx配置</h4><ul>
<li><p>最全版<a href="https://www.nginx.com/resources/wiki/start/topics/examples/full/" target="_blank" rel="noopener">参考</a></p>
</li>
<li><p>在 <code>~/nginx.conf</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">  # ip v4</span><br><span class="line">  listen  80;</span><br><span class="line">  listen [::]:80;</span><br><span class="line">  server_name localhost;</span><br><span class="line"></span><br><span class="line">  # 所有的流量导入如下地方</span><br><span class="line">  location / &#123;</span><br><span class="line">    # 反向代理，流量导入这里</span><br><span class="line">    proxy_pass http://0.0.0.0:3000;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="再次启动-nginx"><a href="#再次启动-nginx" class="headerlink" title="再次启动 nginx"></a>再次启动 nginx</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker run --name nginx1 --network=host -v ~/nginx.conf:/etc/nginx/conf.d/default.conf -d nginx:1.19.1</span><br><span class="line"></span><br><span class="line">此时浏览器访问 你的 ip 即可</span><br><span class="line"># 安全组关闭 3000端口</span><br><span class="line"># 开放 80端口</span><br></pre></td></tr></table></figure>
<h3 id="让next-js的静态文件-不走next-js-而是通过-nginx转发"><a href="#让next-js的静态文件-不走next-js-而是通过-nginx转发" class="headerlink" title="让next.js的静态文件 不走next.js 而是通过 nginx转发"></a>让next.js的静态文件 不走next.js 而是通过 nginx转发</h3><ul>
<li>比如一个资源<code>http://8.130.54.208/_next/static/css/5e2b15b35c6f85e72313.css</code><ul>
<li>流量走向 next.js的进程</li>
</ul>
</li>
<li>我们希望通过 nginx 把静态文件资源转发到 静态服务器</li>
<li>修改配置</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">  # ip v4</span><br><span class="line">  listen  80;</span><br><span class="line">  listen [::]:80;</span><br><span class="line">  server_name localhost;</span><br><span class="line"></span><br><span class="line">  # 将静态文件转发到静态服务器</span><br><span class="line">  location ~ ^/_next/static/ &#123;</span><br><span class="line">    root /usr/share/nginx/html/;</span><br><span class="line">    expires 30d;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  # 所有的流量导入如下地方</span><br><span class="line">  location / &#123;</span><br><span class="line">    # 反向代理，流量导入这里</span><br><span class="line">    proxy_pass http://0.0.0.0:3000;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>修改启动nginx 命令</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 静态文件也需要挂载目录</span><br><span class="line">docker run --name nginx1 --network=host -v ~/nginx.conf:/etc/nginx/conf.d/default.conf -v ~/app/.next/static/:/usr/share/nginx/html/_next/static -d nginx:1.19.1</span><br></pre></td></tr></table></figure>
<h3 id="开启-gzip"><a href="#开启-gzip" class="headerlink" title="开启 gzip"></a>开启 gzip</h3><ul>
<li>直接 只添加一句 <code>gzip on;</code> 是不生效的</li>
<li><p>于是搜索 <a href="https://serverfault.com/questions/915928/gzip-not-working-on-nginx/923787" target="_blank" rel="noopener">gzip not working on nginx</a></p>
</li>
<li><p>继续修改 nginx.conf</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">  # ip v4</span><br><span class="line">  listen  80;</span><br><span class="line">  listen [::]:80;</span><br><span class="line">  server_name localhost;</span><br><span class="line">  gzip on;</span><br><span class="line">  gzip_disable &quot;msie6&quot;;</span><br><span class="line"></span><br><span class="line">  gzip_comp_level 6;</span><br><span class="line">  gzip_min_length 1100;</span><br><span class="line">  gzip_buffers 16 8k;</span><br><span class="line">  gzip_proxied any;</span><br><span class="line">  gzip_types</span><br><span class="line">      text/plain</span><br><span class="line">      text/css</span><br><span class="line">      text/js</span><br><span class="line">      text/xml</span><br><span class="line">      text/javascript</span><br><span class="line">      application/javascript</span><br><span class="line">      application/x-javascript</span><br><span class="line">      application/json</span><br><span class="line">      application/xml</span><br><span class="line">      application/rss+xml</span><br><span class="line">      image/svg+xml/javascript;</span><br><span class="line"></span><br><span class="line">  # 将静态文件转发到静态服务器</span><br><span class="line">  location ~ ^/_next/static/ &#123;</span><br><span class="line">    root /usr/share/nginx/html/;</span><br><span class="line">    expires 30d;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  # 所有的流量导入如下地方</span><br><span class="line">  location / &#123;</span><br><span class="line">    # 反向代理，流量导入这里</span><br><span class="line">    proxy_pass http://0.0.0.0:3000;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>再次运行容器</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --name nginx1 --network=host -v ~/nginx.conf:/etc/nginx/conf.d/default.conf -v ~/app/.next/static/:/usr/share/nginx/html/_next/static -d nginx:1.19.1</span><br></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><h3 id="nginx的好处"><a href="#nginx的好处" class="headerlink" title="nginx的好处"></a>nginx的好处</h3><h4 id="静态文静访问更快"><a href="#静态文静访问更快" class="headerlink" title="静态文静访问更快"></a>静态文静访问更快</h4><ul>
<li>动静分离</li>
<li>静态资源可以直接到文件系统，好处是 nginx访问静态文件比 nodejs访问快</li>
<li>node需要读文件流</li>
<li>nginx专业做这个的</li>
<li>还可以添加 gzip</li>
</ul>
<h4 id="反向代理"><a href="#反向代理" class="headerlink" title="反向代理"></a>反向代理</h4><ul>
<li>你可以在不同机器上有多个node程序，通过 nginx 转发<ul>
<li>当你业务大了，可以水平扩展</li>
</ul>
</li>
<li>负载均衡</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2021/02/23/Node-web05-09-03博客系统使用nginx/" data-id="cknvgptyt00b80xjphmnceaa1" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/NodeWeb/">NodeWeb</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Node-web05-09-02博客系统部署最新版流程" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/02/22/Node-web05-09-02博客系统部署最新版流程/" class="article-date">
  <time datetime="2021-02-22T15:17:28.000Z" itemprop="datePublished">2021-02-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/02/22/Node-web05-09-02博客系统部署最新版流程/">Node-web05-09-02博客系统部署最新版流程</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <ul>
<li><p><a href="https://github.com/slTrust/next-demo-2" target="_blank" rel="noopener">代码仓库</a></p>
<h1 id="一切从零开始"><a href="#一切从零开始" class="headerlink" title="一切从零开始"></a>一切从零开始</h1></li>
<li><p>按照 <a href="https://sltrust.github.io/2021/02/19/Node-web05-07-02服务器相关配置及使用/" target="_blank" rel="noopener">Node-web05-07-02服务器相关配置及使用</a> 的流程全部配置好</p>
</li>
<li>按照 <a href="https://sltrust.github.io/2021/02/19/Node-web05-07-02服务器相关配置及使用/" target="_blank" rel="noopener">Node-web05-07-02服务器相关配置及使用</a> 的流程全部配置好</li>
<li>按照 <a href="https://sltrust.github.io/2021/02/19/Node-web05-07-02服务器相关配置及使用/" target="_blank" rel="noopener">Node-web05-07-02服务器相关配置及使用</a> 的流程全部配置好</li>
</ul>
<h2 id="前置条件"><a href="#前置条件" class="headerlink" title="前置条件"></a>前置条件</h2><ul>
<li>充值110元 购买阿里云按量付费机器</li>
<li>安装好 docker</li>
<li>安装好 node</li>
<li>配置好阿里云服务器的 root以及非root用户的 ssh 登陆</li>
<li>配置好 非root用户 如 blog 用户的 docker执行权限</li>
<li>配置好 git ssh key 用来<code>clone / pull</code>代码</li>
</ul>
<h3 id="登录服务器"><a href="#登录服务器" class="headerlink" title="登录服务器"></a>登录服务器</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh blog@dev1</span><br></pre></td></tr></table></figure>
<h3 id="设置环境变量"><a href="#设置环境变量" class="headerlink" title="设置环境变量"></a>设置环境变量</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">vi ~/.bashrc</span><br><span class="line"># 插入一句，后保存</span><br><span class="line">export NODE_ENV=production</span><br><span class="line"></span><br><span class="line"># 让这个变动生效</span><br><span class="line">source ~/.bashrc</span><br><span class="line"># 验证</span><br><span class="line">echo $NODE_ENV</span><br></pre></td></tr></table></figure>
<h3 id="PG的一些设置"><a href="#PG的一些设置" class="headerlink" title="PG的一些设置"></a>PG的一些设置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># 创建数据库持久化目录</span><br><span class="line">mkdir ~/blog-data</span><br><span class="line"></span><br><span class="line"># 这里注意这个 --name my-pg-app 后面会用到,非常重要</span><br><span class="line">docker run --name my-pg-app -v ~/blog-data:/var/lib/postgresql/data --network=host -e POSTGRES_USER=blog -e POSTGRES_HOST_AUTH_METHOD=trust -d postgres:12.2</span><br><span class="line"></span><br><span class="line"># 通过id or appname(--name 指定的名字)进入</span><br><span class="line"># docker exec -it &lt;id|appname&gt; bash</span><br><span class="line"># 创建数据库,这里通过这个 [my-pg-app] 进入数据库内部 ,你也可通过 容器id</span><br><span class="line"># 通过应用名进入</span><br><span class="line">docker exec -it my-pg-app bash</span><br><span class="line"></span><br><span class="line"># 登录数据库</span><br><span class="line">psql -U blog</span><br><span class="line"></span><br><span class="line"># 如果是服务器 生产环境你就这样</span><br><span class="line">CREATE DATABASE blog_production ENCODING &apos;UTF8&apos; LC_COLLATE &apos;en_US.utf8&apos; LC_CTYPE &apos;en_US.utf8&apos;;</span><br><span class="line"></span><br><span class="line"># 如果是本地你就这样</span><br><span class="line">CREATE DATABASE blog_development ENCODING &apos;UTF8&apos; LC_COLLATE &apos;en_US.utf8&apos; LC_CTYPE &apos;en_US.utf8&apos;;</span><br></pre></td></tr></table></figure>
<h3 id="拉代码"><a href="#拉代码" class="headerlink" title="拉代码"></a>拉代码</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cd ~/</span><br><span class="line">mkdir app</span><br><span class="line">cd app</span><br><span class="line"></span><br><span class="line"># 拉代码，前提你配置好 github的ssh key</span><br><span class="line">git clone git@github.com:slTrust/next-demo-2.git .</span><br></pre></td></tr></table></figure>
<h4 id="数据库配置"><a href="#数据库配置" class="headerlink" title="数据库配置"></a>数据库配置</h4><ul>
<li><p>参考 <code>~/app/ormconfig.sample.json</code> 建立 production 环境的 config</p>
</li>
<li><p>在服务器 <code>~/shared/ormconfig.json</code>这样建立文件</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">cd ~/</span><br><span class="line">mkdir shared</span><br><span class="line">vi ormconfig.json</span><br><span class="line"></span><br><span class="line"># 内容如下,根据你的 pg设置自行设置</span><br><span class="line">&#123;</span><br><span class="line">  &quot;type&quot;: &quot;postgres&quot;,</span><br><span class="line">  &quot;host&quot;: &quot;localhost&quot;,</span><br><span class="line">  &quot;port&quot;: 5432,</span><br><span class="line">  &quot;username&quot;: &quot;blog&quot;,</span><br><span class="line">  &quot;password&quot;: &quot;&quot;,</span><br><span class="line">  &quot;database&quot;: &quot;blog_production&quot;,</span><br><span class="line">  &quot;synchronize&quot;: false,</span><br><span class="line">  &quot;logging&quot;: false,</span><br><span class="line">  &quot;entities&quot;: [</span><br><span class="line">    &quot;dist/entity/**/*.js&quot;</span><br><span class="line">  ],</span><br><span class="line">  &quot;migrations&quot;: [</span><br><span class="line">    &quot;dist/migration/**/*.js&quot;</span><br><span class="line">  ],</span><br><span class="line">  &quot;subscribers&quot;: [</span><br><span class="line">    &quot;dist/subscriber/**/*.js&quot;</span><br><span class="line">  ],</span><br><span class="line">  &quot;cli&quot;: &#123;</span><br><span class="line">    &quot;entitiesDir&quot;: &quot;src/entity&quot;,</span><br><span class="line">    &quot;migrationsDir&quot;: &quot;src/migration&quot;,</span><br><span class="line">    &quot;subscribersDir&quot;: &quot;src/subscriber&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>建立软链接（非常重要）</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 注意要在项目根目录</span><br><span class="line">cd ~/app</span><br><span class="line">ln -s ~/shared/ormconfig.json</span><br></pre></td></tr></table></figure>
<h4 id="加密密钥配置"><a href="#加密密钥配置" class="headerlink" title="加密密钥配置"></a>加密密钥配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd ~/app</span><br><span class="line">touch .env.local</span><br><span class="line"></span><br><span class="line"># 内容如下</span><br><span class="line">SECRET=c2a85490-cc60-4f21-94e8-8dc5dd3220da</span><br></pre></td></tr></table></figure>
<h3 id="deploy-sh"><a href="#deploy-sh" class="headerlink" title="deploy.sh"></a>deploy.sh</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">echo &apos;前置准备完成了，启动pg&apos;;</span><br><span class="line">docker restart my-pg-app &amp;&amp;</span><br><span class="line"># 推荐这样，因为用户名不一定都叫 blog</span><br><span class="line">cd ~/app/ &amp;&amp;</span><br><span class="line">git pull &amp;&amp;</span><br><span class="line">yarn install --production=false &amp;&amp;</span><br><span class="line">yarn build &amp;&amp;</span><br><span class="line"># 修改补丁, src/entity/User.ts 的补丁</span><br><span class="line">git apply migrate.patch;</span><br><span class="line"># 编译src/migration ,让typeorm 的ts变成 js</span><br><span class="line">yarn compile &amp;&amp;</span><br><span class="line"># 数据库迁移,创建表</span><br><span class="line">yarn m:run &amp;&amp;</span><br><span class="line"># 撤销 patch内容</span><br><span class="line">git reset --hard HEAD &amp;&amp;</span><br><span class="line"># 防止同名应用存在</span><br><span class="line">docker kill my-next-app;</span><br><span class="line">docker rm -f my-next-app;</span><br><span class="line">docker rmi -f hjx/node-web-app;</span><br><span class="line"># docker构建应用</span><br><span class="line">docker build -t hjx/node-web-app . &amp;&amp;</span><br><span class="line">docker run --name my-next-app  --network=host -d hjx/node-web-app &amp;&amp;</span><br><span class="line">echo &apos;OK!&apos;</span><br></pre></td></tr></table></figure>
<h3 id="docker-p-参数端口映射一个重要知识点"><a href="#docker-p-参数端口映射一个重要知识点" class="headerlink" title="docker -p 参数端口映射一个重要知识点"></a>docker <code>-p</code> 参数端口映射一个重要知识点</h3><ul>
<li>docker 容器内的localhost 不是你机器的localhost</li>
</ul>
<h3 id="docker-network-host"><a href="#docker-network-host" class="headerlink" title="docker --network=host"></a>docker <code>--network=host</code></h3><ul>
<li>意思是 你服务器的 localhost:端口 对应你的容器开放的端口</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 当访问你机器的 3000 时映射到对应容器的 3000端口</span><br><span class="line">docker run --name my-next-app  -p 3000:3000 -d hjx/node-web-app</span><br><span class="line"></span><br><span class="line"># 不再指定 -p 参数</span><br><span class="line">docker run --name my-next-app  --network=host -d hjx/node-web-app</span><br></pre></td></tr></table></figure>
<h3 id="一键部署"><a href="#一键部署" class="headerlink" title="一键部署"></a>一键部署</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 前置准备工作</span><br><span class="line">ssh blog@dev1</span><br><span class="line"># clone 我的最新代码</span><br><span class="line"># 分配执行权限</span><br><span class="line">chmod +x ~/app/bin/deploy.sh</span><br><span class="line"></span><br><span class="line"># 以后每次改了代码 push之后你就可以这样</span><br><span class="line">ssh blog@dev1 &apos;sh ~/app/bin/deploy.sh&apos;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2021/02/22/Node-web05-09-02博客系统部署最新版流程/" data-id="cknvgptyp00av0xjpseo0cuen" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/NodeWeb/">NodeWeb</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Node-web05-09-01博客统部署2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/02/20/Node-web05-09-01博客统部署2/" class="article-date">
  <time datetime="2021-02-20T00:56:37.000Z" itemprop="datePublished">2021-02-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/02/20/Node-web05-09-01博客统部署2/">Node-web05-09-01博客统部署优化解释</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="上次部署的服务器"><a href="#上次部署的服务器" class="headerlink" title="上次部署的服务器"></a>上次部署的服务器</h3><blockquote>
<p>我们在服务器修改了部分文件，如果直接 <code>git pull</code> 就会有问题</p>
</blockquote>
<h3 id="git-通灵术使用"><a href="#git-通灵术使用" class="headerlink" title="git 通灵术使用"></a>git 通灵术使用</h3><ul>
<li><code>git status</code> 查看修改的文件状态</li>
<li>假如我们服务器的代码 修改了 xx.txt 内容，拉取的时候不想冲突</li>
<li>你就 <code>git stash</code> 把它存入一个地方</li>
<li><code>git status</code> 状态就是空的了</li>
<li>然后 <code>git pull</code> 下载最新代码</li>
<li>恢复刚才藏起来的代码 <code>git stash pop</code></li>
</ul>
<h2 id="设置环境变量导致的bug"><a href="#设置环境变量导致的bug" class="headerlink" title="设置环境变量导致的bug"></a>设置环境变量导致的bug</h2><ul>
<li>我们设置了 <code>export NODE_ENV=production</code> </li>
<li>这样 <code>yarn install</code> 的时候 dev依赖就会被忽略</li>
<li>解决办法是 </li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn install --production=false</span><br></pre></td></tr></table></figure>
<h2 id="在服务器执行本地脚本"><a href="#在服务器执行本地脚本" class="headerlink" title="在服务器执行本地脚本"></a>在服务器执行本地脚本</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ssh blog@dev1 &quot;echo hi &gt; /tmp/xxx&quot;</span><br><span class="line"></span><br><span class="line"># 你会发现你服务器上的 多了`/tmp/xxx` 文件 内容是 hi</span><br><span class="line"></span><br><span class="line"># 项目里声明一个 deploy.sh</span><br><span class="line"># 本地的脚本在服务器端执行</span><br><span class="line">ssh blog@dev1 &quot;bash -s &lt; bin/deploy.sh&quot;</span><br></pre></td></tr></table></figure>
<h2 id="解决json配置两个环境不一致问题"><a href="#解决json配置两个环境不一致问题" class="headerlink" title="解决json配置两个环境不一致问题"></a>解决json配置两个环境不一致问题</h2><ul>
<li>由于json不能改，所以这是一个痛点，因为本地和 生产环境 的配置“不一致”</li>
<li>复制 <code>ormconfig.json</code> 内容到<code>ormconfig.sample.json</code> </li>
<li>然后 <code>.gitignore</code>里 忽略<code>ormconfig.json</code> </li>
</ul>
<h2 id="解决配置文件要在git-pull-之后修改的问题"><a href="#解决配置文件要在git-pull-之后修改的问题" class="headerlink" title="解决配置文件要在git pull 之后修改的问题"></a>解决配置文件要在git pull 之后修改的问题</h2><ul>
<li>在服务器 <code>~/shared/ormconfig.json</code>这样建立文件</li>
<li>然后在你的项目里 通过“软链接” 来分离配置和项目代码</li>
<li>项目目录里运行<code>ln -s ~/shared/ormconfig.json</code><ul>
<li>这样你服务器环境的配置文件是 软链接的文件</li>
<li>你本地开发可以自己参考 <code>ormconfig.sample.json</code> 建立dev的配置<code>ormconfig.json</code></li>
<li>这样两边就不一致了</li>
</ul>
</li>
</ul>
<h2 id="补丁包使用"><a href="#补丁包使用" class="headerlink" title="补丁包使用"></a>补丁包使用</h2><ul>
<li>我们的 <code>src/entity/User.ts</code> 里有数据库validate操作 <code>yarn m:run</code> 数据库迁移时会报错</li>
<li>所以服务器和本地的时候，我们都要把对应操作注释掉执行 <code>yarn m:run</code>迁移数据库，然后在把注释恢复</li>
<li>这样就非常的 ”蛋疼“</li>
</ul>
<h3 id="git-create-patch-from-diff"><a href="#git-create-patch-from-diff" class="headerlink" title="git create patch from diff"></a><a href="https://stackoverflow.com/questions/28192623/create-patch-or-diff-file-from-git-repository-and-apply-it-to-another-different" target="_blank" rel="noopener">git create patch from diff</a></h3><ul>
<li>step01 假如数据库迁移的时候需要的xxx.js文件内容是</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">aaa</span><br><span class="line">// bbb</span><br><span class="line">ccc</span><br></pre></td></tr></table></figure>
<ul>
<li>step02 而数据库迁移之后，我们xxx.js 的内容是这样</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">aaa</span><br><span class="line">bbb</span><br><span class="line">ccc</span><br></pre></td></tr></table></figure>
<ul>
<li>step03 将git diff的内容 完整拷贝到 migrate.patch 文件里</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git diff &gt; migrate.patch</span><br></pre></td></tr></table></figure>
<ul>
<li>step04 然后取消掉 migration 要做的文件改动,即 xxx.js内容为</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">aaa</span><br><span class="line">bbb</span><br><span class="line">ccc</span><br></pre></td></tr></table></figure>
<ul>
<li>step05 运行补丁，</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">git apply migrate.patch</span><br><span class="line"></span><br><span class="line"># 运行后 xxx.js 内容为</span><br><span class="line">aaa</span><br><span class="line">//bbb</span><br><span class="line">ccc</span><br></pre></td></tr></table></figure>
<ul>
<li>step06 撤销操作<code>git reset --hard HEAD</code></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2021/02/20/Node-web05-09-01博客统部署2/" data-id="cknvgptyr00b00xjpmevrc6ll" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/NodeWeb/">NodeWeb</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Node-web05-08博客统页面完善" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/02/20/Node-web05-08博客统页面完善/" class="article-date">
  <time datetime="2021-02-20T00:53:01.000Z" itemprop="datePublished">2021-02-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/02/20/Node-web05-08博客统页面完善/">Node-web05-08博客统页面完善</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="博客页面美化"><a href="#博客页面美化" class="headerlink" title="博客页面美化"></a>博客页面美化</h1><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><ul>
<li><a href="https://github.com/slTrust/next-demo-2/commit/bbc97ab4fc6adf3b93b136bcfeb0ad409c9711e4" target="_blank" rel="noopener">初始代码</a></li>
<li><a href="https://github.com/slTrust/next-demo-2/commit/976df467766effca361157778e1e22dbbde87a06" target="_blank" rel="noopener">最终代码</a></li>
</ul>
<h3 id="完善功能点"><a href="#完善功能点" class="headerlink" title="完善功能点"></a>完善功能点</h3><ul>
<li>首页/列表页/新增文章/编辑文章 CSS</li>
<li>posts 的修改</li>
<li>posts 的删除</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2021/02/20/Node-web05-08博客统页面完善/" data-id="cknvgptyp00aw0xjp04knalca" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/NodeWeb/">NodeWeb</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Node-web05-07-03服务器端构建" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/02/19/Node-web05-07-03服务器端构建/" class="article-date">
  <time datetime="2021-02-19T06:12:09.000Z" itemprop="datePublished">2021-02-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/02/19/Node-web05-07-03服务器端构建/">Node-web05-07-03服务器端构建</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="克隆代码"><a href="#克隆代码" class="headerlink" title="克隆代码"></a>克隆代码</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># blog用户登录</span><br><span class="line">ssh blog@dev1</span><br><span class="line"></span><br><span class="line"># 进入服务器home目录</span><br><span class="line">cd ~/</span><br><span class="line"># 再次 clone代码</span><br><span class="line">git clone git@github.com:slTrust/next-demo-2.git</span><br><span class="line"># 进入项目根目录</span><br><span class="line">cd next-demo-2</span><br><span class="line"></span><br><span class="line"># 切换到我那个时候的代码，以保证同步</span><br><span class="line">git checkout bbc97ab4fc6adf3b93b136bcfeb0ad409c9711e4</span><br></pre></td></tr></table></figure>
<h3 id="项目开始运行"><a href="#项目开始运行" class="headerlink" title="项目开始运行"></a>项目开始运行</h3><ul>
<li>切换用户<code>su - blog</code> 到你的项目目录 <code>cd ~/app/next-demo-2</code></li>
<li>运行 <code>yarn install</code> </li>
<li>然后 <code>yarn build</code> 结果报错了， 说缺少一个 password ，记得我们忽略的 <code>.env.local</code>吗</li>
<li>顺带把 数据库连接信息改了</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 项目根目录 </span><br><span class="line">touch .env.local</span><br><span class="line"># 内容如下，注意密钥要用你的</span><br><span class="line">SECRET=c2a85490-cc60-4f21-94e8-8dc5dd3220da</span><br><span class="line"></span><br><span class="line"># 然后修改 pg数据库的配置 vi ormconfig.json </span><br><span class="line">把host 改成你机器的 pg数据库信息</span><br><span class="line"></span><br><span class="line">&quot;host&quot;: &quot;172.17.48.128&quot;, // 你机器的ip ifconfig查看</span><br><span class="line">&quot;port&quot;: 5432, // docker 启动pg设置的端口</span><br><span class="line">&quot;username&quot;: &quot;blog&quot;, // pg用户名</span><br><span class="line">&quot;password&quot;: &quot;&quot;, //  pg密码</span><br><span class="line">&quot;database&quot;: &quot;blog_production&quot;</span><br></pre></td></tr></table></figure>
<p><strong>这也是为啥配置别用json的原因，没法改</strong><br><strong>这也是为啥配置别用json的原因，没法改</strong><br><strong>这也是为啥配置别用json的原因，没法改</strong></p>
<ul>
<li>运行<code>yarn dev</code> 然后 <code>curl -L localhost:3000</code></li>
<li>提示你 <code>QueryFailedError: relation &quot;posts&quot; does not exist</code></li>
</ul>
<h4 id="创建数据库表"><a href="#创建数据库表" class="headerlink" title="创建数据库表"></a>创建数据库表</h4><ul>
<li><code>yarn typeorm:build</code></li>
<li><code>yarn m:run</code> 报错 <code>Error: Cannot find module &#39;../../lib/getDatabaseConnection&#39;</code></li>
<li>因为 <code>src/entity/User.ts</code> 里用了  getDatabaseConnection 要把对应的语句注释</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// 13行的</span><br><span class="line">// import &#123;getDatabaseConnection&#125; from &apos;../../lib/getDatabaseConnection&apos;;</span><br><span class="line"></span><br><span class="line">// 55～59</span><br><span class="line">//const found = await (await getDatabaseConnection()).manager.find(</span><br><span class="line">    User, &#123;username: this.username&#125;);</span><br><span class="line">// if (found.length &gt; 0) &#123;</span><br><span class="line">//    this.errors.username.push(&apos;已存在，不能重复注册&apos;);</span><br><span class="line">// &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>继续 <code>yarn typeorm:build</code>然后<code>yarn m:run</code></li>
<li>此时：数据库表结构创建好了,把 <code>src/entity/User.ts</code>还原</li>
<li>运行 <code>yarn build</code> <ul>
<li>然后 <code>yarn start</code></li>
<li><code>curl -L localhost:3000</code> 此时页面有了但是没有数据</li>
</ul>
</li>
</ul>
<p><strong>不能在docker里 yarn build 里面会有很多文件，很大</strong></p>
<h4 id="docker-你的应用"><a href="#docker-你的应用" class="headerlink" title="docker 你的应用"></a>docker 你的应用</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># 进入你的项目目录</span><br><span class="line">cd ~/app/next-demo-2/</span><br><span class="line"></span><br><span class="line"># 构建应用</span><br><span class="line">docker build -t my-node-app/node-web-app . </span><br><span class="line"></span><br><span class="line">docker run -p 3000:3000 -d my-node-app/node-web-app</span><br><span class="line"></span><br><span class="line"># 访问我们的应用，里面报错，但是可以先不管</span><br><span class="line">curl -L localhost:3000</span><br><span class="line"></span><br><span class="line"># 查看占用端口</span><br><span class="line">lsof -i :3000</span><br><span class="line"># 杀掉进程</span><br><span class="line">kill pid</span><br></pre></td></tr></table></figure>
<blockquote>
<p>查看历史命令小技巧</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">history | grep &apos;docker run&apos;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>解决报错</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 查看我们应用的id</span><br><span class="line">docker ps -a </span><br><span class="line"># 看log</span><br><span class="line">docker logs id</span><br><span class="line"></span><br><span class="line"># log内容</span><br><span class="line">ready - started server on 0.0.0.0:3000, url: http://localhost:3000</span><br><span class="line">error: database &quot;blog_production&quot; does not exist</span><br><span class="line"></span><br><span class="line"># 数据库不存在，因为我们没有初始化数据库</span><br></pre></td></tr></table></figure>
<h4 id="设置环境变量，服务器是-production"><a href="#设置环境变量，服务器是-production" class="headerlink" title="设置环境变量，服务器是 production"></a>设置环境变量，服务器是 production</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># root用户 登服务器</span><br><span class="line">ssh root@dev1</span><br><span class="line"># 设置环境变量</span><br><span class="line">vi ~/.bashrc</span><br><span class="line">export NODE_ENV=production</span><br><span class="line"></span><br><span class="line"># 刷新这个文件</span><br><span class="line">source ~/.bashrc</span><br><span class="line"></span><br><span class="line"># 测试是否生效</span><br><span class="line">echo $NODE_ENV</span><br></pre></td></tr></table></figure>
<p><strong>NODE_ENV=production 后，yarn install 不会install dev的东西</strong></p>
<ul>
<li>你要这样 <code>yarn install --production=false</code></li>
</ul>
<h4 id="docker的-network-host选项"><a href="#docker的-network-host选项" class="headerlink" title="docker的--network=host选项"></a>docker的<code>--network=host</code>选项</h4><ul>
<li>让容器共享你 阿里云机器的IP，这样就可以不做端口映射</li>
<li>数据库连接不上问题<ul>
<li><strong>容器的localhost 不是你本机的 localhost</strong><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 把之前的容器都停了，然后删了  </span><br><span class="line">docker kill id</span><br><span class="line">docker rm -f id</span><br><span class="line"></span><br><span class="line"># docker重新启动 pg</span><br><span class="line">docker run --network=host -v /home/blog/blog-data:/var/lib/postgresql/data -p 5432:5432 -e POSTGRES_USER=blog -e POSTGRES_HOST_AUTH_METHOD=trust -d postgres:12.2</span><br><span class="line"></span><br><span class="line"># 重新构建next.js应用</span><br><span class="line">docker build -t my-node-app/node-web-app . </span><br><span class="line"></span><br><span class="line">docker run --network=host -p 3000:3000 -d my-node-app/node-web-app</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2021/02/19/Node-web05-07-03服务器端构建/" data-id="cknvgptyn00as0xjpetc7ug1e" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/NodeWeb/">NodeWeb</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Node-web05-07-02服务器相关配置及使用" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/02/19/Node-web05-07-02服务器相关配置及使用/" class="article-date">
  <time datetime="2021-02-19T05:12:09.000Z" itemprop="datePublished">2021-02-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/02/19/Node-web05-07-02服务器相关配置及使用/">Node-web05-07-02服务器相关配置及使用</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="阿里云机器使用"><a href="#阿里云机器使用" class="headerlink" title="阿里云机器使用"></a>阿里云机器使用</h2><h2 id="购买服务器"><a href="#购买服务器" class="headerlink" title="购买服务器"></a>购买服务器</h2><ul>
<li>登录 <a href="https://www.aliyun.com/" target="_blank" rel="noopener">https://www.aliyun.com/</a><ul>
<li>该登录登录，该注册注册，填好身份信息，充值110块，因为必须有超过100块才能买按时付费的服务器</li>
</ul>
</li>
<li>进入云服务器 ECS购买</li>
</ul>
<p><img src="https://raw.githubusercontent.com/slTrust/note/master/next-demo-deploy/deploy01.jpg" alt><br><img src="https://raw.githubusercontent.com/slTrust/note/master/next-demo-deploy/deploy02.jpg" alt><br><img src="https://raw.githubusercontent.com/slTrust/note/master/next-demo-deploy/deploy03.jpg" alt><br><img src="https://raw.githubusercontent.com/slTrust/note/master/next-demo-deploy/deploy04.jpg" alt><br><img src="https://raw.githubusercontent.com/slTrust/note/master/next-demo-deploy/deploy05.jpg" alt><br><img src="https://raw.githubusercontent.com/slTrust/note/master/next-demo-deploy/deploy06.jpg" alt></p>
<ul>
<li>然后根据提示到 管理控制台，就能看到你买的机器</li>
</ul>
<h2 id="登录你的服务器"><a href="#登录你的服务器" class="headerlink" title="登录你的服务器"></a>登录你的服务器</h2><p><img src="https://raw.githubusercontent.com/slTrust/note/master/next-demo-deploy/deploy07.jpg" alt></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 你本地命令行里</span><br><span class="line">ssh root@[你的机器公网IP]</span><br><span class="line"># 然后询问你是否连接，回答yes</span><br><span class="line">Are you sure you want to continue connecting (yes/no)? yes</span><br><span class="line"># 然后输入你的秘密即可， 就是刚刚的  123456Abc 然后回车</span><br><span class="line"># 此时不出意外登录成功</span><br></pre></td></tr></table></figure>
<h2 id="使用-ssh登录，避免用密码"><a href="#使用-ssh登录，避免用密码" class="headerlink" title="使用 ssh登录，避免用密码"></a>使用 ssh登录，避免用密码</h2><ul>
<li>如果你用过 github 那么默认应该又一个 ssh key,每台机子有一个 ssh key 就够了，所以你不用创建了<ul>
<li>如果你不知道怎么创建 ssh key ,可以参考这个<a href="https://sltrust.github.io/2017/10/05/N004_1_git%E5%85%A5%E9%97%A8/" target="_blank" rel="noopener">git入门</a></li>
</ul>
</li>
<li>上传你的ssh key<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 运行</span><br><span class="line">&gt; ssh-copy-id root@[你的IP]</span><br><span class="line"># 然后让你输入密码 123456Abc</span><br><span class="line"># 成功后</span><br><span class="line">Number of key(s) added:        1</span><br><span class="line"></span><br><span class="line"># 此后你在登录的时候就不需要密码了</span><br><span class="line">root@[你的ip]</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="root密码的安全性考虑"><a href="#root密码的安全性考虑" class="headerlink" title="root密码的安全性考虑"></a>root密码的安全性考虑</h3><ul>
<li>因为本教程里我的密码让你们知道了，这样你就可以登录我的机器了</li>
<li>于是你可能胡作非为</li>
<li>所以应该再次修改密码为一个随机数，或者你不知道的密码</li>
<li>google <a href="https://phoenixnap.com/kb/how-to-change-root-password-linux" target="_blank" rel="noopener">linux change password for root</a></li>
<li>得到答案 <code>passwd root</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 修改root用户密码，这样 你的机器就相对安全了</span><br><span class="line">passwd root</span><br></pre></td></tr></table></figure>
<h3 id="其他人如何访问你的机器"><a href="#其他人如何访问你的机器" class="headerlink" title="其他人如何访问你的机器"></a>其他人如何访问你的机器</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 第一步你先登录你的机器</span><br><span class="line"></span><br><span class="line"># 第二步 </span><br><span class="line">root@dog:~#  cd ~/.ssh</span><br><span class="line">root@dog:~/.ssh# ls</span><br><span class="line"># 这里 authorized_keys 就是所有能登录人的 public key</span><br><span class="line">authorized_keys</span><br><span class="line"># 你可以看看是啥 </span><br><span class="line">root@dog:~/.ssh# cat authorized_keys </span><br><span class="line"># 这里就是登录人的 公钥，就是你本机的 ~/.ssh/id_rsa.pub 里的内容</span><br></pre></td></tr></table></figure>
<h2 id="服务器用户不要用-root"><a href="#服务器用户不要用-root" class="headerlink" title="服务器用户不要用 root"></a>服务器用户不要用 root</h2><ul>
<li>因为root的权限太大了</li>
</ul>
<h3 id="每次记不住你的-机器ip咋办"><a href="#每次记不住你的-机器ip咋办" class="headerlink" title="每次记不住你的 机器ip咋办"></a>每次记不住你的 机器ip咋办</h3><ul>
<li><p>编辑你的 host文件</p>
<ul>
<li>windows 自己修改吧，我的是mac<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># mac,如果权限不够你就 sudo</span><br><span class="line">sudo vi /etc/hosts</span><br><span class="line"></span><br><span class="line"># 在末尾添加一行</span><br><span class="line">你的机器ip  dev1</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>此时你就可以 <code>ssh root@dev1</code> 登录，是不是非常方便</p>
</li>
</ul>
<h3 id="添加用户"><a href="#添加用户" class="headerlink" title="添加用户"></a>添加用户</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">ssh root@dev1</span><br><span class="line"></span><br><span class="line"># 添加用户</span><br><span class="line">&gt; root@dog:~# adduser blog</span><br><span class="line"></span><br><span class="line">Adding user `blog&apos; ...</span><br><span class="line">Adding new group `blog&apos; (1000) ...</span><br><span class="line">Adding new user `blog&apos; (1000) with group `blog&apos; ...</span><br><span class="line">Creating home directory `/home/blog&apos; ...</span><br><span class="line">Copying files from `/etc/skel&apos; ...</span><br><span class="line"># 输入你的密码，我这里是 123456Abc</span><br><span class="line">Enter new UNIX password: </span><br><span class="line">Retype new UNIX password: </span><br><span class="line">passwd: password updated successfully</span><br><span class="line">Changing the user information for blog</span><br><span class="line">Enter the new value, or press ENTER for the default</span><br><span class="line"># 一路回车</span><br><span class="line">	Full Name []: </span><br><span class="line">	Room Number []: </span><br><span class="line">	Work Phone []: </span><br><span class="line">	Home Phone []: </span><br><span class="line">	Other []: </span><br><span class="line">Is the information correct? [Y/n] </span><br><span class="line"></span><br><span class="line"># 切换用户 </span><br><span class="line">root@dog:~# su - blog</span><br><span class="line">blog@dog:~$ pwd</span><br><span class="line"># 我们所有文件都应该在这儿</span><br><span class="line">/home/blog</span><br><span class="line"></span><br><span class="line"># 使用 blog用户 登录,然后输入你刚才设置的密码</span><br><span class="line">ssh blog@dev1</span><br><span class="line"># 这样 blog 就只能在它的辖区内操作，就很安全</span><br><span class="line"></span><br><span class="line"># 解决 blog用户登录输 密码问题，</span><br><span class="line">ssh-copy-id blog@dev1</span><br><span class="line"></span><br><span class="line"># 然后你用 blog登录 就可以这样,而且不用输入密码</span><br><span class="line">ssh blog@dev1 </span><br><span class="line"></span><br><span class="line"># 最后安全起见，修改 blog的密码，这样就安全了</span><br></pre></td></tr></table></figure>
<h2 id="root安装docker"><a href="#root安装docker" class="headerlink" title="root安装docker"></a>root安装docker</h2><ul>
<li><a href="https://docs.docker.com/engine/install/ubuntu/" target="_blank" rel="noopener">ubuntu 18 install docker</a></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"># step01 卸载旧版 docker</span><br><span class="line">sudo apt-get remove docker docker-engine docker.io containerd runc</span><br><span class="line"></span><br><span class="line"># step02 更新源</span><br><span class="line">sudo apt-get update</span><br><span class="line"></span><br><span class="line"># step03 按照提示 运行</span><br><span class="line">sudo apt-get install \</span><br><span class="line">    apt-transport-https \</span><br><span class="line">    ca-certificates \</span><br><span class="line">    curl \</span><br><span class="line">    gnupg-agent \</span><br><span class="line">    software-properties-common</span><br><span class="line"></span><br><span class="line"># step04 Add Docker’s official GPG key:</span><br><span class="line">curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -</span><br><span class="line"></span><br><span class="line"># step05 </span><br><span class="line">sudo apt-key fingerprint 0EBFCD88</span><br><span class="line"></span><br><span class="line"># step06</span><br><span class="line">sudo add-apt-repository \</span><br><span class="line">   &quot;deb [arch=amd64] https://download.docker.com/linux/ubuntu \</span><br><span class="line">   $(lsb_release -cs) \</span><br><span class="line">   stable&quot;</span><br><span class="line"></span><br><span class="line"># step07</span><br><span class="line">sudo apt-get update</span><br><span class="line"></span><br><span class="line"># step08</span><br><span class="line">sudo apt-get install docker-ce docker-ce-cli containerd.io</span><br></pre></td></tr></table></figure>
<h3 id="安装限定版本的-docker"><a href="#安装限定版本的-docker" class="headerlink" title="安装限定版本的 docker"></a>安装限定版本的 docker</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># 查看列表</span><br><span class="line">apt-cache madison docker-ce</span><br><span class="line"></span><br><span class="line"># 安装限定版本</span><br><span class="line">sudo apt-get install docker-ce=&lt;VERSION_STRING&gt; docker-ce-cli=&lt;VERSION_STRING&gt; containerd.io</span><br><span class="line"></span><br><span class="line"># 我这里是版本是 </span><br><span class="line">docker-ce (5:20.10.3~3-0~ubuntu-bionic)</span><br><span class="line">docker-ce-cli (5:20.10.3~3-0~ubuntu-bionic)</span><br><span class="line">containerd.io (1.4.3-1) </span><br><span class="line"></span><br><span class="line"># 所以为了以后跟我同步，你应该这样</span><br><span class="line">sudo apt-get install docker-ce=5:20.10.3~3-0~ubuntu-bionic docker-ce-cli=5:20.10.3~3-0~ubuntu-bionic containerd.io=1.4.3-1</span><br><span class="line"></span><br><span class="line"># 测试 docker ,运行它的例子</span><br><span class="line">docker run hello-world</span><br></pre></td></tr></table></figure>
<h3 id="docker设置镜像源头-不设置后面会卡在这"><a href="#docker设置镜像源头-不设置后面会卡在这" class="headerlink" title="docker设置镜像源头[不设置后面会卡在这]"></a>docker设置镜像源头[不设置后面会卡在这]</h3><ul>
<li>参考 <a href="https://www.huaweicloud.com/articles/d425989c5f83b798c4f5078f7c99bf3a.html" target="_blank" rel="noopener">Ubuntu Linux下修改docker镜像源</a></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 登录服务器</span><br><span class="line">ssh root@dev1 </span><br><span class="line"></span><br><span class="line"># 新建文件 /etc/docker/daemon.json</span><br><span class="line"># 内容如下</span><br><span class="line">&#123;</span><br><span class="line">  &quot;registry-mirrors&quot;: [&quot;https://y0qd3iq.mirror.aliyuncs.com&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 重启docker</span><br><span class="line">service docker restart</span><br></pre></td></tr></table></figure>
<h2 id="将blog用户加到docker分组"><a href="#将blog用户加到docker分组" class="headerlink" title="将blog用户加到docker分组"></a>将blog用户加到docker分组</h2><ul>
<li>我们是 root安装的 docker 所以其他用户没有权限的</li>
<li>将 blog 用户添加到 docker 分组</li>
<li>搜索 <a href="https://linuxize.com/post/how-to-list-groups-in-linux/" target="_blank" rel="noopener">linux list all groups</a></li>
<li>运行 查看分组名 <code>cat /etc/group</code></li>
<li>继续搜索 <a href="https://www.howtogeek.com/50787/add-a-user-to-a-group-or-second-group-on-linux/" target="_blank" rel="noopener">linux add user to group</a></li>
<li>例子 <code>usermod -a -G [组名] [用户名]</code></li>
<li>运行 <code>usermod -a -G docker blog</code></li>
</ul>
<h2 id="git拉代码"><a href="#git拉代码" class="headerlink" title="git拉代码"></a>git拉代码</h2><ul>
<li>登录 <code>ssh blog@dev1</code></li>
<li>查看有木有 git <code>which git</code></li>
<li>有就行，然后拉代码</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"># blog用户登录，默认在你的 home目录</span><br><span class="line">blog@dog:~$ pwd</span><br><span class="line">/home/blog</span><br><span class="line"></span><br><span class="line"># 创建我们放代码的地方，进入这个目录</span><br><span class="line">mkdir app</span><br><span class="line">cd app</span><br><span class="line"></span><br><span class="line"># 拷贝代码，你会发现失败了，因为我们用的 ssh 方式</span><br><span class="line">git clone git@github.com:slTrust/next-demo-2.git</span><br><span class="line"></span><br><span class="line"># 你需要添加ssh key 才行</span><br><span class="line">- 参考这个 https://sltrust.github.io/2017/10/05/N004_1_git%E5%85%A5%E9%97%A8/</span><br><span class="line"># 具体操作如下</span><br><span class="line">ssh-keygen -t rsa -b 4096 -C “你的邮箱”</span><br><span class="line"># 一路回车</span><br><span class="line"># 复制公钥信息</span><br><span class="line">cat ~/.ssh/id_rsa.pub </span><br><span class="line"></span><br><span class="line"># 把上面的内容 在 github 里 add key</span><br><span class="line"></span><br><span class="line"># 再次 clone代码</span><br><span class="line">git clone git@github.com:slTrust/next-demo-2.git</span><br><span class="line"># 代码拉取成功～</span><br></pre></td></tr></table></figure>
<h4 id="启动数据库：因为我们一会要连接"><a href="#启动数据库：因为我们一会要连接" class="headerlink" title="启动数据库：因为我们一会要连接"></a>启动数据库：因为我们一会要连接</h4><ul>
<li>接续上面的内容</li>
<li>启动 pg<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># blog用户登录</span><br><span class="line">cd ~/</span><br><span class="line"># 创建 pg数据持久化目录</span><br><span class="line">mkdir blog-data</span><br><span class="line"></span><br><span class="line"># 运行命令</span><br><span class="line">docker run -v /home/blog/blog-data:/var/lib/postgresql/data -p 5432:5432 -e POSTGRES_USER=blog -e POSTGRES_HOST_AUTH_METHOD=trust -d postgres:12.2</span><br><span class="line"></span><br><span class="line"># 创建数据库</span><br><span class="line"></span><br><span class="line"># 创建数据库命令模版</span><br><span class="line">CREATE DATABASE [数据库名] ENCODING &apos;UTF8&apos; LC_COLLATE &apos;en_US.utf8&apos; LC_CTYPE &apos;en_US.utf8&apos;;</span><br><span class="line"></span><br><span class="line"># 进入数据库 </span><br><span class="line">docker exec -it id bash</span><br><span class="line"># 登录数据库</span><br><span class="line">psql -U blog -W</span><br><span class="line"># 创建我们需要的数据库，注意是生产环境的 “blog_production”</span><br><span class="line"></span><br><span class="line">CREATE DATABASE blog_production ENCODING &apos;UTF8&apos; LC_COLLATE &apos;en_US.utf8&apos; LC_CTYPE &apos;en_US.utf8&apos;;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="项目运行准备工作"><a href="#项目运行准备工作" class="headerlink" title="项目运行准备工作"></a>项目运行准备工作</h3><h4 id="服务器上-yarn-build，所以需要安装node-安装node12"><a href="#服务器上-yarn-build，所以需要安装node-安装node12" class="headerlink" title="服务器上 yarn build，所以需要安装node:安装node12"></a>服务器上 yarn build，所以需要安装node:安装node12</h4><ul>
<li>root用户登录 <code>ssh root@dev1</code> </li>
<li>安装 node / yarn</li>
<li>google <a href="https://nodejs.org/en/download/package-manager/" target="_blank" rel="noopener">ubuntu install nodejs</a></li>
<li><a href="https://github.com/nodesource/distributions/blob/master/README.md" target="_blank" rel="noopener">https://github.com/nodesource/distributions/blob/master/README.md</a></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"># Using Ubuntu</span><br><span class="line">curl -fsSL https://deb.nodesource.com/setup_12.x | sudo -E bash -</span><br><span class="line">sudo apt-get install -y nodejs</span><br><span class="line"></span><br><span class="line"># 根据提示 安装c++ / yarn</span><br><span class="line">sudo apt-get install gcc g++ make</span><br><span class="line"></span><br><span class="line">curl -sL https://dl.yarnpkg.com/debian/pubkey.gpg | sudo apt-key add -</span><br><span class="line"></span><br><span class="line">echo &quot;deb https://dl.yarnpkg.com/debian/ stable main&quot; | sudo tee /etc/apt/sources.list.d/yarn.list</span><br><span class="line"></span><br><span class="line">sudo apt-get update &amp;&amp; sudo apt-get install yarn</span><br><span class="line"># 注意为了和我一致，尽量保持 yarn的版本 是 1.22.xx版</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">yarn config get registry</span><br><span class="line"># 淘宝</span><br><span class="line">yarn config set registry https://registry.npm.taobao.org</span><br><span class="line"># 还原</span><br><span class="line">yarn config set registry https://registry.yarnpkg.com</span><br><span class="line"></span><br><span class="line"># yarn设置镜像 参考</span><br><span class="line">https://www.cnblogs.com/momozjm/p/10635941.html</span><br></pre></td></tr></table></figure>
<h3 id="服务器安全组设置"><a href="#服务器安全组设置" class="headerlink" title="服务器安全组设置"></a>服务器安全组设置</h3><ul>
<li>让我们的自己的电脑能访问它</li>
<li>找到对应机器，安全组开放3000端口</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2021/02/19/Node-web05-07-02服务器相关配置及使用/" data-id="cknvgptyl00ao0xjpe82l0hmz" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/NodeWeb/">NodeWeb</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/55/">55</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/CSS/">CSS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ES6速学/">ES6速学</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JS不知深浅/">JS不知深浅</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/M01/">M01</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/M02/">M02</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/M03/">M03</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/M04/">M04</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/M06/">M06</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/M07/">M07</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/M08/">M08</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/M09/">M09</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NodeWeb/">NodeWeb</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Node后端/">Node后端</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ReactWheels/">ReactWheels</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/React入门/">React入门</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TS入门/">TS入门</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Webpack/">Webpack</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/express/">express</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/fullstack/">fullstack</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/http/">http</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jQuery/">jQuery</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/">java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mobile/">mobile</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mongodb/">mongodb</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/">mysql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/node/">node</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/node每日精进/">node每日精进</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/oak/">oak</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tools/">tools</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vim/">vim</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vue/">vue</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vultr/">vultr</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web性能优化/">web性能优化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web面经/">web面经</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/前端知识点/">前端知识点</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/CSS/" style="font-size: 13.91px;">CSS</a> <a href="/tags/ES6速学/" style="font-size: 14.35px;">ES6速学</a> <a href="/tags/JS不知深浅/" style="font-size: 11.3px;">JS不知深浅</a> <a href="/tags/M01/" style="font-size: 13.48px;">M01</a> <a href="/tags/M02/" style="font-size: 15.22px;">M02</a> <a href="/tags/M03/" style="font-size: 15.65px;">M03</a> <a href="/tags/M04/" style="font-size: 16.09px;">M04</a> <a href="/tags/M06/" style="font-size: 18.26px;">M06</a> <a href="/tags/M07/" style="font-size: 17.83px;">M07</a> <a href="/tags/M08/" style="font-size: 16.96px;">M08</a> <a href="/tags/M09/" style="font-size: 11.74px;">M09</a> <a href="/tags/NodeWeb/" style="font-size: 15.65px;">NodeWeb</a> <a href="/tags/Node后端/" style="font-size: 18.7px;">Node后端</a> <a href="/tags/ReactWheels/" style="font-size: 16.52px;">ReactWheels</a> <a href="/tags/React入门/" style="font-size: 15.22px;">React入门</a> <a href="/tags/TS入门/" style="font-size: 14.78px;">TS入门</a> <a href="/tags/Webpack/" style="font-size: 11.3px;">Webpack</a> <a href="/tags/express/" style="font-size: 10.43px;">express</a> <a href="/tags/fullstack/" style="font-size: 17.83px;">fullstack</a> <a href="/tags/http/" style="font-size: 12.17px;">http</a> <a href="/tags/jQuery/" style="font-size: 10px;">jQuery</a> <a href="/tags/java/" style="font-size: 19.13px;">java</a> <a href="/tags/linux/" style="font-size: 10.87px;">linux</a> <a href="/tags/mobile/" style="font-size: 11.3px;">mobile</a> <a href="/tags/mongodb/" style="font-size: 12.61px;">mongodb</a> <a href="/tags/mysql/" style="font-size: 12.61px;">mysql</a> <a href="/tags/node/" style="font-size: 10.43px;">node</a> <a href="/tags/node每日精进/" style="font-size: 10px;">node每日精进</a> <a href="/tags/oak/" style="font-size: 20px;">oak</a> <a href="/tags/python/" style="font-size: 17.39px;">python</a> <a href="/tags/tools/" style="font-size: 10px;">tools</a> <a href="/tags/vim/" style="font-size: 10px;">vim</a> <a href="/tags/vue/" style="font-size: 13.04px;">vue</a> <a href="/tags/vultr/" style="font-size: 10px;">vultr</a> <a href="/tags/web性能优化/" style="font-size: 10px;">web性能优化</a> <a href="/tags/web面经/" style="font-size: 10px;">web面经</a> <a href="/tags/前端知识点/" style="font-size: 19.57px;">前端知识点</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">February 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">October 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/02/28/Webpack-03loader/">Webpack-03loader</a>
          </li>
        
          <li>
            <a href="/2021/02/27/Webpack-02打包器/">Webpack-02打包器</a>
          </li>
        
          <li>
            <a href="/2021/02/27/Webpack-01AST-Babel-依赖/">Webpack-01AST_Babel_依赖</a>
          </li>
        
          <li>
            <a href="/2021/02/26/Webpack-00前置内容理解webpack/">Webpack-00前置内容理解webpack</a>
          </li>
        
          <li>
            <a href="/2021/02/23/Node-web05-09-03博客系统使用nginx/">Node-web05-09-03博客系统使用nginx</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2021 Stevin<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>